<!--üíó PulseHER Master Blueprint (v10.0)-->
<!--purpose: Research-grade clinical women's health platform with cycle-aware PPG analytics-->
<!--Complete system: camera PPG ‚Üí HR/HRV extraction ‚Üí adaptive indices (ABI,CVR,CSI) ‚Üí explainable flags-->
<!--Privacy-first, research-ready with clinical validation and export capabilities-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üíó PulseHER v12.0 - FIREBASE DATABASE + TIMELINE ‚úÖÔøΩ - Clinical Women's Health Platform</title>
    <!-- SUPER STRONG CACHE BUSTING -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="cache-control" content="no-cache">
    <!-- üîÑ FORCE REFRESH TIMESTAMP: 2025-01-13-22:45-FIREBASE-DATABASE-TIMELINE-COMPLETE ‚úÖüî•ÔøΩ -->
    <link rel="preload" href="data:," as="style" onload="this.rel='stylesheet'">
    <!-- Chart.js for Master Blueprint v10.0 Time-Series Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    
    <!-- Suppress blocking alert() popups and route messages to the on-page status box -->
    <script>
        // Replace native alert with a non-blocking handler that writes into #heartRateStatus
        (function() {
            const originalAlert = window.alert;
            window.alert = function(msg) {
                try {
                    console.log('Suppressed alert:', msg);
                    const status = document.getElementById('heartRateStatus');
                    if (status) {
                        status.textContent = String(msg);
                        status.style.color = '#d32f2f';
                        status.style.background = 'rgba(244,67,54,0.08)';
                    }
                } catch (e) {
                    // If DOM not ready, fallback to console
                    console.log('Suppressed alert (fallback):', msg);
                }
                // Keep originalAlert available for debugging in console if needed:
                // originalAlert(msg);
            };
        })();
    </script>
    <!-- üî• Firebase SDK for PPG Data Storage -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, deleteDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js';
        
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyCXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
            authDomain: "pulseher-app.firebaseapp.com",
            projectId: "pulseher-app",
            storageBucket: "pulseher-app.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnop"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = db;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseGetDoc = getDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseDoc = doc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseOnSnapshot = onSnapshot;
        
        console.log('üî• Firebase initialized successfully for PPG data storage!');
        
        // Auto-load stored data when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.loadStoredPPGData) {
                    window.loadStoredPPGData();
                }
            }, 2000);
        });
    </script>
    <style>
        /* FRESH PINK STYLES - VERSION 2.0 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Performance optimizations */
        .app-container {
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        .card, .nav-item, .cta-button {
            will-change: transform;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* OPTIMIZED PASTEL PINK GRADIENT */
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 50%, #fff0f5 100%);
            min-height: 100vh;
            color: #4a2c4a;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Header with PINK theme */
        .header {
            background: linear-gradient(90deg, 
                rgba(252,228,236,0.95) 0%, 
                rgba(248,187,217,0.95) 50%, 
                rgba(255,240,245,0.95) 100%);
            backdrop-filter: blur(15px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 25px rgba(255,105,180,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid rgba(255,105,180,0.5);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, #c2185b, #e91e63, #f06292);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(248,187,217,0.5);
        }
        
        .menu-toggle {
            background: linear-gradient(45deg, #f48fb1, #f8bbd9);
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(248,187,217,0.5);
        }
        
        /* Navigation Menu with PINK */
        .nav-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            height: 100vh;
            background: linear-gradient(180deg, 
                rgba(252,228,236,0.98) 0%, 
                rgba(248,187,217,0.98) 50%, 
                rgba(255,240,245,0.98) 100%);
            backdrop-filter: blur(15px);
            padding: 80px 30px 30px;
            transition: left 0.3s ease;
            z-index: 200;
            box-shadow: 2px 0 25px rgba(255,105,180,0.4);
        }
        
        .nav-menu.open {
            left: 0;
        }
        
        .nav-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #d63384, #e91e63);
            border: none;
            font-size: 1.8rem;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(214,51,132,0.4);
        }
        
        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .nav-link {
            color: #2d1b2e;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 15px;
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,105,180,0.3);
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .nav-link:hover, .nav-link.active {
            background: linear-gradient(45deg, #ff69b4, #f093fb);
            color: white;
            transform: translateX(10px);
            box-shadow: 0 4px 15px rgba(255,105,180,0.4);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .screen {
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Welcome Screen - SUPER PINK */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #f06292, #e91e63, #f48fb1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        
        .welcome-subtitle {
            font-size: 1.2rem;
            color: #2d1b2e;
            margin-bottom: 40px;
            background: rgba(255,255,255,0.8);
            padding: 15px;
            border-radius: 20px;
            border: 2px solid rgba(255,105,180,0.3);
        }
        
        .heart-animation {
            font-size: 4rem;
            color: #f48fb1;
            margin: 30px 0;
            animation: heartbeat 3s ease-in-out infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .cta-button {
            background: linear-gradient(45deg, #f48fb1, #f8bbd9, #e1bee7);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(248,187,217,0.5);
            margin: 10px;
        }
        
        .cta-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255,105,180,0.6);
        }
        
        /* Bottom Navigation - PINK */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, 
                rgba(255,105,180,0.95) 0%, 
                rgba(240,147,251,0.95) 50%, 
                rgba(255,192,203,0.95) 100%);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 2px solid rgba(255,105,180,0.5);
            box-shadow: 0 -4px 20px rgba(255,105,180,0.3);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #2d1b2e;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
            min-width: 60px;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            color: #d63384;
        }
        
        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 4px rgba(255,105,180,0.3));
        }
        
        .nav-label {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Cards with PINK theme */
        .card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 6px 25px rgba(255,105,180,0.2);
            border: 2px solid rgba(255,105,180,0.3);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255,105,180,0.3);
        }
        
        /* Input fields with PINK theme */
        .form-group {
            margin: 15px 0;
        }
        
        .form-label {
            display: block;
            color: #2d1b2e;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,105,180,0.4);
            border-radius: 12px;
            background: rgba(255,255,255,0.8);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #ff69b4;
            box-shadow: 0 0 15px rgba(255,105,180,0.3);
            background: white;
        }
        
        /* Survey specific styles */
        .survey-step {
            animation: fadeIn 0.3s ease-in;
        }
        
        .survey-step h3 {
            border-bottom: 2px solid rgba(233,30,99,0.2);
            padding-bottom: 8px;
        }
        
        .survey-step input[type="checkbox"], 
        .survey-step input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }
        
        .survey-step label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            color: #4a2c4a;
        }
        
        .survey-step textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard specific styles */
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .dashboard-title {
            font-size: 2rem;
            background: linear-gradient(45deg, #d63384, #e91e63, #ff1744);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, 
                rgba(255,105,180,0.8) 0%, 
                rgba(240,147,251,0.8) 100%);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(255,105,180,0.3);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* KPI Card Styles */
        .kpi-card {
            background: white;
            border: 2px solid rgba(248,187,217,0.3);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(248,187,217,0.2);
            transition: all 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(248,187,217,0.4);
            border-color: #F8BBD9;
        }
        
        .kpi-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .kpi-icon {
            font-size: 1.5rem;
        }
        
        .kpi-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a2c4a;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            color: #E91E63;
            margin-bottom: 8px;
        }
        
        .kpi-unit {
            font-size: 0.8rem;
            font-weight: normal;
            color: #666;
        }
        
        .kpi-change {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .kpi-change.positive {
            color: #4CAF50;
        }
        
        .kpi-change.negative {
            color: #F44336;
        }
        
        .kpi-range {
            font-size: 0.75rem;
            color: #666;
        }
        
        /* Time Range Selector */
        .time-range-selector select {
            background: rgba(248,187,217,0.1);
            border: 1px solid rgba(248,187,217,0.4);
            border-radius: 8px;
            color: #4a2c4a;
        }
        
        .time-range-selector select:focus {
            border-color: #E91E63;
            box-shadow: 0 0 5px rgba(233,30,99,0.3);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Extra pink elements */
        .pink-accent {
            color: #ff69b4 !important;
        }
        
        .pink-bg {
            background: linear-gradient(45deg, #ff69b4, #f093fb) !important;
        }
        
        .pink-border {
            border: 2px solid #ff69b4 !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">üíñ PulseHER</div>
            <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        </header>
        
        <!-- Navigation Menu -->
        <nav class="nav-menu" id="navMenu">
            <button class="nav-close" onclick="toggleMenu()">‚úï</button>
            <div class="nav-links">
                <a href="#" class="nav-link active" onclick="event.preventDefault(); showScreen('welcome'); return false;">üè† Home</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); showScreen('onboarding'); return false;">üëã Get Started</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); showScreen('dashboard'); return false;">üìä Dashboard</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); showScreen('ppg'); return false;">üíì PPG Recording</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); showScreen('results'); return false;">üìä Results</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); showScreen('insights'); return false;">üß† AI Insights</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); showScreen('cycle-analytics'); return false;">üìà Cycle Analytics</a>
                <a href="#" class="nav-link" onclick="event.preventDefault(); showScreen('recommendations'); return false;">üí° Recommendations</a>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <div id="welcome" class="screen active welcome-screen">
                <h1 class="welcome-title">PulseHER</h1>
                <p class="welcome-subtitle">üå∏ Your Heart Health, Your Way üå∏<br>Empowering women with AI-driven insights for cardiovascular wellness</p>
                
                <div class="heart-animation">üíñ</div>
                
                <button class="cta-button" onclick="event.preventDefault(); showScreen('onboarding'); return false;">
                    üöÄ Start Your Journey
                </button>
                <button class="cta-button" onclick="event.preventDefault(); showScreen('dashboard'); return false;">
                    üìä View Dashboard
                </button>
                
                <div class="card">
                    <h3 class="pink-accent">üåü Features</h3>
                    <ul style="text-align: left; margin-top: 15px;">
                        <li style="margin: 10px 0; color: #2d1b2e;">üíï Real-time heart rate monitoring</li>
                        <li style="margin: 10px 0; color: #2d1b2e;">üîÑ Menstrual cycle integration</li>
                        <li style="margin: 10px 0; color: #2d1b2e;">ü§ñ AI-powered health insights</li>
                        <li style="margin: 10px 0; color: #2d1b2e;">üì± Personalized recommendations</li>
                    </ul>
                </div>
            </div>
            
            <!-- Master Blueprint v10.0 Onboarding -->
            <div id="onboarding" class="screen">
                <div class="card">
                    <h2 class="pink-accent">üíó Welcome to PulseHER</h2>
                    <p style="margin: 15px 0; font-size: 0.9rem; line-height: 1.4;">
                        <strong>Complete Your Health Profile</strong><br>
                        This information helps us provide personalized, research-grade health insights tailored to your unique physiology.
                    </p>
                    
                    <!-- Status message area for onboarding -->
                    <div id="onboardingStatus" style="display: none; text-align: center; margin: 15px 0; padding: 12px; border-radius: 15px; font-weight: bold;"></div>

                    <!-- Progress indicator -->
                    <div style="display: flex; justify-content: space-between; margin: 20px 0; font-size: 0.8rem;">
                        <span id="surveyStep1" style="color: #E91E63; font-weight: bold;">1. Account</span>
                        <span id="surveyStep2" style="color: #999;">2. Demographics</span>
                        <span id="surveyStep3" style="color: #999;">3. Medical</span>
                        <span id="surveyStep4" style="color: #999;">4. Lifestyle</span>
                        <span id="surveyStep5" style="color: #999;">5. Hormonal</span>
                        <span id="surveyStep6" style="color: #999;">6. Privacy</span>
                    </div>
                    
                    <!-- Step 1: Account Creation -->
                    <div id="step1" class="survey-step">
                        <h3 style="color: #E91E63; margin: 20px 0 15px 0;">üìß Account Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="userEmail" class="form-input" placeholder="your.email@domain.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="userPassword" class="form-input" placeholder="Create secure password" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm your password" required>
                        </div>
                    </div>
                    
                    <!-- Step 2: Demographics -->
                    <div id="step2" class="survey-step" style="display: none;">
                        <h3 style="color: #E91E63; margin: 20px 0 15px 0;">üë§ Demographics</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="number" id="userAge" class="form-input" placeholder="Your age" min="13" max="100" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Height (cm)</label>
                            <input type="number" id="userHeight" class="form-input" placeholder="170" min="120" max="220">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Weight (kg)</label>
                            <input type="number" id="userWeight" class="form-input" placeholder="65" min="30" max="200">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Sex at Birth</label>
                            <select id="sexAtBirth" class="form-input" required>
                                <option value="">Select...</option>
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                                <option value="intersex">Intersex</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Gender Identity (Optional)</label>
                            <select id="genderIdentity" class="form-input">
                                <option value="">Prefer not to answer</option>
                                <option value="woman">Woman</option>
                                <option value="man">Man</option>
                                <option value="non-binary">Non-binary</option>
                                <option value="genderfluid">Genderfluid</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Step 3: Medical History -->
                    <div id="step3" class="survey-step" style="display: none;">
                        <h3 style="color: #E91E63; margin: 20px 0 15px 0;">üè• Medical History</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Medical Conditions (Check all that apply)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0;">
                                <label><input type="checkbox" id="diabetes"> Diabetes</label>
                                <label><input type="checkbox" id="hypertension"> Hypertension</label>
                                <label><input type="checkbox" id="heartDisease"> Heart Disease</label>
                                <label><input type="checkbox" id="thyroid"> Thyroid Disorder</label>
                                <label><input type="checkbox" id="pcos"> PCOS</label>
                                <label><input type="checkbox" id="endometriosis"> Endometriosis</label>
                                <label><input type="checkbox" id="anxiety"> Anxiety</label>
                                <label><input type="checkbox" id="depression"> Depression</label>
                                <label><input type="checkbox" id="migraines"> Migraines</label>
                                <label><input type="checkbox" id="asthma"> Asthma</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Other Medical Conditions</label>
                            <textarea id="otherConditions" class="form-input" placeholder="Please describe any other medical conditions..." rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Current Medications</label>
                            <div style="background: rgba(255,193,7,0.1); padding: 10px; border-radius: 5px; margin: 5px 0;">
                                <strong>‚ö†Ô∏è Important medications for heart rate analysis:</strong>
                            </div>
                            <div style="margin: 10px 0;">
                                <label><input type="checkbox" id="betaBlockers"> <strong>Beta-blockers</strong> (e.g., propranolol, metoprolol)</label><br>
                                <label><input type="checkbox" id="contraceptives"> <strong>Hormonal contraceptives</strong> (pill, patch, ring, IUD)</label><br>
                                <label><input type="checkbox" id="ssris"> <strong>SSRIs/Antidepressants</strong> (e.g., sertraline, fluoxetine)</label><br>
                                <label><input type="checkbox" id="thyroidMeds"> Thyroid medications</label><br>
                                <label><input type="checkbox" id="stimulants"> Stimulants (ADHD medication, etc.)</label>
                            </div>
                            <textarea id="otherMedications" class="form-input" placeholder="List any other medications..." rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Family History</label>
                            <div style="margin: 8px 0;">
                                <label>
                                    <strong>Coronary Artery Disease (CAD):</strong>
                                    <select id="familyCAD" class="form-input" style="width: auto; margin-left: 10px;">
                                        <option value="">Select</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                        <option value="unknown">Unknown</option>
                                    </select>
                                </label><br><br>
                                <label>
                                    <strong>Stroke:</strong>
                                    <select id="familyStroke" class="form-input" style="width: auto; margin-left: 10px;">
                                        <option value="">Select</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                        <option value="unknown">Unknown</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 4: Lifestyle -->
                    <div id="step4" class="survey-step" style="display: none;">
                        <h3 style="color: #E91E63; margin: 20px 0 15px 0;">üèÉ‚Äç‚ôÄÔ∏è Lifestyle</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Average Sleep Hours per Night</label>
                            <select id="sleepHours" class="form-input">
                                <option value="">Select</option>
                                <option value="<5">Less than 5 hours</option>
                                <option value="5-6">5-6 hours</option>
                                <option value="7-8">7-8 hours</option>
                                <option value="9+">9+ hours</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Daily Caffeine Intake</label>
                            <select id="caffeineIntake" class="form-input">
                                <option value="">Select</option>
                                <option value="none">None</option>
                                <option value="1-cup">1 cup coffee/tea</option>
                                <option value="2-3-cups">2-3 cups</option>
                                <option value="4+-cups">4+ cups</option>
                                <option value="high">High (energy drinks, etc.)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Exercise Frequency</label>
                            <select id="exerciseFreq" class="form-input">
                                <option value="">Select</option>
                                <option value="sedentary">Sedentary (no regular exercise)</option>
                                <option value="1-2-week">1-2 times per week</option>
                                <option value="3-4-week">3-4 times per week</option>
                                <option value="5+-week">5+ times per week</option>
                                <option value="athlete">Competitive athlete</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Work Schedule</label>
                            <div style="margin: 8px 0;">
                                <label><input type="radio" name="workSchedule" value="regular"> Regular daytime hours</label><br>
                                <label><input type="radio" name="workSchedule" value="shift"> Shift work (nights/rotating)</label><br>
                                <label><input type="radio" name="workSchedule" value="irregular"> Irregular schedule</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 5: Menstrual/Hormonal Info -->
                    <div id="step5" class="survey-step" style="display: none;">
                        <h3 style="color: #E91E63; margin: 20px 0 15px 0;">üåô Menstrual & Hormonal Health</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Typical Cycle Length (days)</label>
                            <input type="number" id="cycleLength" class="form-input" placeholder="28" value="28" min="20" max="45">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Luteal Phase Length (days)</label>
                            <input type="number" id="lutealLength" class="form-input" placeholder="14" min="10" max="18">
                            <small style="color: #666;">Days between ovulation and period start</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Last Period Start Date</label>
                            <input type="date" id="lastPeriod" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Current Contraception</label>
                            <select id="contraceptionType" class="form-input">
                                <option value="">Select</option>
                                <option value="none">None</option>
                                <option value="combined-pill">Combined oral contraceptive pill</option>
                                <option value="progestin-pill">Progestin-only pill</option>
                                <option value="patch">Contraceptive patch</option>
                                <option value="ring">Vaginal ring</option>
                                <option value="hormonal-iud">Hormonal IUD</option>
                                <option value="copper-iud">Copper IUD</option>
                                <option value="implant">Contraceptive implant</option>
                                <option value="injection">Contraceptive injection</option>
                                <option value="condoms">Condoms only</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Menopause Status</label>
                            <select id="menopauseStatus" class="form-input">
                                <option value="">Select</option>
                                <option value="premenopausal">Premenopausal (regular periods)</option>
                                <option value="perimenopause">Perimenopause (irregular periods)</option>
                                <option value="postmenopausal">Postmenopausal (no periods >12 months)</option>
                                <option value="surgical">Surgical menopause</option>
                                <option value="not-applicable">Not applicable</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Step 6: Privacy Settings -->
                    <div id="step6" class="survey-step" style="display: none;">
                        <h3 style="color: #E91E63; margin: 20px 0 15px 0;">üîí Privacy & Data Sharing</h3>
                        
                        <div style="background: rgba(230,230,230,0.3); padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h4 style="color: #333;">Data Usage Preferences</h4>
                            
                            <div style="margin: 10px 0;">
                                <label>
                                    <input type="checkbox" id="researchConsent" checked>
                                    <strong>Anonymous Research Participation</strong><br>
                                    <small>Help improve women's health research with anonymized data</small>
                                </label>
                            </div>
                            
                            <div style="margin: 10px 0;">
                                <label>
                                    <input type="checkbox" id="improveAlgorithms">
                                    <strong>Algorithm Improvement</strong><br>
                                    <small>Use my data to improve HRV analysis accuracy</small>
                                </label>
                            </div>
                            
                            <div style="margin: 10px 0;">
                                <label>
                                    <input type="checkbox" id="personalizedInsights" checked>
                                    <strong>Personalized Health Insights</strong><br>
                                    <small>Receive tailored recommendations based on your data</small>
                                </label>
                            </div>
                            
                            <div style="margin: 10px 0;">
                                <label>
                                    <input type="checkbox" id="exportData" checked>
                                    <strong>Data Export Rights</strong><br>
                                    <small>Maintain ability to export or delete your data</small>
                                </label>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,193,7,0.1); padding: 10px; border-radius: 5px; margin: 15px 0;">
                            <p style="font-size: 0.85rem; margin: 0;">
                                <strong>üõ°Ô∏è Your Privacy Matters:</strong> All health data is encrypted, stored securely, and you maintain full control over sharing preferences. You can change these settings anytime in your account.
                            </p>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label>
                                <input type="checkbox" id="termsConsent" required>
                                I agree to the <a href="#" style="color: #E91E63;">Terms of Service</a> and <a href="#" style="color: #E91E63;">Privacy Policy</a>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div style="display: flex; justify-content: space-between; margin: 30px 0;">
                        <button id="prevBtn" class="cta-button" onclick="previousStep()" style="background: #ccc; display: none;">
                            ‚Üê Previous
                        </button>
                        <button id="nextBtn" class="cta-button" onclick="nextStep()" style="flex: 1; margin-left: 10px;">
                            Next ‚Üí
                        </button>
                        <button id="submitBtn" class="cta-button" onclick="submitSurvey()" style="display: none; background: #4CAF50;">
                            üöÄ Complete Setup
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Master Blueprint v10.0: Clinical Dashboard -->
            <div id="dashboard" class="screen">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">ü©∫üíï Clinical Dashboard</h2>
                    <p style="color: #2d1b2e; font-size: 0.9rem;">Cycle-aware analytics with adaptive indices & explainable flags</p>
                </div>
                
                <!-- Master Blueprint v10.0: Enhanced Luxurious Cycle Ring -->
                <div class="card">
                    <h3 class="pink-accent">üåô Cycle Ring Visualization</h3>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <div style="position: relative; width: 280px; height: 280px;">
                            <svg width="280" height="280" style="position: absolute; top: 0; left: 0; filter: drop-shadow(0 8px 20px rgba(248,187,217,0.4));">
                                <defs>
                                    <!-- Soft Pastel Gradients for Each Phase -->
                                    <radialGradient id="menstrualGrad" cx="50%" cy="50%" r="50%">
                                        <stop offset="0%" style="stop-color:#FFB6C1;stop-opacity:0.9" />
                                        <stop offset="100%" style="stop-color:#FFC0CB;stop-opacity:0.8" />
                                    </radialGradient>
                                    
                                    <radialGradient id="follicularGrad" cx="50%" cy="50%" r="50%">
                                        <stop offset="0%" style="stop-color:#E6E6FA;stop-opacity:0.9" />
                                        <stop offset="100%" style="stop-color:#DDA0DD;stop-opacity:0.8" />
                                    </radialGradient>
                                    
                                    <radialGradient id="ovulationGrad" cx="50%" cy="50%" r="50%">
                                        <stop offset="0%" style="stop-color:#FFF8DC;stop-opacity:0.95" />
                                        <stop offset="100%" style="stop-color:#FFFACD;stop-opacity:0.85" />
                                    </radialGradient>
                                    
                                    <radialGradient id="lutealGrad" cx="50%" cy="50%" r="50%">
                                        <stop offset="0%" style="stop-color:#E0F6FF;stop-opacity:0.9" />
                                        <stop offset="100%" style="stop-color:#B0E0E6;stop-opacity:0.8" />
                                    </radialGradient>

                                    <!-- Ambient Glow Effect -->
                                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                        <feMerge> 
                                            <feMergeNode in="coloredBlur"/>
                                            <feMergeNode in="SourceGraphic"/>
                                        </feMerge>
                                    </filter>

                                    <!-- Shimmer Animation -->
                                    <linearGradient id="shimmer">
                                        <stop offset="0%" style="stop-color:rgba(255,255,255,0)"/>
                                        <stop offset="50%" style="stop-color:rgba(255,255,255,0.8)"/>
                                        <stop offset="100%" style="stop-color:rgba(255,255,255,0)"/>
                                        <animateTransform attributeName="gradientTransform"
                                            type="translate" values="-100 0;300 0;-100 0"
                                            dur="3s" repeatCount="indefinite"/>
                                    </linearGradient>
                                </defs>
                                
                                <!-- Outer Ambient Rings -->
                                <circle cx="140" cy="140" r="120" fill="none" stroke="rgba(248,187,217,0.15)" stroke-width="2" opacity="0.6">
                                    <animate attributeName="r" values="120;125;120" dur="4s" repeatCount="indefinite"/>
                                    <animate attributeName="opacity" values="0.6;0.3;0.6" dur="4s" repeatCount="indefinite"/>
                                </circle>
                                <circle cx="140" cy="140" r="125" fill="none" stroke="rgba(255,182,193,0.1)" stroke-width="1" opacity="0.4">
                                    <animate attributeName="r" values="125;130;125" dur="5s" repeatCount="indefinite"/>
                                </circle>
                                
                                <!-- Enhanced Background Ring with Gradient -->
                                <circle cx="140" cy="140" r="100" fill="none" stroke="rgba(248,187,217,0.25)" stroke-width="25" opacity="0.3"/>
                                
                                <!-- Phase Segments with Beautiful Gradients (28-day cycle) -->
                                <!-- Menstrual: Days 1-5 (18% of cycle) -->
                                <circle cx="140" cy="140" r="100" fill="none" stroke="url(#menstrualGrad)" stroke-width="25" 
                                        stroke-dasharray="113 515" stroke-dashoffset="0" filter="url(#glow)">
                                    <animate attributeName="opacity" values="0.85;1;0.85" dur="3s" repeatCount="indefinite"/>
                                </circle>
                                
                                <!-- Follicular: Days 6-13 (28.5% of cycle) -->  
                                <circle cx="140" cy="140" r="100" fill="none" stroke="url(#follicularGrad)" stroke-width="25"
                                        stroke-dasharray="179 449" stroke-dashoffset="-113" filter="url(#glow)" opacity="0.9"/>
                                
                                <!-- Ovulation: Days 14-15 (7% of cycle) - Special Glow -->
                                <circle cx="140" cy="140" r="100" fill="none" stroke="url(#ovulationGrad)" stroke-width="25"
                                        stroke-dasharray="44 584" stroke-dashoffset="-292" filter="url(#glow)">
                                    <animate attributeName="opacity" values="0.9;1;0.9" dur="2s" repeatCount="indefinite"/>
                                    <animate attributeName="stroke-width" values="25;28;25" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                
                                <!-- Luteal: Days 16-28 (46.5% of cycle) -->
                                <circle cx="140" cy="140" r="100" fill="none" stroke="url(#lutealGrad)" stroke-width="25"
                                        stroke-dasharray="292 336" stroke-dashoffset="-336" filter="url(#glow)" opacity="0.9"/>
                                
                                <!-- Shimmer Effect -->
                                <circle cx="140" cy="140" r="100" fill="none" stroke="url(#shimmer)" stroke-width="25" 
                                        stroke-dasharray="628" opacity="0.7"/>
                                
                                <!-- Enhanced Current Day Marker with Pastel Colors -->
                                <g transform="translate(240, 140)">
                                    <!-- Pulsing Glow -->
                                    <circle cx="0" cy="0" r="20" fill="rgba(255,182,193,0.25)" stroke="none">
                                        <animate attributeName="r" values="15;25;15" dur="2s" repeatCount="indefinite"/>
                                        <animate attributeName="opacity" values="0.25;0.08;0.25" dur="2s" repeatCount="indefinite"/>
                                    </circle>
                                    <!-- Main Marker -->
                                    <circle cx="0" cy="0" r="10" fill="url(#ovulationGrad)" stroke="white" stroke-width="3">
                                        <animate attributeName="r" values="10;14;10" dur="1.5s" repeatCount="indefinite"/>
                                    </circle>
                                    <!-- Inner Sparkle -->
                                    <circle cx="0" cy="0" r="4" fill="white" opacity="0.7">
                                        <animate attributeName="opacity" values="0.7;0.25;0.7" dur="1s" repeatCount="indefinite"/>
                                    </circle>
                                </g>
                                
                                <!-- Enhanced Center Information with Elegant Typography -->
                                <circle cx="140" cy="140" r="55" fill="rgba(255,255,255,0.95)" stroke="rgba(248,187,217,0.4)" stroke-width="3"
                                        filter="drop-shadow(0 4px 12px rgba(248,187,217,0.3))"/>
                                
                                <!-- Decorative Inner Ring -->
                                <circle cx="140" cy="140" r="45" fill="none" stroke="rgba(255,182,193,0.3)" stroke-width="1" stroke-dasharray="5,3"/>
                                
                                <text x="140" y="125" text-anchor="middle" font-size="24" fill="#C8A2C8" font-weight="bold" font-family="Segoe UI">Day 14</text>
                                <text x="140" y="145" text-anchor="middle" font-size="14" fill="#8B4B8C" font-family="Segoe UI" font-weight="500">Ovulation</text>
                                <text x="140" y="160" text-anchor="middle" font-size="11" fill="#B19CD9" font-family="Segoe UI">Peak Fertility</text>
                                
                                <!-- Fertility Icons -->
                                <text x="125" y="175" text-anchor="middle" font-size="10" fill="#DDA0DD">üå∏</text>
                                <text x="155" y="175" text-anchor="middle" font-size="10" fill="#DDA0DD">‚ú®</text>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Enhanced Phase Legend with Soft Pastel Gradients and Icons -->
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: linear-gradient(135deg, rgba(255,182,193,0.1), rgba(255,192,203,0.1)); border-radius: 25px; border: 1px solid rgba(255,182,193,0.25); transition: all 0.3s ease;">
                            <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #FFB6C1, #FFC0CB); border-radius: 50%; box-shadow: 0 2px 8px rgba(255,182,193,0.3);"></div>
                            <span style="font-size: 0.85rem; color: #8B4B8C; font-weight: 500;">üåä Menstrual</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: linear-gradient(135deg, rgba(230,230,250,0.1), rgba(221,160,221,0.1)); border-radius: 25px; border: 1px solid rgba(221,160,221,0.25); transition: all 0.3s ease;">
                            <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #E6E6FA, #DDA0DD); border-radius: 50%; box-shadow: 0 2px 8px rgba(221,160,221,0.3);"></div>
                            <span style="font-size: 0.85rem; color: #8B4B8C; font-weight: 500;">üå± Follicular</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: linear-gradient(135deg, rgba(255,248,220,0.12), rgba(255,250,205,0.12)); border-radius: 25px; border: 1px solid rgba(255,248,220,0.3); transition: all 0.3s ease;">
                            <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #FFF8DC, #FFFACD); border-radius: 50%; box-shadow: 0 2px 8px rgba(255,248,220,0.4);"></div>
                            <span style="font-size: 0.85rem; color: #8B4B8C; font-weight: 500;">üå∏ Ovulation</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: linear-gradient(135deg, rgba(224,246,255,0.1), rgba(176,224,230,0.1)); border-radius: 25px; border: 1px solid rgba(176,224,230,0.25); transition: all 0.3s ease;">
                            <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #E0F6FF, #B0E0E6); border-radius: 50%; box-shadow: 0 2px 8px rgba(176,224,230,0.3);"></div>
                            <span style="font-size: 0.85rem; color: #8B4B8C; font-weight: 500;">üçÇ Luteal</span>
                        </div>
                    </div>
                </div>
                
                <!-- ü©ª COMPREHENSIVE CLINICAL METRICS - MAIN DASHBOARD -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    <!-- Core HRV Metrics Row 1 -->
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashHR">--</div>
                        <div class="stat-label">ÔøΩ HR</div>
                        <div style="font-size: 0.7rem; color: #c2185b;">BPM</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashSDNN">--</div>
                        <div class="stat-label">üïë SDNN</div>
                        <div style="font-size: 0.7rem; color: #c2185b;">ms</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashRMSSD">--</div>
                        <div class="stat-label">‚ö° RMSSD</div>
                        <div style="font-size: 0.7rem; color: #c2185b;">ms</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashPNN50">--</div>
                        <div class="stat-label">ÔøΩ pNN50</div>
                        <div style="font-size: 0.7rem; color: #7b1fa2;">%</div>
                    </div>
                    
                    <!-- Frequency & Morphological Metrics Row 2 -->
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashLFHF">--</div>
                        <div class="stat-label">‚öñÔ∏è LF/HF</div>
                        <div style="font-size: 0.7rem; color: #7b1fa2;">ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashSD1">--</div>
                        <div class="stat-label">ÔøΩ SD1</div>
                        <div style="font-size: 0.7rem; color: #7b1fa2;">ms</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashPI">--</div>
                        <div class="stat-label">üíß PI</div>
                        <div style="font-size: 0.7rem; color: #ff5722;">%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashRI">--</div>
                        <div class="stat-label">üåä RI</div>
                        <div style="font-size: 0.7rem; color: #ff5722;">%</div>
                    </div>
                    
                    <!-- Additional Morphological Metrics Row 3 -->
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashSI">--</div>
                        <div class="stat-label">üßç SI</div>
                        <div style="font-size: 0.7rem; color: #ff5722;">m/s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashDI">--</div>
                        <div class="stat-label">üíé DI</div>
                        <div style="font-size: 0.7rem; color: #ff5722;">%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashSDR">--</div>
                        <div class="stat-label">‚öñÔ∏è SDR</div>
                        <div style="font-size: 0.7rem; color: #ff5722;">ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="font-size: 1.8rem;" id="dashPAV">--</div>
                        <div class="stat-label">ÔøΩÔ∏è PAV</div>
                        <div style="font-size: 0.7rem; color: #9c27b0;">%</div>
                    </div>
                </div>
                
                <!-- Master Blueprint v10.0: Time-Series Analytics - 5 Focused Charts -->
                
                <!-- Chart 1: HR (bpm) + RHR Baseline -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="pink-accent">üíì HR (bpm) + RHR Baseline</h3>
                        <div class="time-range-selector">
                            <select id="hrTimeRange" onchange="updateAllCharts()" class="form-input" style="width: auto; padding: 6px 12px; font-size: 0.85rem;">
                                <option value="today">Today</option>
                                <option value="week" selected>Past Week</option>
                                <option value="month">Past Month</option>
                                <option value="year">Past Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    
                    <p style="color: #666; font-size: 0.85rem; margin: 5px 0 10px 0;">Heart rate with resting baseline and rolling average trend</p>
                    
                    <!-- Custom date range picker (shared across all charts) -->
                    <div id="globalCustomRange" style="display: none; margin-bottom: 15px; padding: 10px; background: rgba(248,187,217,0.1); border-radius: 8px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 0.85rem; color: #4a2c4a;">From:</label>
                            <input type="date" id="globalFromDate" class="form-input" style="width: auto; padding: 5px;">
                            <label style="font-size: 0.85rem; color: #4a2c4a;">To:</label>
                            <input type="date" id="globalToDate" class="form-input" style="width: auto; padding: 5px;">
                            <button onclick="applyGlobalCustomRange()" class="cta-button" style="padding: 5px 12px; font-size: 0.8rem;">Apply to All Charts</button>
                        </div>
                    </div>
                    
                    <div style="height: 220px; margin: 15px 0;">
                        <canvas id="hrRhrChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
                
                <!-- Chart 2: RMSSD + SDNN (Short-term vs Long-term HRV) -->
                <div class="card">
                    <h3 class="pink-accent">üåä RMSSD + SDNN</h3>
                    <p style="color: #666; font-size: 0.85rem; margin: 5px 0 15px 0;">Short-term vs long-term HRV comparison</p>
                    <div style="height: 220px; margin: 15px 0;">
                        <canvas id="hrvMetricsChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
                
                <!-- Chart 3: LF/HF Ratio (Frequency Domain) -->
                <div class="card">
                    <h3 class="pink-accent">üìä LF/HF Ratio</h3>
                    <p style="color: #666; font-size: 0.85rem; margin: 5px 0 15px 0;">Frequency domain HRV analysis</p>
                    <div style="height: 220px; margin: 15px 0;">
                        <canvas id="lfhfChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
                
                <!-- Chart 4: Artifact Percentage (Signal Quality) -->
                <div class="card">
                    <h3 class="pink-accent">üéØ Signal Quality</h3>
                    <p style="color: #666; font-size: 0.85rem; margin: 5px 0 15px 0;">PPG signal artifact percentage</p>
                    <div style="height: 220px; margin: 15px 0;">
                        <canvas id="artifactChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
                
                <!-- Chart 5: Vascular Health Indices (PI, RI, SI, DI, SDR) -->
                <div class="card">
                    <h3 class="pink-accent">ü´Ä Vascular Health Indices</h3>
                    <p style="color: #666; font-size: 0.85rem; margin: 5px 0 15px 0;">Morphological pulse analysis - arterial health assessment</p>
                    <div style="height: 220px; margin: 15px 0;">
                        <canvas id="vascularIndicesChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; text-align: center;">
                        PI: Perfusion Index | RI: Reflection Index | SI: Stiffness Index | DI: Dicrotic Index | SDR: Systolic-Diastolic Ratio | PAV: Pulse Amplitude Variation
                    </div>
                </div>

                <!-- Chart 6: Pulse Amplitude Variation (PAV) & Clinical Status -->
                <div class="card">
                    <h3 class="pink-accent">ÔøΩ Clinical Status Dashboard</h3>
                    <p style="color: #666; font-size: 0.85rem; margin: 5px 0 15px 0;">Real-time clinical assessment and alerts</p>
                    <div style="height: 220px; margin: 15px 0;">
                        <canvas id="clinicalStatusChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; text-align: center;">
                        PAV: Pulse Amplitude Variation | Clinical thresholds monitoring
                    </div>
                </div>
                
                <!-- Real-time Clinical Alerts -->
                <div class="card">
                    <h3 class="pink-accent">üö® Real-time Clinical Alerts</h3>
                    <div id="clinicalAlertsContainer" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="padding: 8px; background: rgba(156,156,156,0.1); border-left: 4px solid #999; border-radius: 4px;">
                            <div style="font-weight: bold; color: #666; font-size: 0.85rem;">‚è≥ Waiting for PPG Data</div>
                            <div style="font-size: 0.75rem; color: #4a4a4a;">Start PPG scanning to enable real-time clinical monitoring</div>
                        </div>
                    </div>
                </div>
                
                <!-- üî• PPG DATA STORAGE TIMELINE -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="pink-accent">üóÑÔ∏è PPG Data Timeline</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="loadStoredPPGData()" class="cta-button" style="padding: 5px 12px; font-size: 0.8rem; background: linear-gradient(45deg, #4CAF50, #81C784);">
                                üîÑ Refresh
                            </button>
                            <button onclick="clearAllPPGData()" class="cta-button" style="padding: 5px 12px; font-size: 0.8rem; background: linear-gradient(45deg, #f44336, #ef5350);">
                                üóëÔ∏è Clear All
                            </button>
                        </div>
                    </div>
                    
                    <div id="ppgDataTimeline" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            <div style="font-size: 1.2rem; margin-bottom: 8px;">üìä</div>
                            <div>Loading stored PPG measurements...</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px; text-align: center;">
                        Click on any measurement to view details or delete. Data is automatically saved to Firebase.
                    </div>
                </div>
            </div>
            
            <!-- Master Blueprint: Immediate Results Screen -->
            <div id="results" class="screen">
                <div class="card">
                    <h2 class="pink-accent">üìä Your PPG Results</h2>
                    <p style="text-align: center; margin: 15px 0; font-size: 0.9rem;">
                        Session completed! Here are your heart health metrics:
                    </p>
                    
                    <!-- Core HRV Metrics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 25px 0;">
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultHR" class="stat-value" style="font-size: 2.2rem; color: #c2185b;">-</div>
                            <div class="stat-label">üíì Heart Rate</div>
                            <div style="font-size: 0.7rem; color: #666;">BPM</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultRMSSD" class="stat-value" style="font-size: 2.2rem; color: #c2185b;">-</div>
                            <div class="stat-label">üåä RMSSD</div>
                            <div style="font-size: 0.7rem; color: #666;">ms</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultSDNN" class="stat-value" style="font-size: 2.2rem; color: #c2185b;">-</div>
                            <div class="stat-label">üìà SDNN</div>
                            <div style="font-size: 0.7rem; color: #666;">ms</div>
                        </div>
                    </div>

                    <!-- Advanced HRV Metrics -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 15px 0;">
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultPNN50" class="stat-value" style="font-size: 1.8rem; color: #7b1fa2;">-</div>
                            <div class="stat-label">üìã pNN50</div>
                            <div style="font-size: 0.7rem; color: #666;">%</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultLFHF" class="stat-value" style="font-size: 1.8rem; color: #7b1fa2;">-</div>
                            <div class="stat-label">‚öñÔ∏è LF/HF</div>
                            <div style="font-size: 0.7rem; color: #666;">ratio</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultSD1" class="stat-value" style="font-size: 1.8rem; color: #7b1fa2;">-</div>
                            <div class="stat-label">üéØ SD1</div>
                            <div style="font-size: 0.7rem; color: #666;">ms</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultSD2" class="stat-value" style="font-size: 1.8rem; color: #7b1fa2;">-</div>
                            <div class="stat-label">üîÑ SD2</div>
                            <div style="font-size: 0.7rem; color: #666;">ms</div>
                        </div>
                    </div>

                    <!-- Morphological Pulse Metrics -->
                    <h3 style="color: #E91E63; margin: 20px 0 10px 0; font-size: 1.1rem;">ü´Ä Vascular Health Indices</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 15px 0;">
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultPI" class="stat-value" style="font-size: 1.8rem; color: #ff5722;">-</div>
                            <div class="stat-label">üíâ PI</div>
                            <div style="font-size: 0.7rem; color: #666;">Perfusion Index %</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultRI" class="stat-value" style="font-size: 1.8rem; color: #ff5722;">-</div>
                            <div class="stat-label">üîÑ RI</div>
                            <div style="font-size: 0.7rem; color: #666;">Reflection Index %</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultSI" class="stat-value" style="font-size: 1.8rem; color: #ff5722;">-</div>
                            <div class="stat-label">üèóÔ∏è SI</div>
                            <div style="font-size: 0.7rem; color: #666;">Stiffness Index m/s</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0;">
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultDI" class="stat-value" style="font-size: 1.8rem; color: #ff5722;">-</div>
                            <div class="stat-label">üìà DI</div>
                            <div style="font-size: 0.7rem; color: #666;">Dicrotic Index %</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultSDR" class="stat-value" style="font-size: 1.8rem; color: #ff5722;">-</div>
                            <div class="stat-label">‚öñÔ∏è SDR</div>
                            <div style="font-size: 0.7rem; color: #666;">Systolic-Diastolic Ratio</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="resultPAV" class="stat-value" style="font-size: 1.8rem; color: #9c27b0;">-</div>
                            <div class="stat-label">üåä PAV</div>
                            <div style="font-size: 0.7rem; color: #666;">Pulse Amplitude Variation %</div>
                        </div>
                    </div>
                    
                    <!-- Quality Indicator -->
                    <div style="text-align: center; margin: 20px 0;">
                        <div id="qualityIndicator" style="padding: 12px 20px; border-radius: 20px; display: inline-block; font-weight: bold;">
                            <span id="qualityIcon">üü¢</span>
                            <span id="qualityText">Excellent Quality</span>
                            <span id="artifactPercentage">(2% artifacts)</span>
                        </div>
                    </div>
                    
                    <!-- Save or Discard Actions -->
                    <div style="display: flex; gap: 15px; margin: 25px 0;">
                        <button class="cta-button" onclick="saveReading()" style="flex: 1; background: linear-gradient(45deg, #4caf50, #81c784); padding: 15px;">
                            üíæ Save Reading
                        </button>
                        <button class="cta-button" onclick="addToPPGDataStorage()" style="flex: 1; background: linear-gradient(45deg, #2196f3, #64b5f6); padding: 15px;" id="addToPPGStorageBtn">
                            üìä Add to PPG Data Storage
                        </button>
                        <button class="cta-button" onclick="discardAndRetry()" style="flex: 1; background: linear-gradient(45deg, #f44336, #ef5350); padding: 15px;">
                            üîÑ Discard & Retry
                        </button>
                    </div>
                    
                    <!-- Additional Context Options -->
                    <div style="margin-top: 20px;">
                        <h4 style="color: #c2185b; margin-bottom: 10px;">üìù Add Context (Optional)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
                            <label><input type="checkbox" id="contextSleep"> üò¥ Poor sleep</label>
                            <label><input type="checkbox" id="contextStress"> üò∞ Stressed</label>
                            <label><input type="checkbox" id="contextCaffeine"> ‚òï Had caffeine</label>
                            <label><input type="checkbox" id="contextExercise"> üèÉ‚Äç‚ôÄÔ∏è Post exercise</label>
                            <label><input type="checkbox" id="contextMedication"> üíä Took medication</label>
                            <label><input type="checkbox" id="contextSick"> ü§í Feeling unwell</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Insights Screen -->
            <div id="insights" class="screen">
                <div class="card">
                    <h2 class="pink-accent">ü§ñ AI Health Insights ü§ñ</h2>
                    <div style="margin: 20px 0; padding: 15px; background: linear-gradient(45deg, rgba(255,105,180,0.1), rgba(240,147,251,0.1)); border-radius: 10px; border: 2px solid rgba(255,105,180,0.3);">
                        <p style="color: #2d1b2e; margin: 10px 0;">üíñ <strong>Heart Rate Variability:</strong> Your HRV shows excellent recovery patterns, indicating good cardiovascular fitness.</p>
                        <p style="color: #2d1b2e; margin: 10px 0;">üîÑ <strong>Cycle Correlation:</strong> Your heart rate tends to be 5-8 bpm higher during luteal phase - this is completely normal!</p>
                        <p style="color: #2d1b2e; margin: 10px 0;">üåü <strong>Recommendation:</strong> Consider gentle yoga during menstrual phase and high-intensity workouts during follicular phase.</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="pink-accent">üìà Weekly Trends</h3>
                    <p style="color: #2d1b2e; margin: 10px 0;">üìä Your resting heart rate has improved by 3 bpm this week</p>
                    <p style="color: #2d1b2e; margin: 10px 0;">üí™ Cardio fitness score increased by 2 points</p>
                    <p style="color: #2d1b2e; margin: 10px 0;">üò¥ Sleep quality correlation with heart health: 92%</p>
                </div>
            </div>
            
            <!-- Cycle Analytics Screen -->
            <div id="cycle-analytics" class="screen">
                <div class="card">
                    <h2 class="pink-accent">üîÑ Cycle Analytics üîÑ</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">Day 12</div>
                            <div class="stat-label">üìÖ Cycle Day</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">28</div>
                            <div class="stat-label">üîÑ Cycle Length</div>
                        </div>
                    </div>
                    
                    <h3 class="pink-accent">üìä Phase Impact on Heart Health</h3>
                    <div style="margin: 15px 0;">
                        <div style="margin: 10px 0; padding: 10px; background: rgba(255,105,180,0.1); border-radius: 8px; border-left: 4px solid #ff69b4;">
                            <strong style="color: #d63384;">Menstrual Phase:</strong> <span style="color: #2d1b2e;">Heart rate typically 2-3 bpm lower, focus on gentle movement</span>
                        </div>
                        <div style="margin: 10px 0; padding: 10px; background: rgba(255,105,180,0.1); border-radius: 8px; border-left: 4px solid #f093fb;">
                            <strong style="color: #d63384;">Follicular Phase:</strong> <span style="color: #2d1b2e;">Energy levels high, perfect for cardio workouts</span>
                        </div>
                        <div style="margin: 10px 0; padding: 10px; background: rgba(255,105,180,0.1); border-radius: 8px; border-left: 4px solid #d63384;">
                            <strong style="color: #d63384;">Ovulation:</strong> <span style="color: #2d1b2e;">Peak performance time, optimal for high-intensity training</span>
                        </div>
                        <div style="margin: 10px 0; padding: 10px; background: rgba(255,105,180,0.1); border-radius: 8px; border-left: 4px solid #e91e63;">
                            <strong style="color: #d63384;">Luteal Phase:</strong> <span style="color: #2d1b2e;">Heart rate elevated, focus on strength and flexibility</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Master Blueprint v10.0: Advanced PPG Analytics - REORGANIZED LAYOUT -->
            <div id="ppg" class="screen">
                <div class="card">
                    <h2 class="pink-accent">ü´Ä Clinical-Grade PPG Analytics</h2>
                    <p style="color: #4a2c4a; text-align: center; margin: 15px 0; font-size: 0.9rem;">
                        Research-quality PPG capture with pulse morphology analysis<br>
                        <span style="font-size: 0.8rem; opacity: 0.8;">Real heart rate detection with systolic peak & dicrotic notch analysis</span>
                    </p>
                    
                    <!-- TOP SECTION: Camera and PPG Waveform Side-by-Side -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; align-items: start;">
                        
                        <!-- LEFT: PPG Camera Feed -->
                        <div style="text-align: center;">
                            <h4 style="color: #c2185b; margin-bottom: 15px;">üìπ Camera View</h4>
                            <video id="ppgVideo" width="320" height="240" autoplay style="border-radius: 15px; border: 3px solid #f8bbd9; background: #fce4ec; max-width: 100%;"></video>
                            
                            <!-- Camera Controls -->
                            <div style="margin: 15px 0;">
                                <button id="startPPG" class="cta-button" onclick="startPPGMeasurement()" style="padding: 12px 20px; font-size: 0.9rem;">
                                    üìπ Start Measurement
                                </button>
                                <button id="stopPPG" class="cta-button" onclick="stopPPGMeasurement()" style="display: inline-block; background: linear-gradient(45deg, #e57373, #f8bbd9); padding: 12px 20px; font-size: 0.9rem; margin-left: 10px;">
                                    ‚èπÔ∏è Stop Measurement
                                </button>

                            </div>
                            
                            <!-- Timer Display -->
                            <div id="timerDisplay" style="display: none; margin: 10px 0;">
                                <div style="background: linear-gradient(45deg, #f8bbd9, #fce4ec); padding: 15px; border-radius: 15px; border: 2px solid rgba(248,187,217,0.5);">
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #c2185b;" id="timerCount">30</div>
                                    <div style="color: #4a2c4a; font-size: 0.8rem; margin-top: 5px;">seconds remaining</div>
                                    <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.5); border-radius: 3px; margin-top: 8px; overflow: hidden;">
                                        <div id="timerProgress" style="height: 100%; background: linear-gradient(90deg, #f48fb1, #f8bbd9); width: 100%; border-radius: 3px; transition: width 1s linear;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT: PPG Waveform Chart -->
                        <div>
                            <h4 style="color: #c2185b; margin-bottom: 15px; text-align: center;">ü´Ä Live PPG Waveform</h4>
                            <div style="border: 2px solid #E91E63; border-radius: 15px; background: rgba(248,187,217,0.1); padding: 15px; box-shadow: 0 4px 20px rgba(233,30,99,0.2);">
                                <div style="height: 280px;">
                                    <canvas id="ppgSignalChart"></canvas>
                                </div>
                                <div id="ppgStatus" style="text-align: center; margin: 10px 0; color: #666; font-size: 0.85rem;">
                                    üì° PPG waveform display ready - waiting for real camera data...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PPG Status Display -->
                    <div id="heartRateStatus" style="text-align: center; margin: 15px 0; padding: 12px; background: rgba(248,187,217,0.3); border-radius: 15px; color: #c2185b; font-weight: bold; min-height: 20px;">
                        Ready to start measurement
                    </div>
                    
                    <!-- Timer Selection -->
                    <div id="timerSelection" style="text-align: center; margin: 20px 0;">
                        <h4 style="color: #c2185b; margin-bottom: 15px;">‚è±Ô∏è Measurement Duration</h4>
                        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                            <button class="timer-option" onclick="setTimer(15)" style="padding: 10px 15px; border: 2px solid #f8bbd9; background: rgba(248,187,217,0.2); color: #c2185b; border-radius: 12px; cursor: pointer; font-weight: bold;">15s</button>
                            <button class="timer-option active" onclick="setTimer(30)" style="padding: 10px 15px; border: 2px solid #f48fb1; background: linear-gradient(45deg, #f8bbd9, #fce4ec); color: #c2185b; border-radius: 12px; cursor: pointer; font-weight: bold;">30s</button>
                            <button class="timer-option" onclick="setTimer(45)" style="padding: 10px 15px; border: 2px solid #f8bbd9; background: rgba(248,187,217,0.2); color: #c2185b; border-radius: 12px; cursor: pointer; font-weight: bold;">45s</button>
                            <button class="timer-option" onclick="setTimer(60)" style="padding: 10px 15px; border: 2px solid #f8bbd9; background: rgba(248,187,217,0.2); color: #c2185b; border-radius: 12px; cursor: pointer; font-weight: bold;">60s</button>
                        </div>
                    </div>
                
                </div>
                
                <!-- BOTTOM SECTION: All Metrics and Analysis Below Camera/Waveform -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="pink-accent">üìä PPG Results & Analysis</h3>
                    
                    <!-- ü©ª COMPREHENSIVE CLINICAL METRICS - LIVE DASHBOARD -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 20px 0;">
                        <!-- Core HRV Metrics -->
                        <div class="stat-card" style="text-align: center;">
                            <div id="heartRateDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üíñ HR (BPM)</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="sdnnDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üïë SDNN (ms)</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="rmssdDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">‚ö° RMSSD (ms)</div>
                        </div>
                        
                        <!-- Frequency Domain HRV -->
                        <div class="stat-card" style="text-align: center;">
                            <div id="pnn50Display" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üìà pNN50 (%)</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="lfhfDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">‚öñÔ∏è LF/HF</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="sd1Display" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üéØ SD1 (ms)</div>
                        </div>
                        
                        <!-- Morphological Pulse Metrics -->
                        <div class="stat-card" style="text-align: center;">
                            <div id="piDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üíß PI (%)</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="riDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üåä RI (%)</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="siDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üßç SI (m/s)</div>
                        </div>
                        
                        <!-- Additional Morphological Metrics -->
                        <div class="stat-card" style="text-align: center;">
                            <div id="diDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üíé DI (%)</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="sdrDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">‚öñÔ∏è SDR</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <div id="pavDisplay" class="stat-value" style="font-size: 1.8rem;">--</div>
                            <div class="stat-label">üå¨Ô∏è PAV (%)</div>
                        </div>
                    </div>
                    
                    <!-- Quality & Status Indicators -->
                    <div style="display: flex; justify-content: space-between; margin: 15px 0; font-size: 0.85rem; flex-wrap: wrap; gap: 10px;">
                        <div id="signalQuality" style="padding: 5px 10px; background: rgba(76,175,80,0.2); border-radius: 15px; color: #2e7d32;">
                            üì∂ Signal: --
                        </div>
                        <div id="cyclePhase" style="padding: 5px 10px; background: rgba(233,30,99,0.2); border-radius: 15px; color: #c2185b;">
                            üåô Phase: --
                        </div>
                        <div id="artifactPercent" style="padding: 5px 10px; background: rgba(255,152,0,0.2); border-radius: 15px; color: #f57c00;">
                            ‚ö° Artifacts: --
                        </div>
                        <!-- üß™ TEST BUTTON for debugging dashboard -->
                        <button onclick="testDashboardUpdate()" style="padding: 5px 10px; background: rgba(255,0,0,0.2); border: none; border-radius: 15px; color: #d32f2f; cursor: pointer; font-size: 0.8rem;">
                            üß™ Test Cards
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Analysis Section (Moved Below) -->
                <div id="ppgVisualization" style="display: none; margin: 20px 0;">
                        
                        <!-- Advanced Deep Learning Analysis Section -->
                        <div class="card" style="margin: 20px 0; background: linear-gradient(135deg, rgba(233,30,99,0.05), rgba(156,39,176,0.05));">
                            <h3 style="color: #c2185b; margin-bottom: 15px; text-align: center;">
                                üß† Advanced Deep Learning Analysis
                            </h3>
                            <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                                AI-powered PPG analysis using CNN, LSTM, and Transformer models
                            </p>
                            
                            <!-- Deep Learning Status -->
                            <div id="dlStatus" style="text-align: center; margin: 15px 0;">
                                <div style="padding: 10px; background: rgba(76,175,80,0.1); border-radius: 10px; color: #2e7d32;">
                                    üîÑ Loading deep learning models...
                                </div>
                            </div>
                            
                            <!-- Advanced Analysis Button -->
                            <div style="text-align: center; margin: 20px 0;">
                                <button id="analyzeAdvanced" class="cta-button" onclick="performAdvancedAnalysis()" style="background: linear-gradient(135deg, #9c27b0, #e91e63);">
                                    üî¨ Analyze with AI Models
                                </button>
                            </div>
                            
                            <!-- Advanced Results Display -->
                            <div id="advancedResults" style="display: none; margin: 20px 0;">
                                <h4 style="color: #c2185b; margin-bottom: 15px; text-align: center;">üéØ AI Analysis Results</h4>
                                
                                <!-- Model Predictions -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0;">
                                    <div class="stat-card" style="background: rgba(233,30,99,0.1);">
                                        <div id="cnnPrediction" class="stat-value" style="font-size: 1.5rem; color: #e91e63;">--</div>
                                        <div class="stat-label">üîÆ CNN Model</div>
                                    </div>
                                    <div class="stat-card" style="background: rgba(156,39,176,0.1);">
                                        <div id="lstmPrediction" class="stat-value" style="font-size: 1.5rem; color: #9c27b0;">--</div>
                                        <div class="stat-label">‚è∞ LSTM Model</div>
                                    </div>
                                    <div class="stat-card" style="background: rgba(63,81,181,0.1);">
                                        <div id="ensemblePrediction" class="stat-value" style="font-size: 1.5rem; color: #3f51b5;">--</div>
                                        <div class="stat-label">üéØ Ensemble</div>
                                    </div>
                                </div>
                                
                                <!-- Risk Assessment -->
                                <div class="card" style="background: rgba(255,255,255,0.9); margin: 15px 0;">
                                    <h5 style="color: #c2185b; margin-bottom: 10px;">üéØ Risk Assessment</h5>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                                        <span>Risk Level:</span>
                                        <span id="riskLevel" style="font-weight: bold; color: #2e7d32;">Low Risk</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                                        <span>Confidence:</span>
                                        <span id="aiConfidence" style="font-weight: bold; color: #2e7d32;">87%</span>
                                    </div>
                                    <div id="riskProgress" style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin: 10px 0;">
                                        <div style="height: 100%; background: linear-gradient(90deg, #4caf50, #ff9800, #f44336); width: 25%; border-radius: 4px;"></div>
                                    </div>
                                </div>
                                
                                <!-- Explainable AI -->
                                <div class="card" style="background: rgba(255,255,255,0.9); margin: 15px 0;">
                                    <h5 style="color: #c2185b; margin-bottom: 10px;">üîç Explainable AI</h5>
                                    <div id="topFeatures" style="font-size: 0.9rem;">
                                        <p><strong>Top Contributing Factors:</strong></p>
                                        <ul id="featuresList" style="margin: 10px 0; padding-left: 20px;">
                                            <li>Heart rate variability patterns</li>
                                            <li>PPG signal morphology</li>
                                            <li>Temporal dynamics</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <!-- AI Recommendations -->
                                <div class="card" style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(139,195,74,0.1)); margin: 15px 0;">
                                    <h5 style="color: #2e7d32; margin-bottom: 10px;">üí° AI-Powered Recommendations</h5>
                                    <ul id="aiRecommendations" style="margin: 0; padding-left: 20px; color: #4a2c4a;">
                                        <li>Continue regular cardiovascular exercise</li>
                                        <li>Maintain current stress management practices</li>
                                        <li>Monitor HRV trends during luteal phase</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- HRV & RR Intervals -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                            <div class="card">
                                <h4 style="color: #c2185b; margin-bottom: 10px;">üíì Heart Rate Trend</h4>
                                <div style="height: 180px;">
                                    <canvas id="hrTrendChart"></canvas>
                                </div>
                            </div>
                            <div class="card">
                                <h4 style="color: #c2185b; margin-bottom: 10px;">üåä RR Intervals</h4>
                                <div style="height: 180px;">
                                    <canvas id="rrIntervalChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Metrics Display -->
                        <div class="card" style="margin: 15px 0;">
                            <h4 style="color: #c2185b; margin-bottom: 15px;">üìà Live HRV Metrics</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                <div style="text-align: center; padding: 10px; background: rgba(248,187,217,0.2); border-radius: 10px;">
                                    <div id="liveRMSSD" style="font-size: 1.5rem; font-weight: bold; color: #c2185b;">--</div>
                                    <div style="font-size: 0.8rem; color: #666;">RMSSD (ms)</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: rgba(248,187,217,0.2); border-radius: 10px;">
                                    <div id="liveSDNN" style="font-size: 1.5rem; font-weight: bold; color: #c2185b;">--</div>
                                    <div style="font-size: 0.8rem; color: #666;">SDNN (ms)</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: rgba(248,187,217,0.2); border-radius: 10px;">
                                    <div id="livePNN50" style="font-size: 1.5rem; font-weight: bold; color: #c2185b;">--</div>
                                    <div style="font-size: 0.8rem; color: #666;">pNN50 (%)</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: rgba(248,187,217,0.2); border-radius: 10px;">
                                    <div id="liveSignalQuality" style="font-size: 1.5rem; font-weight: bold; color: #c2185b;">--</div>
                                    <div style="font-size: 0.8rem; color: #666;">Signal Quality</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Preprocessing Status -->
                        <div class="card" style="margin: 15px 0;">
                            <h4 style="color: #c2185b; margin-bottom: 15px;">AI Signal Processing</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                        <span style="font-size: 0.9rem; color: #666;">Processing Method:</span>
                                        <span id="processingMethod" style="font-weight: bold; color: #c2185b;">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                        <span style="font-size: 0.9rem; color: #666;">Quality Score:</span>
                                        <span id="qualityScore" style="font-weight: bold; color: #c2185b;">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                        <span style="font-size: 0.9rem; color: #666;">Artifact Level:</span>
                                        <span id="artifactLevel" style="font-weight: bold; color: #c2185b;">--</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">Quality Trend:</div>
                                    <div style="height: 60px;">
                                        <canvas id="qualityTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div id="aiRecommendations" style="margin-top: 10px; padding: 8px; background: rgba(76,175,80,0.1); border-radius: 8px; font-size: 0.85rem; color: #2e7d32; display: none;">
                                <strong>AI Recommendations:</strong>
                                <ul id="recommendationsList" style="margin: 5px 0 0 20px;"></ul>
                            </div>
                        </div>
                        
                        <!-- Clinical Indices Display -->
                        <div class="card" style="margin: 15px 0;">
                            <h4 style="color: #c2185b; margin-bottom: 15px;">Clinical Indices</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="text-align: center; padding: 10px; background: rgba(248,187,217,0.2); border-radius: 10px;">
                                    <div id="abiScore" style="font-size: 1.3rem; font-weight: bold; color: #c2185b;">--</div>
                                    <div style="font-size: 0.7rem; color: #666;">ABI Score</div>
                                    <div id="abiInterpretation" style="font-size: 0.65rem; color: #888; margin-top: 2px;">--</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: rgba(248,187,217,0.2); border-radius: 10px;">
                                    <div id="cvrScore" style="font-size: 1.3rem; font-weight: bold; color: #c2185b;">--</div>
                                    <div style="font-size: 0.7rem; color: #666;">CVR Score</div>
                                    <div id="cvrInterpretation" style="font-size: 0.65rem; color: #888; margin-top: 2px;">--</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: rgba(248,187,217,0.2); border-radius: 10px;">
                                    <div id="csiScore" style="font-size: 1.3rem; font-weight: bold; color: #c2185b;">--</div>
                                    <div style="font-size: 0.7rem; color: #666;">CSI Score</div>
                                    <div id="csiInterpretation" style="font-size: 0.65rem; color: #888; margin-top: 2px;">--</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Risk Assessment -->
                        <div class="card" style="margin: 15px 0;">
                            <h4 style="color: #c2185b; margin-bottom: 15px;">AI Risk Assessment</h4>
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                                <div>
                                    <div style="text-align: center; padding: 15px; border-radius: 10px;" id="aiRiskContainer">
                                        <div id="aiRiskLevel" style="font-size: 1.5rem; font-weight: bold; color: #c2185b;">--</div>
                                        <div style="font-size: 0.8rem; color: #666;">Risk Level</div>
                                        <div id="aiConfidence" style="font-size: 0.7rem; color: #888; margin-top: 5px;">--</div>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">Risk Probabilities:</div>
                                    <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                        <span style="font-size: 0.8rem;">Low:</span>
                                        <span id="lowRiskProb" style="font-size: 0.8rem; font-weight: bold;">--%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                        <span style="font-size: 0.8rem;">Moderate:</span>
                                        <span id="moderateRiskProb" style="font-size: 0.8rem; font-weight: bold;">--%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                        <span style="font-size: 0.8rem;">High:</span>
                                        <span id="highRiskProb" style="font-size: 0.8rem; font-weight: bold;">--%</span>
                                    </div>
                                </div>
                            </div>
                            <div id="literaturePatterns" style="margin-top: 10px; display: none;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Literature Patterns Detected:</div>
                                <ul id="patternsList" style="font-size: 0.8rem; margin: 0; padding-left: 20px; color: #444;"></ul>
                            </div>
                            <div id="aiClinicalRecommendations" style="margin-top: 10px; padding: 8px; background: rgba(33,150,243,0.1); border-radius: 8px; font-size: 0.85rem; color: #1565c0; display: none;">
                                <strong>Clinical Recommendations:</strong>
                                <ul id="clinicalRecommendationsList" style="margin: 5px 0 0 20px;"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PPG Instructions -->
                    <div style="background: rgba(248,187,217,0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(248,187,217,0.4); margin: 15px 0;">
                        <h4 style="color: #c2185b; margin-bottom: 10px;">üìã REAL PPG Instructions:</h4>
                        <ol style="color: #4a2c4a; margin-left: 20px;">
                            <li style="margin: 8px 0;">üí° <strong>Optimal lighting</strong> - Bright light needed, but avoid over-saturation</li>
                            <li style="margin: 8px 0;">üëÜ <strong>Light finger pressure</strong> - Gently touch camera + flashlight (don't press hard!)</li>
                            <li style="margin: 8px 0;">üéØ <strong>Check for red glow</strong> - Should see soft red, not bright white (= saturated)</li>
                            <li style="margin: 8px 0;">üìä <strong>Watch for plateaued peaks</strong> - If peaks look flat, reduce pressure/light</li>
                            <li style="margin: 8px 0;">‚è±Ô∏è Keep finger still for the entire timer duration</li>
                            <li style="margin: 8px 0;">üíì Real heart rate will be calculated from blood flow detection</li>
                        </ol>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(193, 225, 193, 0.3); border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <strong style="color: #2E7D32;">‚ú® Now Using REAL PPG Processing!</strong><br>
                            <span style="font-size: 0.9rem; color: #4a2c4a;">Your camera feed is analyzed for actual blood flow patterns</span>
                        </div>
                        
                        <div style="margin-top: 10px; padding: 8px; background: rgba(248,187,217,0.2); border-radius: 8px; border-left: 4px solid #E91E63;">
                            <strong style="color: #c2185b;">ü´Ä What to Expect - Classic PPG Pulse Shape:</strong><br>
                            <div style="font-family: monospace; font-size: 0.85rem; margin: 5px 0; color: #4a2c4a;">
                                <pre style="margin: 0; color: #c2185b;">   /\           /\          /\ 
  /  \_     /\_/  \_     /\_/  \_
 ‚Üë     ‚Üë         ‚Üë     ‚Üë
systolic    dicrotic    systolic
 peak       notch        peak</pre>
                            </div>
                            <span style="font-size: 0.85rem; color: #4a2c4a;">
                                Each tall bump = one heartbeat ‚Ä¢ Small dip = dicrotic notch<br>
                                <strong>üéØ Goal:</strong> See sharp peaks, not flat plateaus!
                            </span>
                        </div>
                    </div>
                    
                    <!-- Recent Measurements -->
                    <div id="recentMeasurements" style="margin-top: 20px;">
                        <h4 style="color: #c2185b;">üìä Recent Measurements:</h4>
                        <div id="measurementHistory" style="color: #4a2c4a; margin: 10px 0;">
                            No measurements yet
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recommendations Screen -->
            <div id="recommendations" class="screen">
                <div class="card">
                    <h2 class="pink-accent">üí° Personalized Recommendations üí°</h2>
                    
                    <h3 class="pink-accent">üèÉ‚Äç‚ôÄÔ∏è Exercise Recommendations</h3>
                    <ul style="margin: 15px 0; color: #2d1b2e;">
                        <li style="margin: 8px 0;">üí™ Monday: 30-min moderate cardio (your follicular phase energy is perfect!)</li>
                        <li style="margin: 8px 0;">üßò‚Äç‚ôÄÔ∏è Tuesday: Yoga and stretching (support your heart with mindful movement)</li>
                        <li style="margin: 8px 0;">üèãÔ∏è‚Äç‚ôÄÔ∏è Wednesday: Strength training (build that cardiovascular endurance!)</li>
                        <li style="margin: 8px 0;">üö∂‚Äç‚ôÄÔ∏è Thursday: Nature walk (gentle recovery for optimal heart health)</li>
                    </ul>
                    
                    <h3 class="pink-accent">ü•ó Nutrition for Heart Health</h3>
                    <ul style="margin: 15px 0; color: #2d1b2e;">
                        <li style="margin: 8px 0;">ü´ê Antioxidant-rich berries for cardiovascular protection</li>
                        <li style="margin: 8px 0;">ü•ë Healthy fats from avocados and nuts</li>
                        <li style="margin: 8px 0;">üêü Omega-3 rich fish twice per week</li>
                        <li style="margin: 8px 0;">ü•¨ Leafy greens for nitric oxide production</li>
                    </ul>
                    
                    <h3 class="pink-accent">üò¥ Sleep Optimization</h3>
                    <p style="color: #2d1b2e; margin: 10px 0;">üåô Aim for 7-9 hours of quality sleep to support heart recovery</p>
                    <p style="color: #2d1b2e; margin: 10px 0;">üì± Limit screen time 1 hour before bed</p>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" onclick="event.preventDefault(); showScreen('welcome'); return false;">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Home</div>
            </a>
            <a href="#" class="nav-item" onclick="event.preventDefault(); showScreen('dashboard'); return false;">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Dashboard</div>
            </a>
            <a href="#" class="nav-item" onclick="event.preventDefault(); showScreen('ppg'); return false;">
                <div class="nav-icon">üíì</div>
                <div class="nav-label">PPG</div>
            </a>
            <a href="#" class="nav-item" onclick="event.preventDefault(); showScreen('insights'); return false;">
                <div class="nav-icon">üß†</div>
                <div class="nav-label">Insights</div>
            </a>
            <a href="#" class="nav-item" onclick="event.preventDefault(); showScreen('recommendations'); return false;">
                <div class="nav-icon">üí°</div>
                <div class="nav-label">Tips</div>
            </a>
        </nav>
    </div>

    <script>
        // Navigation Functions
        function toggleMenu() {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('open');
        }

        /**
         * Displays a non-blocking status message in the #heartRateStatus element.
         * @param {string} message The message to display.
         * @param {'info' | 'success' | 'error'} type The type of message, for styling.
         */
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('heartRateStatus');
            // Also check the onboarding screen for a status box, as PPG one may not be visible
            const onboardingStatus = document.getElementById('onboardingStatus'); 
            const targetStatus = status && status.offsetParent !== null ? status : onboardingStatus;

            if (targetStatus) {
                targetStatus.textContent = message;
                targetStatus.style.display = 'block'; // Make sure it's visible
                if (type === 'error') {
                    targetStatus.style.color = '#d32f2f';
                    targetStatus.style.background = 'rgba(244,67,54,0.1)';
                    targetStatus.style.borderLeft = '4px solid #d32f2f';
                } else if (type === 'success') {
                    targetStatus.style.color = '#2e7d32';
                    targetStatus.style.background = 'rgba(76,175,80,0.1)';
                    targetStatus.style.borderLeft = '4px solid #2e7d32';
                } else { // info
                    targetStatus.style.color = '#c2185b';
                    targetStatus.style.background = 'rgba(248,187,217,0.3)';
                    targetStatus.style.borderLeft = '4px solid #c2185b';
                }
            } else {
                console.log(`Status update (${type}): ${message}`);
            }
        }
        
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Update active nav link
            document.querySelectorAll('.nav-link, .nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick').includes(`'${screenId}'`)) {
                    link.classList.add('active');
                }
            });
            
            // Close menu after selection
            toggleMenu();

            // Special init for PPG page
            if (screenId === 'ppg') {
                initPPGPage();
            }
        }
        
        // Master Blueprint: Core Functions
        async function createAccount() {
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const age = document.getElementById('userAge').value;
            const sex = document.getElementById('sexAtBirth').value;
            const cycleLength = document.getElementById('cycleLength').value;
            
            if (!email || !password || !age || !sex) {
                updateStatus('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        date_of_birth: new Date(Date.now() - age * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        sex_at_birth: sex,
                        cycle_length_days: parseInt(cycleLength)
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem('pulseher_token', result.token);
                    localStorage.setItem('pulseher_user_id', result.user_id);
                    updateStatus('Account created successfully! üéâ', 'success');
                    showScreen('ppg');
                } else {
                    updateStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Account creation error:', error);
                updateStatus('Account created locally (demo mode)', 'info');
                showScreen('ppg');
            }
        }
        
        // Global variables for session data
        let currentSessionData = null;
        
        function saveReading() {
            if (!currentSessionData) {
                updateStatus('No session data to save', 'error');
                return;
            }
            
            // Collect context
            const context = {
                poor_sleep: document.getElementById('contextSleep').checked,
                stressed: document.getElementById('contextStress').checked,
                had_caffeine: document.getElementById('contextCaffeine').checked,
                post_exercise: document.getElementById('contextExercise').checked,
                took_medication: document.getElementById('contextMedication').checked,
                feeling_unwell: document.getElementById('contextSick').checked
            };
            
            // Save to backend
            saveSessionToBackend(currentSessionData, context);
            
            updateStatus('Reading saved successfully! üíæ', 'success');
            showScreen('dashboard');
        }
        
        function discardAndRetry() {
            currentSessionData = null;
            
            // Clear results
            document.getElementById('resultHR').textContent = '--';
            document.getElementById('resultRMSSD').textContent = '--';
            document.getElementById('resultSDNN').textContent = '--';
            
            // Reset context checkboxes
            document.querySelectorAll('#results input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            showScreen('ppg');
        }
        
        async function saveSessionToBackend(sessionData, context) {
            try {
                const token = localStorage.getItem('pulseher_token');
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        rr_intervals: sessionData.rr_intervals,
                        duration: sessionData.duration,
                        sampling_rate: 30,
                        context: context,
                        device_type: 'camera_ppg'
                    })
                });
                
                if (response.ok) {
                    console.log('Session saved to backend');
                } else {
                    console.log('Saved locally (demo mode)');
                }
            } catch (error) {
                console.log('Saved locally (demo mode)');
            }
        }
        
        function updateQualityIndicator(artifactPercent) {
            const qualityIcon = document.getElementById('qualityIcon');
            const qualityText = document.getElementById('qualityText');
            const qualityDiv = document.getElementById('qualityIndicator');
            const artifactSpan = document.getElementById('artifactPercentage');
            
            if (artifactPercent <= 5) {
                qualityIcon.textContent = 'üü¢';
                qualityText.textContent = 'Excellent Quality';
                qualityDiv.style.background = 'rgba(76, 175, 80, 0.2)';
                qualityDiv.style.color = '#2e7d32';
            } else if (artifactPercent <= 15) {
                qualityIcon.textContent = 'üü°';
                qualityText.textContent = 'Good Quality';
                qualityDiv.style.background = 'rgba(255, 193, 7, 0.2)';
                qualityDiv.style.color = '#f57c00';
            } else {
                qualityIcon.textContent = 'üî¥';
                qualityText.textContent = 'Poor Quality';
                qualityDiv.style.background = 'rgba(244, 67, 54, 0.2)';
                qualityDiv.style.color = '#d32f2f';
            }
            
            artifactSpan.textContent = `(${artifactPercent}% artifacts)`;
        }
        
        function showScreen(screenId) {
            try {
                console.log('üîÑ Switching to screen:', screenId);
                
                // Hide all screens
                const screens = document.querySelectorAll('.screen');
                screens.forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // Show selected screen
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.add('active');
                    console.log('‚úÖ Screen activated:', screenId);
                } else {
                    console.warn('‚ö†Ô∏è Screen not found:', screenId);
                }
                
                // Update nav links
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });
                
                // Update bottom nav
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // Close menu if open
                const navMenu = document.getElementById('navMenu');
                if (navMenu) {
                    navMenu.classList.remove('open');
                }
                
                // Add some pink sparkle effect
                if (screenId === 'welcome') {
                    document.body.style.animation = 'gradientShift 8s ease-in-out infinite';
                }
            } catch (error) {
                console.error('‚ùå Error in showScreen:', error);
            }
        }
        
        // Survey Navigation Functions
        let currentSurveyStep = 1;
        const totalSteps = 6;
        
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentSurveyStep < totalSteps) {
                    // Hide current step
                    document.getElementById(`step${currentSurveyStep}`).style.display = 'none';
                    document.getElementById(`surveyStep${currentSurveyStep}`).style.color = '#999';
                    
                    // Show next step
                    currentSurveyStep++;
                    document.getElementById(`step${currentSurveyStep}`).style.display = 'block';
                    document.getElementById(`surveyStep${currentSurveyStep}`).style.color = '#E91E63';
                    document.getElementById(`surveyStep${currentSurveyStep}`).style.fontWeight = 'bold';
                    
                    // Update navigation buttons
                    updateNavigationButtons();
                }
            }
        }
        
        function previousStep() {
            if (currentSurveyStep > 1) {
                // Hide current step
                document.getElementById(`step${currentSurveyStep}`).style.display = 'none';
                document.getElementById(`surveyStep${currentSurveyStep}`).style.color = '#999';
                document.getElementById(`surveyStep${currentSurveyStep}`).style.fontWeight = 'normal';
                
                // Show previous step
                currentSurveyStep--;
                document.getElementById(`step${currentSurveyStep}`).style.display = 'block';
                document.getElementById(`surveyStep${currentSurveyStep}`).style.color = '#E91E63';
                document.getElementById(`surveyStep${currentSurveyStep}`).style.fontWeight = 'bold';
                
                // Update navigation buttons
                updateNavigationButtons();
            }
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            // Show/hide previous button
            prevBtn.style.display = currentSurveyStep > 1 ? 'block' : 'none';
            
            // Show/hide next vs submit button
            if (currentSurveyStep === totalSteps) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }
        
        function validateCurrentStep() {
            let isValid = true;
            const currentStepDiv = document.getElementById(`step${currentSurveyStep}`);
            const requiredFields = currentStepDiv.querySelectorAll('input[required], select[required]');
            let firstErrorMessage = '';

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#ff6b6b';
                    isValid = false;
                    if (!firstErrorMessage) {
                        firstErrorMessage = 'Please complete all required fields before continuing.';
                    }
                } else {
                    field.style.borderColor = '#ddd';
                }
            });

            // Special validation for password confirmation
            if (currentSurveyStep === 1) {
                const password = document.getElementById('userPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                if (password !== confirmPassword) {
                    document.getElementById('confirmPassword').style.borderColor = '#ff6b6b';
                    isValid = false;
                    if (!firstErrorMessage) {
                        firstErrorMessage = 'Passwords do not match!';
                    }
                }
            }

            // Special validation for terms consent
            if (currentSurveyStep === 6) {
                const termsConsent = document.getElementById('termsConsent');
                if (!termsConsent.checked) {
                    isValid = false;
                    if (!firstErrorMessage) {
                        firstErrorMessage = 'Please agree to the Terms of Service and Privacy Policy to continue.';
                    }
                }
            }

            if (!isValid && firstErrorMessage) {
                updateStatus(firstErrorMessage, 'error', 'onboardingStatus');
            } else {
                // Clear status if valid
                updateStatus('', 'clear', 'onboardingStatus');
            }

            return isValid;
        }
        
        function submitSurvey() {
            if (validateCurrentStep()) {
                // Collect all form data
                const surveyData = {
                    // Account info
                    email: document.getElementById('userEmail').value,
                    password: document.getElementById('userPassword').value,
                    
                    // Demographics
                    age: document.getElementById('userAge').value,
                    height: document.getElementById('userHeight').value,
                    weight: document.getElementById('userWeight').value,
                    sexAtBirth: document.getElementById('sexAtBirth').value,
                    genderIdentity: document.getElementById('genderIdentity').value,
                    
                    // Medical history
                    medicalConditions: {
                        diabetes: document.getElementById('diabetes').checked,
                        hypertension: document.getElementById('hypertension').checked,
                        heartDisease: document.getElementById('heartDisease').checked,
                        thyroid: document.getElementById('thyroid').checked,
                        pcos: document.getElementById('pcos').checked,
                        endometriosis: document.getElementById('endometriosis').checked,
                        anxiety: document.getElementById('anxiety').checked,
                        depression: document.getElementById('depression').checked,
                        migraines: document.getElementById('migraines').checked,
                        asthma: document.getElementById('asthma').checked
                    },
                    otherConditions: document.getElementById('otherConditions').value,
                    medications: {
                        betaBlockers: document.getElementById('betaBlockers').checked,
                        contraceptives: document.getElementById('contraceptives').checked,
                        ssris: document.getElementById('ssris').checked,
                        thyroidMeds: document.getElementById('thyroidMeds').checked,
                        stimulants: document.getElementById('stimulants').checked,
                        other: document.getElementById('otherMedications').value
                    },
                    familyHistory: {
                        cad: document.getElementById('familyCAD').value,
                        stroke: document.getElementById('familyStroke').value
                    },
                    
                    // Lifestyle
                    sleepHours: document.getElementById('sleepHours').value,
                    caffeineIntake: document.getElementById('caffeineIntake').value,
                    exerciseFreq: document.getElementById('exerciseFreq').value,
                    workSchedule: document.querySelector('input[name="workSchedule"]:checked')?.value,
                    
                    // Menstrual/hormonal
                    cycleLength: document.getElementById('cycleLength').value,
                    lutealLength: document.getElementById('lutealLength').value,
                    lastPeriod: document.getElementById('lastPeriod').value,
                    contraceptionType: document.getElementById('contraceptionType').value,
                    menopauseStatus: document.getElementById('menopauseStatus').value,
                    
                    // Privacy preferences
                    researchConsent: document.getElementById('researchConsent').checked,
                    improveAlgorithms: document.getElementById('improveAlgorithms').checked,
                    personalizedInsights: document.getElementById('personalizedInsights').checked,
                    exportData: document.getElementById('exportData').checked,
                    termsConsent: document.getElementById('termsConsent').checked
                };
                
                console.log('Survey data collected:', surveyData);
                
                // Send data to backend
                submitUserProfile(surveyData);
                
                // Show success message and redirect
                updateStatus('üéâ Profile created successfully! Welcome to PulseHER!', 'success', 'onboardingStatus');
                showScreen('dashboard');
                
                // Store user data locally for demo
                localStorage.setItem('pulseher_user_profile', JSON.stringify(surveyData));
                localStorage.setItem('pulseher_token', 'demo_token_' + Date.now());
            }
        }
        
        async function submitUserProfile(profileData) {
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Profile submitted successfully:', result);
                } else {
                    console.log('Profile saved locally (demo mode)');
                }
            } catch (error) {
                console.log('Profile saved locally (demo mode)');
            }
        }
        
        // Initialize app when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Force refresh styles
            document.body.offsetHeight;
            
            // Initialize clean slate
            const userState = initializeCleanSlate();
            console.log('üíù PulseHER initialized with clean slate for user:', userState.userId);
            
            // Check deep learning status
            checkDeepLearningStatus();
            
            // Reduced sparkle frequency for better performance
            document.addEventListener('mousemove', function(e) {
                if (Math.random() > 0.98) {
                    createSparkle(e.clientX, e.clientY);
                }
            });
        });
        
        function createSparkle(x, y) {
            const sparkle = document.createElement('div');
            sparkle.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                width: 4px;
                height: 4px;
                background: #ff69b4;
                border-radius: 50%;
                pointer-events: none;
                z-index: 1000;
                animation: sparkleAnimation 1s ease-out forwards;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes sparkleAnimation {
                    0% { opacity: 1; transform: scale(0) rotate(0deg); }
                    100% { opacity: 0; transform: scale(1) rotate(180deg); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(sparkle);
            setTimeout(() => {
                document.body.removeChild(sparkle);
                document.head.removeChild(style);
            }, 1000);
        }
        
        // PPG Functionality
        let ppgStream = null;
        let ppgSession = null;
        let ppgSignalData = []; // Store processed PPG data
        let measurementHistory = [];
        let selectedTimer = 30; // Default 30 seconds
        let timerInterval = null;
        let measurementInterval = null;
        let rrIntervals = []; // Store RR intervals for Master Blueprint analysis
        let measurementStartTime = null; // Track actual measurement start time for accurate duration
        
        // Master Blueprint: HRV Metrics Calculation Functions
        function cleanRRIntervals(rr_ms) {
            // Remove physiologically impossible intervals
            let cleaned = rr_ms.filter(r => r >= 250 && r <= 2000);
            
            // Remove artifacts (>20% change from previous)
            let final = [];
            for (let i = 0; i < cleaned.length; i++) {
                if (i === 0 || Math.abs(cleaned[i] - cleaned[i-1]) <= 0.2 * cleaned[i-1]) {
                    final.push(cleaned[i]);
                }
            }
            
            return final;
        }
        
        function calculateHRVMetrics(rrIntervals) {
            if (rrIntervals.length < 5) {
                return { hr: 0, rmssd: 0, sdnn: 0, artifact_percent: 100 };
            }
            
            const cleaned = cleanRRIntervals(rrIntervals);
            const artifactPercent = ((rrIntervals.length - cleaned.length) / rrIntervals.length * 100).toFixed(1);
            
            if (cleaned.length < 3) {
                return { hr: 0, rmssd: 0, sdnn: 0, artifact_percent: parseFloat(artifactPercent) };
            }
            
            // Mean HR
            const meanRR = cleaned.reduce((a, b) => a + b, 0) / cleaned.length;
            const meanHR = Math.round(60000 / meanRR);
            
            // RMSSD (Root Mean Square of Successive Differences)
            let sumSquaredDiffs = 0;
            for (let i = 0; i < cleaned.length - 1; i++) {
                const diff = cleaned[i + 1] - cleaned[i];
                sumSquaredDiffs += diff * diff;
            }
            const rmssd = Math.sqrt(sumSquaredDiffs / (cleaned.length - 1));
            
            // SDNN (Standard Deviation of NN intervals)
            const meanNN = meanRR;
            const sumSquaredDeviations = cleaned.reduce((sum, rr) => sum + Math.pow(rr - meanNN, 2), 0);
            const sdnn = Math.sqrt(sumSquaredDeviations / (cleaned.length - 1));
            
            return {
                hr: meanHR,
                rmssd: Math.round(rmssd * 10) / 10,
                sdnn: Math.round(sdnn * 10) / 10,
                artifact_percent: parseFloat(artifactPercent)
            };
        }
        
        function updateResultsScreen(metrics) {
            // Core HRV Metrics
            document.getElementById('resultHR').textContent = metrics.hr || '--';
            document.getElementById('resultRMSSD').textContent = metrics.rmssd || '--';
            document.getElementById('resultSDNN').textContent = metrics.sdnn || '--';
            
            // Advanced HRV Metrics
            if (document.getElementById('resultPNN50')) {
                document.getElementById('resultPNN50').textContent = metrics.pnn50 ? metrics.pnn50.toFixed(1) : '--';
            }
            if (document.getElementById('resultLFHF')) {
                document.getElementById('resultLFHF').textContent = metrics.lf_hf_ratio ? metrics.lf_hf_ratio.toFixed(2) : '--';
            }
            if (document.getElementById('resultSD1')) {
                document.getElementById('resultSD1').textContent = metrics.sd1 ? metrics.sd1.toFixed(1) : '--';
            }
            if (document.getElementById('resultSD2')) {
                document.getElementById('resultSD2').textContent = metrics.sd2 ? metrics.sd2.toFixed(1) : '--';
            }
            
            // Morphological Pulse Metrics
            if (document.getElementById('resultPI')) {
                document.getElementById('resultPI').textContent = metrics.PI ? metrics.PI.toFixed(1) : '--';
            }
            if (document.getElementById('resultRI')) {
                document.getElementById('resultRI').textContent = metrics.RI ? metrics.RI.toFixed(1) : '--';
            }
            if (document.getElementById('resultSI')) {
                document.getElementById('resultSI').textContent = metrics.SI ? metrics.SI.toFixed(1) : '--';
            }
            if (document.getElementById('resultDI')) {
                document.getElementById('resultDI').textContent = metrics.DI ? metrics.DI.toFixed(1) : '--';
            }
            if (document.getElementById('resultSDR')) {
                document.getElementById('resultSDR').textContent = metrics.SDR ? metrics.SDR.toFixed(2) : '--';
            }
            if (document.getElementById('resultPAV')) {
                document.getElementById('resultPAV').textContent = metrics.PAV ? metrics.PAV.toFixed(1) + '%' : '--';
            }
            
            updateQualityIndicator(metrics.artifact_percent);
            updateVascularIndicesChart(metrics);
            updateClinicalAlertsDisplay(metrics);
            
            // Store for saving
            currentSessionData = {
                rr_intervals: rrIntervals,
                duration: selectedTimer,
                metrics: metrics
            };
        }
        
        function setTimer(seconds) {
            console.log(`üïí Timer selection clicked: ${seconds} seconds`);
            selectedTimer = seconds;
            
            // Update button styling
            document.querySelectorAll('.timer-option').forEach(btn => {
                btn.style.background = 'rgba(248,187,217,0.2)';
                btn.style.border = '2px solid #f8bbd9';
                btn.classList.remove('active');
            });
            
            // Highlight selected button - using globalThis.event for cross-browser compatibility
            const clickedButton = globalThis.event ? globalThis.event.target : document.querySelector('.timer-option.active');
            if (clickedButton) {
                clickedButton.style.background = 'linear-gradient(45deg, #f8bbd9, #fce4ec)';
                clickedButton.style.border = '2px solid #f48fb1';
                clickedButton.classList.add('active');
            }
            
            console.log(`‚úÖ Timer set to ${seconds} seconds, selectedTimer = ${selectedTimer}`);
        }
        
        // Helper function to update vascular indices chart
        function updateVascularIndicesChart(metrics) {
            if (window.vascularIndicesChart && metrics) {
                const timestamp = new Date().toLocaleTimeString();
                const chart = window.vascularIndicesChart;
                
                // Add new data point
                chart.data.labels.push(timestamp);
                
                // Update each dataset
                if (metrics.PI !== undefined) chart.data.datasets[0].data.push(metrics.PI);
                if (metrics.RI !== undefined) chart.data.datasets[1].data.push(metrics.RI);  
                if (metrics.SI !== undefined) chart.data.datasets[2].data.push(metrics.SI);
                if (metrics.DI !== undefined) chart.data.datasets[3].data.push(metrics.DI);
                if (metrics.SDR !== undefined) chart.data.datasets[4].data.push(metrics.SDR);
                if (metrics.PAV !== undefined) chart.data.datasets[5].data.push(metrics.PAV);
                
                // Keep only last 20 points
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets.forEach(dataset => dataset.data.shift());
                }
                
                chart.update('none');
            }
        }
        
        // Helper function to update clinical alerts display
        function updateClinicalAlertsDisplay(metrics) {
            const alertsContainer = document.getElementById('clinicalAlertsContainer');
            if (!alertsContainer || !metrics) return;
            
            // Clinical thresholds
            const thresholds = {
                HR: [50, 100],
                RMSSD: [20, 150], 
                PI: [2, 15],
                SI: [4, 10],
                RI: [30, 80]
            };
            
            let normalCount = 0, warningCount = 0, criticalCount = 0;
            let alerts = [];
            
            // Check each metric against thresholds
            Object.entries(thresholds).forEach(([metric, [low, high]]) => {
                const value = metrics[metric];
                if (value !== undefined && value !== null) {
                    if (value < low) {
                        criticalCount++;
                        alerts.push(`üö® ${metric} LOW: ${value} (normal: ${low}-${high})`);
                    } else if (value > high) {
                        warningCount++;
                        alerts.push(`‚ö†Ô∏è ${metric} HIGH: ${value} (normal: ${low}-${high})`);
                    } else {
                        normalCount++;
                        alerts.push(`‚úÖ ${metric} NORMAL: ${value}`);
                    }
                }
            });
            
            // Update clinical status chart
            if (window.clinicalStatusChart) {
                window.clinicalStatusChart.data.datasets[0].data = [normalCount, warningCount, criticalCount];
                window.clinicalStatusChart.update('none');
            }
            
            // Update alerts display
            alertsContainer.innerHTML = '';
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.style.cssText = 'padding: 8px; border-radius: 4px; margin-bottom: 4px;';
                
                if (alert.includes('‚úÖ')) {
                    alertDiv.style.background = 'rgba(76,175,80,0.1)';
                    alertDiv.style.borderLeft = '4px solid #4caf50';
                } else if (alert.includes('‚ö†Ô∏è')) {
                    alertDiv.style.background = 'rgba(255,152,0,0.1)';
                    alertDiv.style.borderLeft = '4px solid #ff9800';
                } else if (alert.includes('üö®')) {
                    alertDiv.style.background = 'rgba(244,67,54,0.1)';
                    alertDiv.style.borderLeft = '4px solid #f44336';
                }
                
                alertDiv.innerHTML = `
                    <div style="font-weight: bold; font-size: 0.85rem;">${alert}</div>
                    <div style="font-size: 0.75rem; color: #4a4a4a;">Real-time monitoring active</div>
                `;
                alertsContainer.appendChild(alertDiv);
            });
        }
        
        async function startPPGMeasurement() {
            console.log('üöÄ Starting PPG measurement...');
            
            // Prevent multiple simultaneous measurements
            if (ppgStream && ppgSession) {
                console.log('‚ö†Ô∏è Measurement already in progress');
                return;
            }
            
            // Stop any existing measurement first to prevent conflicts
            if (measurementInterval) {
                clearInterval(measurementInterval);
                measurementInterval = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Reset data arrays and timing
            ppgBuffer = [];
            ppgSignalData = [];
            measurementStartTime = Date.now(); // Record actual start time
            console.log('üïí Measurement start time recorded:', new Date(measurementStartTime).toLocaleTimeString());
            
            // Clear previous measurement data using consolidated function
            clearPPGCharts();
            
            try {
                console.log('üì∑ Requesting camera access...');
                // Request camera access
                ppgStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use rear camera for flashlight access
                        width: { ideal: 320 },
                        height: { ideal: 240 },
                        frameRate: { ideal: 60, min: 30 }, // üéØ High frame rate for blood pulse detection
                        aspectRatio: { ideal: 1.33 }
                    } 
                });
                
                console.log('‚úÖ Camera access granted');
                const video = document.getElementById('ppgVideo');
                video.srcObject = ppgStream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.addEventListener('loadedmetadata', resolve, { once: true });
                    video.play();
                });
                
                // üî¶ Try to enable flashlight/torch for better PPG signal
                try {
                    const track = ppgStream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    if (capabilities.torch) {
                        await track.applyConstraints({ 
                            advanced: [{ torch: true }] 
                        });
                        console.log('üî¶ Flashlight enabled for better PPG signal!');
                    } else {
                        console.log('‚ö†Ô∏è Flashlight not available - use manual flashlight for best results');
                    }
                } catch (torchError) {
                    console.log('‚ö†Ô∏è Could not enable flashlight:', torchError.message);
                }
                
                console.log('üîó Starting PPG session with backend...');
                // Start PPG session with backend
                const response = await fetch('http://127.0.0.1:5000/api/ppg/start-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    ppgSession = await response.json();
                    console.log('‚úÖ PPG session started:', ppgSession);
                    
                    // Update UI
                    document.getElementById('startPPG').style.display = 'none';
                    document.getElementById('stopPPG').style.display = 'inline-block';
                    document.getElementById('timerSelection').style.display = 'none';
                    document.getElementById('timerDisplay').style.display = 'block';
                    document.getElementById('ppgVisualization').style.display = 'block';
                    document.getElementById('heartRateStatus').textContent = 'Place finger on camera lens...';
                    
                    console.log('üéØ UI updated, timer value:', selectedTimer);
                    
                    // Initialize PPG visualization charts
                    console.log('üìä Initializing PPG charts...');
                    setTimeout(() => {
                        initializePPGChart();
                        
                        // Verify initialization worked
                        setTimeout(() => {
                            if (!ppgSignalChart) {
                                console.error('‚ùå PPG chart failed to initialize! Retrying...');
                                initializePPGChart();
                            } else {
                                console.log('‚úÖ PPG chart initialized successfully');
                            }
                        }, 500);
                    }, 100);
                    
                    // Start timer countdown
                    console.log('‚è∞ Starting timer countdown...');
                    startTimer();
                    
                    // Start heart rate detection
                    console.log('üíì Starting heart rate detection...');
                    startHeartRateDetection();
                } else {
                    throw new Error(`Failed to start PPG session: ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå PPG Error:', error);
                document.getElementById('heartRateStatus').textContent = 'Camera access denied or unavailable';
                updateStatus('Camera access is required for heart rate monitoring. Please allow camera permission and try again.', 'error');
                updateStatus('Camera access is required for heart rate monitoring. Please allow camera permission and try again.', 'error');
            }
        }
        
        function startTimer() {
            let timeLeft = selectedTimer;
            const totalTime = selectedTimer;
            
            console.log('‚è∞ Timer starting with duration:', selectedTimer, 'seconds');
            
            // Check if timer elements exist
            const timerCountEl = document.getElementById('timerCount');
            const timerProgressEl = document.getElementById('timerProgress');
            
            if (!timerCountEl) {
                console.error('‚ùå timerCount element not found!');
                return;
            }
            if (!timerProgressEl) {
                console.error('‚ùå timerProgress element not found!');
                return;
            }
            
            timerCountEl.textContent = timeLeft;
            timerProgressEl.style.width = '100%';
            console.log('‚úÖ Timer initialized with', timeLeft, 'seconds');
            
            timerInterval = setInterval(() => {
                timeLeft--;
                console.log('‚è∞ Timer tick:', timeLeft);
                
                timerCountEl.textContent = timeLeft;
                
                // Update progress bar
                const progress = (timeLeft / totalTime) * 100;
                timerProgressEl.style.width = progress + '%';
                
                // Update status messages
                if (timeLeft > 20) {
                    document.getElementById('heartRateStatus').textContent = 'Place finger on camera lens...';
                } else if (timeLeft > 10) {
                    document.getElementById('heartRateStatus').textContent = 'Keep finger steady... measuring...';
                } else if (timeLeft > 0) {
                    document.getElementById('heartRateStatus').textContent = 'Almost done! Hold steady...';
                }
                
                if (timeLeft <= 0) {
                    console.log('‚è∞ Timer completed - stopping PPG and showing results!');
                    clearInterval(timerInterval);
                    timerInterval = null;
                    
                    // STOP PPG recording immediately when timer hits 0
                    if (measurementInterval) {
                        clearInterval(measurementInterval);
                        measurementInterval = null;
                        console.log('‚úÖ PPG recording automatically stopped');
                    }
                    
                    // Stop camera stream
                    if (ppgStream) {
                        ppgStream.getTracks().forEach(track => track.stop());
                        console.log('üé• Camera stream stopped');
                    }
                    
                    // Update UI to show PPG is stopped
                    document.getElementById('startPPG').style.display = 'inline-block';
                    document.getElementById('stopPPG').style.display = 'none';
                    document.getElementById('timerDisplay').style.display = 'none';
                    document.getElementById('timerSelection').style.display = 'block';
                    document.getElementById('ppgVisualization').style.display = 'none';
                    
                    // Process and show results immediately
                    completeMeasurement();
                }
            }, 1000);
        }
        
        async function completeMeasurement() {
            console.log('üîÑ COMPLETE MEASUREMENT STARTED');
            console.log('================================');
            
            document.getElementById('heartRateStatus').textContent = 'Processing comprehensive metrics... ü©ª';
            
            // Calculate actual measurement duration
            const actualElapsedTime = measurementStartTime ? (Date.now() - measurementStartTime) / 1000 : selectedTimer;
            console.log(`üïí TIMING: Expected ${selectedTimer}s, Actual ${actualElapsedTime.toFixed(1)}s elapsed`);
            
            // Store actual duration for accurate PPG waveform timing
            window.actualMeasurementDuration = actualElapsedTime;
            
            // üîç DIAGNOSTIC CHECKS
            console.log('üîç Diagnostic Information:');
            console.log(`   PPG Session: ${ppgSession ? `‚úÖ ID: ${ppgSession.session_id}` : '‚ùå NULL'}`);
            console.log(`   PPG Data Length: ${ppgSignalData.length} samples`);
            console.log(`   RR Intervals: ${rrIntervals.length} intervals`);
            console.log(`   Measurement Start: ${measurementStartTime ? new Date(measurementStartTime).toLocaleTimeString() : '‚ùå Not recorded'}`);
            
            if (!ppgSession) {
                console.error('‚ùå CRITICAL ERROR: ppgSession is null - cannot fetch comprehensive metrics');
                console.log('üí° This usually means the PPG session failed to start or was not created properly');
            }
            
            try {
                // ü©ª FETCH ALL 11 COMPREHENSIVE CLINICAL METRICS from backend
                console.log('ü©ª Fetching comprehensive clinical metrics from backend...');
                const response = await fetch(`http://127.0.0.1:5000/api/ppg/dashboard-metrics/${ppgSession.session_id}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data?.comprehensive_metrics) {
                        const comprehensive = result.data.comprehensive_metrics;
                        
                        console.log('üéâ COMPREHENSIVE METRICS RECEIVED:', comprehensive.status);
                        if (comprehensive.status === 'success') {
                            // Map comprehensive metrics to updateResultsScreen format
                            const metrics = {
                                // ===== STEP 4: HR AND HRV METRICS (9 METRICS) =====
                                hr: comprehensive.HR || 0,
                                rmssd: comprehensive.RMSSD || 0,
                                sdnn: comprehensive.SDNN || 0,
                                pnn50: comprehensive.pNN50 || 0,
                                lf: comprehensive.LF || 0,           // Individual LF power
                                hf: comprehensive.HF || 0,           // Individual HF power
                                lf_hf_ratio: comprehensive['LF/HF'] || 0,  // LF/HF ratio
                                sd1: comprehensive.SD1 || 0,
                                sd2: comprehensive.SD2 || 0,
                                
                                // ===== STEP 5: MORPHOLOGICAL PULSE METRICS (6 METRICS) =====
                                PI: comprehensive.PI || 0,
                                RI: comprehensive.RI || 0,
                                SI: comprehensive.SI || 0,
                                DI: comprehensive.DI || 0,
                                SDR: comprehensive.SDR || 0,
                                PAV: comprehensive.PAV || 0,
                                
                                // Meta
                                artifact_percent: 100 - (comprehensive.signal_quality || 0) * 100,
                                status: 'success',
                                total_beats: comprehensive.total_beats || 0,
                                analysis_duration: comprehensive.analysis_duration || 0
                            };
                            
                            console.log('üéØ UPDATING RESULTS SCREEN WITH ALL 11 COMPREHENSIVE METRICS!');
                            console.log('   HR:', metrics.hr, 'SDNN:', metrics.sdnn, 'PI:', metrics.PI);
                            
                            updateResultsScreen(metrics);
                            
                            setTimeout(() => {
                                stopPPGMeasurement();
                                showScreen('results');
                            }, 1500);
                            return;
                        }
                    }
                }
                
                // Fallback to legacy calculation if comprehensive metrics not available
                console.log('‚ö†Ô∏è Comprehensive metrics not available, using fallback calculation...');
                if (rrIntervals.length > 0) {
                    const metrics = calculateHRVMetrics(rrIntervals);
                    updateResultsScreen(metrics);
                    
                    setTimeout(() => {
                        stopPPGMeasurement();
                        showScreen('results');
                    }, 1500);
                } else {
                    // NO SIMULATED DATA - Only use real PPG measurements
                    console.log('‚ö†Ô∏è No real PPG data available - measurement incomplete');
                    document.getElementById('heartRateStatus').innerHTML = '‚ö†Ô∏è No valid PPG data - please ensure finger covers camera with good lighting';
                    
                    // Still show Results screen even with no valid data
                    updateResultsScreen({
                        hr: 0,
                        rmssd: 0,
                        sdnn: 0,
                        pnn50: 0,
                        lf: 0,
                        hf: 0,
                        lf_hf_ratio: 0,
                        sd1: 0,
                        sd2: 0,
                        PI: 0,
                        RI: 0,
                        SI: 0,
                        DI: 0,
                        CTI: 0,
                        DTI: 0
                    });
                    
                    setTimeout(() => {
                        stopPPGMeasurement();
                        showScreen('results');
                    }, 1500);
                }
                
            } catch (error) {
                console.error('‚ùå Error fetching comprehensive metrics:', error);
                // Fallback to legacy calculation
                if (rrIntervals.length > 0) {
                    const metrics = calculateHRVMetrics(rrIntervals);
                    updateResultsScreen(metrics);
                    
                    setTimeout(() => {
                        stopPPGMeasurement();
                        showScreen('results');
                    }, 1500);
                } else {
                    document.getElementById('heartRateStatus').innerHTML = '‚ö†Ô∏è Unable to process results';
                    
                    // Still show Results screen even with error
                    updateResultsScreen({
                        hr: 0,
                        rmssd: 0,
                        sdnn: 0,
                        pnn50: 0,
                        lf: 0,
                        hf: 0,
                        lf_hf_ratio: 0,
                        sd1: 0,
                        sd2: 0,
                        PI: 0,
                        RI: 0,
                        SI: 0,
                        DI: 0,
                        CTI: 0,
                        DTI: 0
                    });
                    
                    setTimeout(() => {
                        stopPPGMeasurement();
                        showScreen('results');
                    }, 1500);
                }
            }
        }
        
        function stopPPGMeasurement() {
            // Clear intervals
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (measurementInterval) {
                clearInterval(measurementInterval);
                measurementInterval = null;
            }
            
            if (ppgStream) {
                ppgStream.getTracks().forEach(track => track.stop());
                ppgStream = null;
            }
            
            document.getElementById('startPPG').style.display = 'inline-block';
            document.getElementById('stopPPG').style.display = 'none';
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('timerSelection').style.display = 'block';
            document.getElementById('ppgVisualization').style.display = 'none';
            document.getElementById('heartRateStatus').textContent = 'Ready for next measurement';
            
            // Store PPG data for advanced analysis before stopping
            if (ppgSignalData && ppgSignalData.length > 0) {
                storePPGDataForAnalysis(ppgSignalData);
                console.log(`üìä PPG measurement complete: ${ppgSignalData.length} samples collected`);
                
                // üöÄ AUTOMATICALLY TRIGGER COMPREHENSIVE ANALYSIS AND CHART PLOTTING
                console.log('üöÄ Auto-triggering comprehensive analysis for automatic chart plotting...');
                setTimeout(() => {
                    performAdvancedAnalysis();
                }, 1000); // Small delay to ensure UI is ready
            }
            
            // Stop backend session
            if (ppgSession) {
                fetch(`http://127.0.0.1:5000/api/ppg/stop-session/${ppgSession.session_id}`, {
                    method: 'POST'
                });
                ppgSession = null;
            }
        }
        
        // ========================================
        // ü´Ä CONSOLIDATED PPG WAVEFORM CODE SECTION
        // ========================================
        
        // ===== GLOBAL VARIABLES =====
        let ppgSignalChart, hrTrendChart, rrIntervalChart, qualityTrendChart;
        let ppgBuffer = [];       // Holds last 5 seconds of green-channel intensity values
        let hrTrendData = [], rrIntervalData = [], qualityHistoryData = [];
        
        // PPG Chart Clearing Function
        function clearPPGCharts() {
            console.log('üîÑ Clearing PPG chart data for new measurement...');
            if (ppgSignalChart) {
                ppgSignalChart.data.labels = [];
                ppgSignalChart.data.datasets[0].data = [];
                ppgSignalChart.data.datasets[1].data = [];
                ppgSignalChart.data.datasets[2].data = [];
                ppgSignalChart.update('none');
                console.log('‚úÖ PPG chart data cleared');
            }
            
            // Clear buffers
            ppgBuffer = [];
            ppgSignalData = [];
            
            // Clear status display
            const ppgStatus = document.getElementById('ppgStatus');
            if (ppgStatus) {
                ppgStatus.innerHTML = 'üì° PPG waveform display ready - waiting for real camera data...';
                ppgStatus.style.color = '#4CAF50';
            }
        }
        
        // üîß PPG WAVEFORM DIAGNOSTIC FUNCTION
        function diagnosePPGWaveform() {
            console.log('üîß PPG Waveform Diagnostic Report:');
            console.log('=====================================');
            
            // Check chart initialization
            console.log('üìä Chart Status:', ppgSignalChart ? '‚úÖ Initialized' : '‚ùå Not initialized');
            
            // Check canvas element
            const canvas = document.getElementById('ppgSignalChart');
            console.log('üñºÔ∏è Canvas Element:', canvas ? '‚úÖ Found' : '‚ùå Not found');
            if (canvas) {
                console.log(`   - Dimensions: ${canvas.width}x${canvas.height}`);
                console.log(`   - Display: ${getComputedStyle(canvas).display}`);
                console.log(`   - Visibility: ${getComputedStyle(canvas).visibility}`);
            }
            
            // Check PPG buffers
            console.log('üìà PPG Buffer Size:', ppgBuffer.length);
            console.log('üìä Signal Data Size:', ppgSignalData.length);
            if (ppgBuffer.length > 0) {
                console.log(`   - Buffer Range: ${Math.min(...ppgBuffer).toFixed(1)} - ${Math.max(...ppgBuffer).toFixed(1)}`);
                console.log(`   - Last 5 values: [${ppgBuffer.slice(-5).map(v => v.toFixed(1)).join(', ')}]`);
            }
            
            // Check video stream
            console.log('üì∑ Video Stream:', ppgStream ? '‚úÖ Active' : '‚ùå Not active');
            const video = document.getElementById('ppgVideo');
            if (video) {
                console.log(`   - Video Ready State: ${video.readyState} (4=HAVE_ENOUGH_DATA)`);
                console.log(`   - Video Paused: ${video.paused}`);
                console.log(`   - Video Dimensions: ${video.videoWidth}x${video.videoHeight}`);
            }
            
            // Check measurement state
            console.log('‚ö° Measurement Interval:', measurementInterval ? '‚úÖ Running' : '‚ùå Not running');
            console.log('üîó PPG Session:', ppgSession ? '‚úÖ Connected' : '‚ùå Not connected');
            
            // üïí TIMING DIAGNOSTICS
            console.log('üïí TIMING STATUS:');
            console.log(`   - Selected Timer: ${selectedTimer}s`);
            console.log(`   - Measurement Start: ${measurementStartTime ? new Date(measurementStartTime).toLocaleTimeString() : 'Not recorded'}`);
            if (measurementStartTime) {
                const currentElapsed = (Date.now() - measurementStartTime) / 1000;
                console.log(`   - Current Elapsed: ${currentElapsed.toFixed(1)}s`);
            }
            console.log(`   - Actual Duration: ${window.actualMeasurementDuration ? window.actualMeasurementDuration.toFixed(1) + 's' : 'Not available'}`);
            if (ppgSignalData.length > 0) {
                const assumedDuration60fps = ppgSignalData.length / 60;
                const actualDurationIfAvailable = window.actualMeasurementDuration || selectedTimer;
                const realSamplingRate = ppgSignalData.length / actualDurationIfAvailable;
                console.log(`   - Signal Data: ${ppgSignalData.length} samples`);
                console.log(`   - Wrong Calc (60fps): ${assumedDuration60fps.toFixed(1)}s`);
                console.log(`   - Correct Calc: ${actualDurationIfAvailable.toFixed(1)}s`);
                console.log(`   - Real Sampling Rate: ${realSamplingRate.toFixed(1)} FPS`);
                console.log(`   - Timing Error: ${((assumedDuration60fps / actualDurationIfAvailable - 1) * 100).toFixed(1)}% off`);
            }
            
            console.log('=====================================');
            
            // Test chart update
            if (ppgSignalChart && ppgBuffer.length > 0) {
                console.log('üß™ Testing chart update...');
                try {
                    updateChartFromBuffer();
                    console.log('‚úÖ Chart update successful');
                } catch (error) {
                    console.error('‚ùå Chart update failed:', error);
                }
            }
        }
        
        // üß™ TEST PPG TIMING FIX
        function testPPGTimingFix() {
            console.log('üß™ Testing PPG Timing Fix with Mock Data...');
            
            // Create mock time series data like backend would send
            const mockTimeSeries = {
                raw_ppg: Array.from({length: 1800}, () => Math.random() * 100 + 150), // 1800 samples = 30s at 60fps (wrong assumption)
                processed_ppg: null,
                timestamps: null
            };
            
            // Simulate 30-second measurement
            selectedTimer = 30;
            window.actualMeasurementDuration = 30; // Simulate actual duration
            
            console.log(`üìä Mock Data: ${mockTimeSeries.raw_ppg.length} samples for ${selectedTimer}s measurement`);
            
            // Test the timing calculation
            const actualDurationSeconds = window.actualMeasurementDuration || selectedTimer;
            const totalSamples = mockTimeSeries.raw_ppg.length;
            const actualSamplingRate = totalSamples / actualDurationSeconds;
            
            console.log(`üîß TIMING CALCULATION:`);
            console.log(`   - Expected Duration: ${selectedTimer}s`);
            console.log(`   - Actual Duration: ${actualDurationSeconds}s`);
            console.log(`   - Total Samples: ${totalSamples}`);
            console.log(`   - Calculated Sampling Rate: ${actualSamplingRate.toFixed(1)} FPS`);
            console.log(`   - OLD (wrong) time window: ${(totalSamples / 60).toFixed(1)}s`);
            console.log(`   - NEW (correct) time window: ${actualDurationSeconds}s`);
            
            // Test time labels generation
            const correctTimeLabels = [];
            for (let i = 0; i < totalSamples; i++) {
                correctTimeLabels.push((i / actualSamplingRate).toFixed(1));
            }
            
            console.log(`‚è±Ô∏è Time Labels Sample (first 10): [${correctTimeLabels.slice(0, 10).join(', ')}]`);
            console.log(`‚è±Ô∏è Time Labels Sample (last 10): [${correctTimeLabels.slice(-10).join(', ')}]`);
            console.log(`‚úÖ Timing fix test complete - should show 30.0s max time instead of ${(totalSamples/60).toFixed(1)}s`);
        }
        
        // üîç COMPREHENSIVE VERIFICATION FUNCTION
        function verifyAllFixes() {
            console.log('üîç COMPREHENSIVE VERIFICATION REPORT:');
            console.log('=====================================');
            
            // 1. Timing Fix Verification
            console.log('1. üïí TIMING FIX STATUS:');
            const mockSamples = 1800; // 30s * 60fps assumption = wrong
            const correctDuration = 30; // actual 30 seconds
            const oldCalculation = mockSamples / 60; // Wrong: 30 seconds of data shows as 30s
            const newCalculation = correctDuration; // Correct: 30 seconds shows as 30s
            
            console.log(`   ‚ùå OLD (broken): ${mockSamples} samples √∑ 60fps = ${oldCalculation}s displayed`);
            console.log(`   ‚úÖ NEW (fixed): Uses actual duration = ${newCalculation}s displayed`);
            console.log(`   üéØ Fix Status: ${oldCalculation !== newCalculation ? 'FIXED ‚úÖ' : 'NEEDS ATTENTION ‚ùå'}`);
            
            // 2. PPG Data Storage Button
            console.log('2. üìä PPG DATA STORAGE BUTTON:');
            const storageBtn = document.getElementById('addToPPGStorageBtn');
            console.log(`   Button Exists: ${storageBtn ? '‚úÖ YES' : '‚ùå NO'}`);
            console.log(`   Function Exists: ${typeof addToPPGDataStorage === 'function' ? '‚úÖ YES' : '‚ùå NO'}`);
            
            // 3. Firebase Storage Enhancement
            console.log('3. üî• FIREBASE STORAGE:');
            console.log(`   Firebase DB: ${window.firebaseDB ? '‚úÖ Available' : '‚ö†Ô∏è Not initialized'}`);
            console.log(`   Comprehensive Collection: ppg_comprehensive_storage`);
            console.log(`   Fallback: Local storage with comprehensive data`);
            
            // 4. PPG Timeline Enhancement
            console.log('4. üóÑÔ∏è PPG TIMELINE:');
            const timeline = document.getElementById('ppgDataTimeline');
            console.log(`   Timeline Element: ${timeline ? '‚úÖ Found' : '‚ùå Missing'}`);
            console.log(`   Enhanced Display: Shows comprehensive metadata`);
            
            // 5. Comprehensive Metadata
            console.log('5. üìã COMPREHENSIVE METADATA:');
            console.log(`   ‚úÖ Timing info: actual vs expected duration`);
            console.log(`   ‚úÖ Raw PPG data: signal samples and sampling rate`);
            console.log(`   ‚úÖ Patterns: morphology, baselines, artifacts`);
            console.log(`   ‚úÖ Context: measurement conditions and notes`);
            console.log(`   ‚úÖ Device info: camera specs and technical data`);
            
            console.log('=====================================');
            console.log('üìä SUMMARY: PPG timing fix + comprehensive storage implemented!');
            console.log('üß™ TEST: Run a 30s measurement - should show 30.0s, not 4.7s');
            console.log('üíæ STORAGE: "Add to PPG Data Storage" button saves comprehensive data');
            console.log('üóÑÔ∏è TIMELINE: Enhanced display shows all metadata in storage box');
        }
        
        // üß™ REAL-TIME TIMER VERIFICATION
        function verifyRealTimeTimer() {
            console.log('üß™ VERIFYING PPG WAVEFORM TIMER IS REAL-TIME:');
            console.log('===========================================');
            
            // Start a mock measurement to test timing
            measurementStartTime = Date.now();
            ppgBuffer = [];
            
            console.log('‚è∞ Starting real-time timer verification...');
            console.log(`üìÖ Start Time: ${new Date(measurementStartTime).toLocaleTimeString()}`);
            
            let testInterval = setInterval(() => {
                // Simulate PPG data points
                ppgBuffer.push(Math.random() * 100 + 150);
                
                // Calculate elapsed time
                const currentElapsed = (Date.now() - measurementStartTime) / 1000;
                
                // Create time labels using current logic
                const labels = ppgBuffer.map((_, i) => {
                    const timePerSample = currentElapsed / ppgBuffer.length;
                    const realTimeForThisSample = i * timePerSample;
                    return realTimeForThisSample.toFixed(1);
                });
                
                const lastTimeLabel = labels[labels.length - 1];
                console.log(`üìä Real Elapsed: ${currentElapsed.toFixed(1)}s | Buffer: ${ppgBuffer.length} samples | Last Label: ${lastTimeLabel}s | Difference: ${(currentElapsed - parseFloat(lastTimeLabel)).toFixed(1)}s`);
                
                // Stop after 10 seconds
                if (currentElapsed >= 10) {
                    clearInterval(testInterval);
                    console.log('‚úÖ REAL-TIME VERIFICATION COMPLETE');
                    console.log(`üéØ Timer accuracy: ${Math.abs(currentElapsed - parseFloat(lastTimeLabel)) < 0.5 ? 'ACCURATE ‚úÖ' : 'NEEDS FIXING ‚ùå'}`);
                    console.log('===========================================');
                }
            }, 1000/60); // 60 FPS like real PPG
        }
        
        // üîç RESULTS PROCESSING DIAGNOSTICS
        function diagnoseResultsProcessing() {
            console.log('üîç DIAGNOSING RESULTS PROCESSING ISSUES:');
            console.log('=====================================');
            
            // Check if backend is running
            console.log('üåê Testing backend connection...');
            
            fetch('http://127.0.0.1:5000/api/ppg/start-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                console.log(`üì° Backend Response Status: ${response.status} ${response.ok ? '‚úÖ' : '‚ùå'}`);
                return response.json();
            })
            .then(data => {
                console.log('üìä Backend Data:', data);
                if (data.session_id) {
                    console.log('‚úÖ Backend is working - session created');
                    // Test comprehensive metrics endpoint
                    fetch(`http://127.0.0.1:5000/api/ppg/dashboard-metrics/${data.session_id}`)
                    .then(resp => {
                        console.log(`ü©ª Comprehensive Metrics Endpoint: ${resp.status} ${resp.ok ? '‚úÖ' : '‚ùå'}`);
                        return resp.json();
                    })
                    .then(metrics => {
                        console.log('ü©ª Comprehensive Metrics Data:', metrics);
                    })
                    .catch(err => console.log('‚ùå Comprehensive Metrics Error:', err));
                }
            })
            .catch(error => {
                console.log('‚ùå Backend Connection Failed:', error);
                console.log('üí° SOLUTION: Start the backend server first!');
                console.log('   Run: python backend/app.py');
            });
            
            // Check critical elements exist
            console.log('üñºÔ∏è Checking UI Elements:');
            const criticalElements = ['results', 'addToPPGStorageBtn', 'resultHR', 'resultRMSSD'];
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`   ${id}: ${element ? '‚úÖ EXISTS' : '‚ùå MISSING'}`);
            });
            
            console.log('=====================================');
        }
        
        // Make diagnostic functions globally available
        window.diagnosePPGWaveform = diagnosePPGWaveform;
        window.testPPGTimingFix = testPPGTimingFix;
        window.verifyAllFixes = verifyAllFixes;
        window.verifyRealTimeTimer = verifyRealTimeTimer;
        window.diagnoseResultsProcessing = diagnoseResultsProcessing;
        window.addToPPGDataStorage = addToPPGDataStorage;
        
        // ===== INITIALIZE PPG CHART =====
        function initializePPGChart() {
            const ctx = document.getElementById('ppgSignalChart');
            if (!ctx) {
                console.error('‚ùå PPG canvas not found! Looking for element with ID: ppgSignalChart');
                // List all canvas elements for debugging
                const canvases = document.querySelectorAll('canvas');
                console.log('üîç Available canvas elements:', Array.from(canvases).map(c => c.id || 'no-id'));
                return;
            }
            
            console.log('‚úÖ Found PPG canvas, initializing chart...');
            
            // Destroy existing chart if it exists
            if (ppgSignalChart) {
                ppgSignalChart.destroy();
            }
            
            ppgSignalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Live PPG (Green Channel)',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Processed Signal',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Detected Peaks',
                            data: [],
                            borderColor: '#FF5722',
                            backgroundColor: '#FF5722',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (seconds)' },
                            ticks: { stepSize: 1 }
                        },
                        y: {
                            title: { display: true, text: 'PPG Amplitude' },
                            min: 50,
                            max: 200
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 10 } } }
                    }
                }
            });
        }
        
        // ===== LOCAL PEAK DETECTION (GREEN CHANNEL) =====
        function detectLocalPeaks(buffer) {
            const peaks = [];
            // Use actual camera capture rate (60 FPS is frontend capture, not backend analysis)
            const localCaptureRate = 60; // This is for local buffer visualization only
            for (let i = 1; i < buffer.length - 1; i++) {
                // Green channel typically has better contrast, adjust threshold accordingly
                if (buffer[i] > buffer[i - 1] && buffer[i] > buffer[i + 1] && buffer[i] > 50) {
                    peaks.push({ x: i / localCaptureRate, y: buffer[i] }); // local buffer visualization
                }
            }
            return peaks;
        }
        
        // ===== UPDATE CHART WITH LOCAL BUFFER =====
        function updateChartFromBuffer() {
            if (!ppgSignalChart) {
                console.warn('‚ö†Ô∏è PPG chart not initialized yet, skipping buffer update');
                return;
            }
            
            if (ppgBuffer.length === 0) {
                console.warn('‚ö†Ô∏è PPG buffer is empty, no data to display');
                return;
            }
            
            // üîß FIX: Use ACTUAL CLOCK TIME for labels (completely independent of FPS)
            const currentElapsed = measurementStartTime ? (Date.now() - measurementStartTime) / 1000 : 0;
            
            // Create time labels based on REAL ELAPSED TIME, not frame count or FPS
            const labels = ppgBuffer.map((_, i) => {
                // Calculate what time this sample SHOULD represent based on real elapsed time
                const timePerSample = currentElapsed / ppgBuffer.length;
                const realTimeForThisSample = i * timePerSample;
                return realTimeForThisSample.toFixed(1);
            });
            const peaks = detectLocalPeaks(ppgBuffer);

            // Debug logging every ~60 samples (roughly once per second) 
            if (ppgBuffer.length % 60 === 0) {
                const displayTime = labels.length > 0 ? labels[labels.length - 1] : '0.0';
                const realFPS = currentElapsed > 0 ? ppgBuffer.length / currentElapsed : 0;
                console.log(`üìä PPG Live Waveform: ${ppgBuffer.length} samples, ${currentElapsed.toFixed(1)}s REAL TIME, ${displayTime}s displayed, ${realFPS.toFixed(1)} actual FPS, range: ${Math.min(...ppgBuffer).toFixed(1)}-${Math.max(...ppgBuffer).toFixed(1)}, peaks: ${peaks.length}`);
            }

            ppgSignalChart.data.labels = labels;
            ppgSignalChart.data.datasets[0].data = [...ppgBuffer]; // Clone array to avoid reference issues
            ppgSignalChart.data.datasets[2].data = [...peaks]; // Clone peaks array
            
            try {
                ppgSignalChart.update('none');
            } catch (error) {
                console.error('‚ùå Error updating PPG chart:', error);
            }
        }
        
        // PPG Chart Update Function
        function updatePPGCharts(metrics) {
            if (!metrics || !metrics.time_series) {
                console.log('‚ö†Ô∏è No PPG time series data available');
                return;
            }
            
            const timeSeries = metrics.time_series;
            const currentTime = new Date();
            
            console.log('üìä Updating PPG charts with data:', {
                raw_ppg_length: timeSeries.raw_ppg ? timeSeries.raw_ppg.length : 0,
                processed_ppg_length: timeSeries.processed_ppg ? timeSeries.processed_ppg.length : 0,
                sample_values: timeSeries.raw_ppg ? timeSeries.raw_ppg.slice(-5) : []
            });
            
            // Update PPG Signal Chart (REPLACE data - only current measurement, no previous sessions)
            if (ppgSignalChart && timeSeries.raw_ppg) {
                // üîß FIX: Use ACTUAL measurement duration instead of assuming 60 FPS
                const actualDurationSeconds = window.actualMeasurementDuration || selectedTimer || 30; // Use the real measured time
                const totalSamples = timeSeries.raw_ppg.length;
                const actualSamplingRate = totalSamples / actualDurationSeconds; // Calculate real sampling rate
                
                console.log(`üïí TIMING FIX: Expected ${selectedTimer}s, Used ${actualDurationSeconds.toFixed(1)}s ACTUAL, ${totalSamples} samples, ${actualSamplingRate.toFixed(1)} real FPS`);
                
                // Create time labels based on ACTUAL duration (not assumed 60fps)
                const actualTimeLabels = [];
                for (let i = 0; i < totalSamples; i++) {
                    const realTimeSeconds = (i / actualSamplingRate).toFixed(1); // Use actual sampling rate
                    actualTimeLabels.push(realTimeSeconds);
                }
                
                // Use REAL measurement data only - no synthetic/test data
                ppgSignalChart.data.labels = actualTimeLabels;
                ppgSignalChart.data.datasets[0].data = timeSeries.raw_ppg;
                
                const timeWindowSeconds = actualDurationSeconds; // Use actual timer duration
                console.log(`üìà PPG Chart updated: ${totalSamples} points (${timeWindowSeconds.toFixed(1)}s ACTUAL duration) | Range: ${Math.min(...timeSeries.raw_ppg).toFixed(1)}-${Math.max(...timeSeries.raw_ppg).toFixed(1)} | Sampling Rate: ${actualSamplingRate.toFixed(1)} FPS`);
                
                // Replace processed signal (clear if none)
                if (timeSeries.processed_ppg) {
                    ppgSignalChart.data.datasets[1].data = timeSeries.processed_ppg;
                } else {
                    ppgSignalChart.data.datasets[1].data = [];
                }
                
                // Update status display with CORRECTED timing
                const ppgStatus = document.getElementById('ppgStatus');
                if (ppgStatus) {
                    // Use ACTUAL sampling rate calculated above
                    const morphologyInfo = timeSeries.pulse_morphology || {};
                    
                    // Create morphology status icon
                    let morphologyIcon = 'üìà';
                    if (morphologyInfo.morphology_quality === 'excellent_pulse_shape') {
                        morphologyIcon = 'ü´Ä‚úÖ'; // Excellent systolic + dicrotic
                    } else if (morphologyInfo.morphology_quality === 'good_pulse_shape') {
                        morphologyIcon = 'ü´Ä'; // Good systolic peaks
                    } else if (morphologyInfo.morphology_quality === 'poor_pulse_shape') {
                        morphologyIcon = 'üìä‚ö†Ô∏è'; // Plateaued peaks
                    }
                    
                    ppgStatus.innerHTML = `${morphologyIcon} PPG Duration: ${timeWindowSeconds}s ACTUAL | ${totalSamples} samples | Rate: ${actualSamplingRate.toFixed(1)} FPS | Range: ${Math.min(...timeSeries.raw_ppg).toFixed(1)}-${Math.max(...timeSeries.raw_ppg).toFixed(1)}`;
                    ppgStatus.style.color = '#E91E63';
                    
                    // Log morphology details for debugging
                    if (morphologyInfo.morphology_quality) {
                        console.log(`ü´Ä Pulse shape: ${morphologyInfo.morphology_quality} | Score: ${morphologyInfo.morphology_score?.toFixed(2) || 'N/A'}`);
                    }
                }
                
                // Replace peak markers using CORRECTED timing (no previous measurements)
                if (timeSeries.peak_times && timeSeries.peak_times.length > 0 && timeSeries.timestamps) {
                    const peakData = timeSeries.peak_times.map(time => ({
                        x: ((time - timeSeries.timestamps[0]) / actualSamplingRate).toFixed(1),  // Use actual sampling rate
                        y: Math.max(...timeSeries.processed_ppg || timeSeries.raw_ppg)
                    }));
                    ppgSignalChart.data.datasets[2].data = peakData;
                } else {
                    ppgSignalChart.data.datasets[2].data = [];  // Clear peaks if none
                }
                
                ppgSignalChart.update('none');  // No animation for fastest updates
            }
            
            // Update Heart Rate Trend
            if (hrTrendChart && metrics.heart_rate) {
                const timeLabel = currentTime.toLocaleTimeString();
                hrTrendData.push({ x: timeLabel, y: metrics.heart_rate });
                
                // Keep last 20 readings
                if (hrTrendData.length > 20) hrTrendData.shift();
                
                hrTrendChart.data.labels = hrTrendData.map(d => d.x);
                hrTrendChart.data.datasets[0].data = hrTrendData.map(d => d.y);
                hrTrendChart.update('none');
            }
            
            // Update RR Intervals
            if (rrIntervalChart && metrics.rr_intervals) {
                rrIntervalData = rrIntervalData.concat(
                    metrics.rr_intervals.map((rr, i) => ({
                        x: rrIntervalData.length + i + 1,
                        y: rr
                    }))
                );
                
                // Keep last 30 intervals
                if (rrIntervalData.length > 30) {
                    rrIntervalData = rrIntervalData.slice(-30);
                }
                
                rrIntervalChart.data.datasets[0].data = rrIntervalData;
                rrIntervalChart.update('none');
            }
            
            // Update Live Metrics
            if (metrics.hrv_metrics) {
                const hrv = metrics.hrv_metrics;
                document.getElementById('liveRMSSD').textContent = hrv.rmssd || '--';
                document.getElementById('liveSDNN').textContent = hrv.sdnn || '--';
                document.getElementById('livePNN50').textContent = hrv.pnn50 || '--';
            }
            
            document.getElementById('liveSignalQuality').textContent = metrics.signal_quality || '--';
            
            // Update AI Preprocessing Status
            if (metrics.preprocessing_info) {
                const prep = metrics.preprocessing_info;
                document.getElementById('processingMethod').textContent = prep.method || '--';
                document.getElementById('qualityScore').textContent = prep.quality_score ? prep.quality_score.toFixed(3) : '--';
                document.getElementById('artifactLevel').textContent = prep.artifact_probability ? (prep.artifact_probability * 100).toFixed(1) + '%' : '--';
                
                // Update quality trend chart
                if (qualityTrendChart && prep.quality_score) {
                    qualityHistoryData.push(prep.quality_score);
                    if (qualityHistoryData.length > 20) qualityHistoryData.shift();
                    
                    qualityTrendChart.data.labels = qualityHistoryData.map((_, i) => i);
                    qualityTrendChart.data.datasets[0].data = qualityHistoryData;
                    qualityTrendChart.update('none');
                }
                
                // Show AI recommendations
                if (prep.recommendations && prep.recommendations.length > 0) {
                    const recommendationsDiv = document.getElementById('aiRecommendations');
                    const recommendationsList = document.getElementById('recommendationsList');
                    
                    recommendationsList.innerHTML = '';
                    prep.recommendations.forEach(rec => {
                        const li = document.createElement('li');
                        li.textContent = rec;
                        recommendationsList.appendChild(li);
                    });
                    
                    recommendationsDiv.style.display = 'block';
                } else {
                    document.getElementById('aiRecommendations').style.display = 'none';
                }
            }
            
            // Update Clinical Indices
            if (metrics.clinical_indices) {
                const indices = metrics.clinical_indices;
                document.getElementById('abiScore').textContent = indices.abi_score || '--';
                document.getElementById('abiInterpretation').textContent = indices.abi_interpretation || '--';
                document.getElementById('cvrScore').textContent = indices.cvr_score || '--';
                document.getElementById('cvrInterpretation').textContent = indices.cvr_interpretation || '--';
                document.getElementById('csiScore').textContent = indices.csi_score || '--';
                document.getElementById('csiInterpretation').textContent = indices.csi_interpretation || '--';
            }
            
            // Update AI Risk Assessment
            if (metrics.risk_assessment) {
                const risk = metrics.risk_assessment;
                const riskLevel = risk.risk_level || '--';
                
                document.getElementById('aiRiskLevel').textContent = riskLevel;
                
                // Color code risk level
                const riskContainer = document.getElementById('aiRiskContainer');
                if (riskLevel === 'High') {
                    riskContainer.style.background = 'rgba(244, 67, 54, 0.2)';
                    document.getElementById('aiRiskLevel').style.color = '#d32f2f';
                } else if (riskLevel === 'Moderate') {
                    riskContainer.style.background = 'rgba(255, 193, 7, 0.2)';
                    document.getElementById('aiRiskLevel').style.color = '#f57c00';
                } else {
                    riskContainer.style.background = 'rgba(76, 175, 80, 0.2)';
                    document.getElementById('aiRiskLevel').style.color = '#2e7d32';
                }
                
                // Show clinical recommendations
                if (risk.clinical_recommendations && risk.clinical_recommendations.length > 0) {
                    const recommendationsDiv = document.getElementById('aiClinicalRecommendations');
                    const recommendationsList = document.getElementById('clinicalRecommendationsList');
                    
                    recommendationsList.innerHTML = '';
                    risk.clinical_recommendations.forEach(rec => {
                        const li = document.createElement('li');
                        li.textContent = rec;
                        recommendationsList.appendChild(li);
                    });
                    
                    recommendationsDiv.style.display = 'block';
                } else {
                    document.getElementById('aiClinicalRecommendations').style.display = 'none';
                }
            }
            
            // Update AI risk probabilities and patterns
            if (metrics.ai_risk_probabilities) {
                const probs = metrics.ai_risk_probabilities;
                document.getElementById('lowRiskProb').textContent = probs.low ? (probs.low * 100).toFixed(1) + '%' : '--%';
                document.getElementById('moderateRiskProb').textContent = probs.moderate ? (probs.moderate * 100).toFixed(1) + '%' : '--%';
                document.getElementById('highRiskProb').textContent = probs.high ? (probs.high * 100).toFixed(1) + '%' : '--%';
                
                const confidence = metrics.ai_confidence || 0;
                document.getElementById('aiConfidence').textContent = `Confidence: ${(confidence * 100).toFixed(1)}%`;
            }
            
            // Show literature patterns if detected
            if (metrics.literature_patterns && metrics.literature_patterns.length > 0) {
                const patternsDiv = document.getElementById('literaturePatterns');
                const patternsList = document.getElementById('patternsList');
                
                patternsList.innerHTML = '';
                metrics.literature_patterns.forEach(pattern => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${pattern.pattern}</strong>: ${pattern.description}`;
                    patternsList.appendChild(li);
                });
                
                patternsDiv.style.display = 'block';
            } else {
                document.getElementById('literaturePatterns').style.display = 'none';
            }
        }
        
        // ========================================
        // üèÅ END OF CONSOLIDATED PPG WAVEFORM CODE SECTION
        // ========================================
        
        // Heart Rate Detection Loop
        function startHeartRateDetection() {
            const video = document.getElementById('ppgVideo');
            if (!video || !ppgSession) {
                console.error('‚ùå Cannot start heart rate detection: missing video or session');
                return;
            }
            
            // Ensure video is playing
            if (video.paused || video.readyState < 2) {
                console.log('‚è≥ Waiting for video to be ready...');
                setTimeout(() => startHeartRateDetection(), 500);
                return;
            }

            console.log('üíì Starting heart rate detection loop...');
            
            let frameCount = 0;
            measurementInterval = setInterval(async () => {
                frameCount++;
                try {
                    // Capture frame from video
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 320;
                    canvas.height = video.videoHeight || 240;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);

                    // Extract green channel data for PPG (better signal quality)
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    let totalGreen = 0, count = 0;

                    // Focus on center region for finger detection
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const roiSize = Math.min(canvas.width, canvas.height) / 3;

                    for (let y = centerY - roiSize / 2; y < centerY + roiSize / 2; y++) {
                        for (let x = centerX - roiSize / 2; x < centerX + roiSize / 2; x++) {
                            const idx = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
                            if (idx < imageData.length) {
                                totalGreen += imageData[idx + 1]; // Green channel (idx+1)
                                count++;
                            }
                        }
                    }

                    const avgGreen = count > 0 ? totalGreen / count : 0;
                    
                    // Debug logging every 60 frames (once per second)
                    if (frameCount % 60 === 0) {
                        console.log(`üíö PPG Detection: Frame ${frameCount}, Green avg: ${avgGreen.toFixed(1)}, Buffer size: ${ppgBuffer.length}, ROI pixels: ${count}`);
                        
                        // Check if finger is detected
                        if (avgGreen < 80) {
                            console.warn('‚ö†Ô∏è Low signal - ensure finger fully covers camera lens');
                            document.getElementById('heartRateStatus').textContent = 'Low signal - cover camera completely with finger';
                        } else if (avgGreen > 200) {
                            console.warn('‚ö†Ô∏è Signal too bright - reduce pressure or adjust lighting');
                            document.getElementById('heartRateStatus').textContent = 'Signal too bright - reduce finger pressure';
                        } else {
                            document.getElementById('heartRateStatus').textContent = 'Good signal - measuring...';
                        }
                    }
                    
                    // Add to local buffer for immediate visualization
                    ppgBuffer.push(avgGreen);
                    
                    // üîß FIX: Keep buffer size based on ACTUAL time, not FPS calculations
                    // Simple approach: keep last 100 seconds of samples maximum
                    const maxDisplaySeconds = 100; 
                    const currentElapsedSeconds = measurementStartTime ? (Date.now() - measurementStartTime) / 1000 : 0;
                    
                    // Only trim buffer if we've been measuring for more than max display time
                    if (currentElapsedSeconds > maxDisplaySeconds) {
                        // Calculate how many samples to keep (keep samples from last 100 seconds)
                        const samplesToKeep = Math.floor(ppgBuffer.length * (maxDisplaySeconds / currentElapsedSeconds));
                        ppgBuffer = ppgBuffer.slice(-samplesToKeep);
                    }
                    
                    // Also add to main signal data for analysis
                    ppgSignalData.push(avgGreen);
                    
                    // Update chart immediately with local data
                    updateChartFromBuffer();

                    // Send frame to backend for advanced processing (throttled)
                    if (frameCount % 3 === 0) { // Send every 3rd frame to reduce load
                        const frameDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        const base64Data = frameDataUrl.split(',')[1];

                        const response = await fetch('http://127.0.0.1:5000/api/ppg/process-frame', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: ppgSession.session_id,
                                frame_data: base64Data,
                                timestamp: Date.now()
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success && result.data?.metrics) {
                                // Update status with real-time metrics
                                const metrics = result.data.metrics;
                                if (metrics.heart_rate && metrics.heart_rate > 0) {
                                    document.getElementById('heartRateStatus').textContent = 
                                        `Heart Rate: ${metrics.heart_rate} BPM | Signal Quality: ${(metrics.signal_quality * 100).toFixed(0)}%`;
                                }
                                
                                // ü©ª ENHANCED DEBUGGING: CHECK COMPREHENSIVE METRICS
                                console.log('üîç DEBUG: Checking metrics response...', {
                                    has_comprehensive_metrics: !!metrics.comprehensive_metrics,
                                    comprehensive_status: metrics.comprehensive_metrics?.status,
                                    heart_rate: metrics.heart_rate,
                                    buffer_size: metrics.buffer_size
                                });
                                
                                // ü©ª UPDATE COMPREHENSIVE METRICS DASHBOARD CARDS (live update during measurement)
                                if (metrics.comprehensive_metrics && metrics.comprehensive_metrics.status === 'success') {
                                    const comp = metrics.comprehensive_metrics;
                                    console.log(`üéâ FOUND COMPREHENSIVE METRICS! HR=${comp.HR}, SDNN=${comp.SDNN}ms, PI=${comp.PI}%`);
                                    
                                    // üéØ UPDATE ALL 11 COMPREHENSIVE METRICS ON DASHBOARD CARDS
                                    updateLiveDashboard(comp);
                                } else if (metrics.comprehensive_metrics) {
                                    console.log(`‚ö†Ô∏è Comprehensive metrics not ready: ${metrics.comprehensive_metrics.status}`, metrics.comprehensive_metrics);
                                    // Fallback to basic metrics if comprehensive not available
                                    updateBasicDashboard(metrics);
                                } else {
                                    console.log('‚ÑπÔ∏è No comprehensive metrics in response, using basic dashboard');
                                    // Fallback to basic metrics if comprehensive not available
                                    updateBasicDashboard(metrics);
                                }
                            }
                        }
                    } // Close the throttling conditional
                } catch (error) {
                    console.warn('‚ö†Ô∏è Frame processing error:', error.message);
                }
            }, 1000 / 60); // 60 FPS for smooth PPG detection
        }
        
        // ü©ª UPDATE COMPREHENSIVE METRICS MAIN DASHBOARD CARDS
        function updateLiveDashboard(comprehensiveMetrics) {
            console.log('üéØ Updating MAIN DASHBOARD with comprehensive metrics...', comprehensiveMetrics);
            
            // ===== UPDATE MAIN DASHBOARD CARDS (12 cards) =====
            console.log('ÔøΩ Updating MAIN Dashboard HR:', Math.round(comprehensiveMetrics.HR || 0));
            updateElement('dashHR', Math.round(comprehensiveMetrics.HR || 0));
            
            console.log('ÔøΩ Updating MAIN Dashboard SDNN:', comprehensiveMetrics.SDNN ? Math.round(comprehensiveMetrics.SDNN) : '--');
            updateElement('dashSDNN', comprehensiveMetrics.SDNN ? Math.round(comprehensiveMetrics.SDNN) : '--');
            
            console.log('‚ö° Updating MAIN Dashboard RMSSD:', comprehensiveMetrics.RMSSD ? Math.round(comprehensiveMetrics.RMSSD) : '--');
            updateElement('dashRMSSD', comprehensiveMetrics.RMSSD ? Math.round(comprehensiveMetrics.RMSSD) : '--');
            
            console.log('üìà Updating MAIN Dashboard pNN50:', comprehensiveMetrics.pNN50 ? comprehensiveMetrics.pNN50.toFixed(1) : '--');
            updateElement('dashPNN50', comprehensiveMetrics.pNN50 ? comprehensiveMetrics.pNN50.toFixed(1) : '--');
            
            // ===== FREQUENCY DOMAIN & MORPHOLOGICAL METRICS =====
            console.log('‚öñÔ∏è Updating LF/HF Ratio:', comprehensiveMetrics['LF/HF'] ? comprehensiveMetrics['LF/HF'].toFixed(2) : '--');
            updateElement('dashLFHF', comprehensiveMetrics['LF/HF'] ? comprehensiveMetrics['LF/HF'].toFixed(2) : '--');
            
            console.log('üéØ Updating SD1:', comprehensiveMetrics.SD1 ? Math.round(comprehensiveMetrics.SD1) : '--');
            updateElement('dashSD1', comprehensiveMetrics.SD1 ? Math.round(comprehensiveMetrics.SD1) : '--');
            
            // ===== MORPHOLOGICAL PULSE METRICS =====
            console.log('üíß Updating PI:', comprehensiveMetrics.PI ? comprehensiveMetrics.PI.toFixed(1) : '--');
            updateElement('dashPI', comprehensiveMetrics.PI ? comprehensiveMetrics.PI.toFixed(1) : '--');
            
            console.log('üåä Updating RI:', comprehensiveMetrics.RI ? comprehensiveMetrics.RI.toFixed(1) : '--');
            updateElement('dashRI', comprehensiveMetrics.RI ? comprehensiveMetrics.RI.toFixed(1) : '--');
            
            console.log('üßç Updating SI:', comprehensiveMetrics.SI ? comprehensiveMetrics.SI.toFixed(1) : '--');
            updateElement('dashSI', comprehensiveMetrics.SI ? comprehensiveMetrics.SI.toFixed(1) : '--');
            
            console.log('üíé Updating DI:', comprehensiveMetrics.DI ? comprehensiveMetrics.DI.toFixed(1) : '--');
            updateElement('dashDI', comprehensiveMetrics.DI ? comprehensiveMetrics.DI.toFixed(1) : '--');
            
            console.log('‚öñÔ∏è Updating SDR:', comprehensiveMetrics.SDR ? comprehensiveMetrics.SDR.toFixed(2) : '--');
            updateElement('dashSDR', comprehensiveMetrics.SDR ? comprehensiveMetrics.SDR.toFixed(2) : '--');
            
            console.log('üå¨Ô∏è Updating PAV:', comprehensiveMetrics.PAV ? comprehensiveMetrics.PAV.toFixed(1) : '--');
            updateElement('dashPAV', comprehensiveMetrics.PAV ? comprehensiveMetrics.PAV.toFixed(1) : '--');
            
            // ===== ALSO UPDATE PPG MEASUREMENT CARDS =====
            updateElement('heartRateDisplay', Math.round(comprehensiveMetrics.HR || 0));
            updateElement('sdnnDisplay', comprehensiveMetrics.SDNN ? Math.round(comprehensiveMetrics.SDNN) : '--');
            updateElement('rmssdDisplay', comprehensiveMetrics.RMSSD ? Math.round(comprehensiveMetrics.RMSSD) : '--');
            updateElement('pnn50Display', comprehensiveMetrics.pNN50 ? comprehensiveMetrics.pNN50.toFixed(1) : '--');
            updateElement('lfhfDisplay', comprehensiveMetrics['LF/HF'] ? comprehensiveMetrics['LF/HF'].toFixed(2) : '--');
            updateElement('sd1Display', comprehensiveMetrics.SD1 ? Math.round(comprehensiveMetrics.SD1) : '--');
            updateElement('piDisplay', comprehensiveMetrics.PI ? comprehensiveMetrics.PI.toFixed(1) : '--');
            updateElement('riDisplay', comprehensiveMetrics.RI ? comprehensiveMetrics.RI.toFixed(1) : '--');
            updateElement('siDisplay', comprehensiveMetrics.SI ? comprehensiveMetrics.SI.toFixed(1) : '--');
            updateElement('diDisplay', comprehensiveMetrics.DI ? comprehensiveMetrics.DI.toFixed(1) : '--');
            updateElement('sdrDisplay', comprehensiveMetrics.SDR ? comprehensiveMetrics.SDR.toFixed(2) : '--');
            updateElement('pavDisplay', comprehensiveMetrics.PAV ? comprehensiveMetrics.PAV.toFixed(1) : '--');
            
            console.log(`üéâ MAIN DASHBOARD updated with: HR=${comprehensiveMetrics.HR}, SDNN=${comprehensiveMetrics.SDNN}ms, PI=${comprehensiveMetrics.PI}%`);
        }
        
        // üìä FALLBACK TO BASIC METRICS when comprehensive not available
        function updateBasicDashboard(basicMetrics) {
            console.log('üìä Updating MAIN DASHBOARD with basic metrics (comprehensive not ready yet)...');
            
            // ===== UPDATE MAIN DASHBOARD CARDS WITH BASIC METRICS =====
            updateElement('dashHR', basicMetrics.heart_rate ? Math.round(basicMetrics.heart_rate) : '--');
            
            if (basicMetrics.hrv_metrics) {
                updateElement('dashRMSSD', basicMetrics.hrv_metrics.rmssd ? Math.round(basicMetrics.hrv_metrics.rmssd) : '--');
                updateElement('dashSDNN', basicMetrics.hrv_metrics.sdnn ? Math.round(basicMetrics.hrv_metrics.sdnn) : '--');
                updateElement('dashPNN50', basicMetrics.hrv_metrics.pnn50 ? basicMetrics.hrv_metrics.pnn50.toFixed(1) : '--');
            }
            
            // Set others to "measuring..." while waiting for comprehensive analysis
            const waitingFieldsMain = ['dashLFHF', 'dashSD1', 'dashPI', 'dashRI', 'dashSI', 'dashDI', 'dashSDR', 'dashPAV'];
            waitingFieldsMain.forEach(field => {
                updateElement(field, '...');
            });
            
            // ===== ALSO UPDATE PPG MEASUREMENT CARDS =====
            updateElement('heartRateDisplay', basicMetrics.heart_rate ? Math.round(basicMetrics.heart_rate) : '--');
            
            if (basicMetrics.hrv_metrics) {
                updateElement('rmssdDisplay', basicMetrics.hrv_metrics.rmssd ? Math.round(basicMetrics.hrv_metrics.rmssd) : '--');
                updateElement('sdnnDisplay', basicMetrics.hrv_metrics.sdnn ? Math.round(basicMetrics.hrv_metrics.sdnn) : '--');
                updateElement('pnn50Display', basicMetrics.hrv_metrics.pnn50 ? basicMetrics.hrv_metrics.pnn50.toFixed(1) : '--');
            }
            
            // Set others to "measuring..." or "--" while waiting for comprehensive analysis
            const waitingFields = ['lfhfDisplay', 'sd1Display', 'piDisplay', 'riDisplay', 'siDisplay', 'diDisplay', 'sdrDisplay', 'pavDisplay'];
            waitingFields.forEach(field => {
                updateElement(field, '...');
            });
            
            console.log(`üìä Basic MAIN DASHBOARD updated: HR=${basicMetrics.heart_rate || '--'}`);
        }
        
        // üß™ TEST FUNCTION: Test MAIN dashboard cards update
        function testDashboardUpdate() {
            console.log('üß™ Testing MAIN DASHBOARD cards with mock comprehensive metrics...');
            
            // Create mock comprehensive metrics
            const mockComprehensive = {
                status: 'success',
                HR: 72.5,
                SDNN: 45.2,
                RMSSD: 38.7,
                pNN50: 15.3,
                'LF/HF': 0.85,
                SD1: 27.4,
                PI: 5.2,
                RI: 65.1,
                SI: 8.9,
                DI: 12.3,
                SDR: 1.45,
                PAV: 8.7
            };
            
            console.log('üéØ Calling updateLiveDashboard with mock data...');
            updateLiveDashboard(mockComprehensive);
            
            // Also test individual elements
            setTimeout(() => {
                console.log('üîç Checking if elements exist:');
                const elementIds = ['heartRateDisplay', 'sdnnDisplay', 'rmssdDisplay', 'pnn50Display', 'lfhfDisplay', 'sd1Display', 'piDisplay', 'riDisplay', 'siDisplay', 'diDisplay', 'sdrDisplay', 'pavDisplay'];
                elementIds.forEach(id => {
                    const element = document.getElementById(id);
                    console.log(`${id}: ${element ? 'EXISTS ‚úÖ' : 'MISSING ‚ùå'} - Current value: ${element?.textContent || 'N/A'}`);
                });
            }, 1000);
        }


        
        // Master Blueprint v10.0: Initialize Professional Charts
        function initializeMasterBlueprintCharts() {
            const timeRange = document.getElementById('hrTimeRange')?.value || 'week';
            
            // Chart 1: HR & RHR over time
            const hrRhrCtx = document.getElementById('hrRhrChart');
            if (hrRhrCtx) {
                window.hrRhrChart = new Chart(hrRhrCtx, {
                    type: 'line',
                    data: {
                        labels: getTimeLabels(timeRange),
                        datasets: [{
                            label: 'Heart Rate (bpm)',
                            data: generateChartData(timeRange, 'hr'),
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#E91E63',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }, {
                            label: 'Resting HR',
                            data: generateChartData(timeRange, 'rhr'),
                            borderColor: 'gray',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0,
                            pointBackgroundColor: 'gray',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 2
                        }, {
                            label: '10-beat Rolling Avg',
                            data: generateRollingAverage(generateChartData(timeRange, 'hr'), 10),
                            borderColor: 'orange',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 11 } } }
                        },
                        scales: {
                            y: { 
                                beginAtZero: false,
                                min: 50,
                                max: 100,
                                title: { display: true, text: 'BPM', color: '#4a2c4a' }
                            }
                        }
                    }
                });
            }
            
            // Chart 2: HRV Metrics (RMSSD & SDNN)
            const hrvMetricsCtx = document.getElementById('hrvMetricsChart');
            if (hrvMetricsCtx) {
                window.hrvMetricsChart = new Chart(hrvMetricsCtx, {
                    type: 'line',
                    data: {
                        labels: getTimeLabels(timeRange),
                        datasets: [{
                            label: 'RMSSD (Short-term)',
                            data: generateChartData(timeRange, 'rmssd'),
                            borderColor: 'teal',
                            backgroundColor: 'rgba(0, 128, 128, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#9C27B0',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }, {
                            label: 'SDNN (Long-term)',
                            data: generateChartData(timeRange, 'sdnn'),
                            borderColor: 'purple',
                            backgroundColor: 'rgba(128, 0, 128, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#673AB7',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 11 } } }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Milliseconds (ms)', color: '#4a2c4a' }
                            }
                        }
                    }
                });
            }
            
            // Chart 3: LF/HF Ratio (Frequency Domain)
            const lfhfCtx = document.getElementById('lfhfChart');
            if (lfhfCtx) {
                window.lfhfChart = new Chart(lfhfCtx, {
                    type: 'line',
                    data: {
                        labels: getTimeLabels(timeRange),
                        datasets: [{
                            label: 'LF Power',
                            data: generateChartData(timeRange, 'lf'),
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 128, 0, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: 'green',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 3
                        }, {
                            label: 'HF Power',
                            data: generateChartData(timeRange, 'hf'),
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: 'blue',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 3
                        }, {
                            label: 'LF/HF Ratio',
                            data: generateChartData(timeRange, 'lfhf'),
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: 'red',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 11 } } }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'LF/HF Ratio', color: '#4a2c4a' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // Chart 4: Artifact Percentage (Signal Quality) 
            const artifactCtx = document.getElementById('artifactChart');
            if (artifactCtx) {
                window.artifactChart = new Chart(artifactCtx, {
                    type: 'line',
                    data: {
                        labels: getTimeLabels(timeRange),
                        datasets: [{
                            label: 'Signal Quality (%)',
                            data: generateSignalQuality(timeRange),
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 128, 0, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: 'green',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 11 } } }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'Artifact %', color: '#4a2c4a' },
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
            
            // Chart 5: Clinical Indices (ABI, CVR, CSI)
            const clinicalIndicesCtx = document.getElementById('clinicalIndicesChart');
            if (clinicalIndicesCtx) {
                window.clinicalIndicesChart = new Chart(clinicalIndicesCtx, {
                    type: 'line',
                    data: {
                        labels: getTimeLabels(timeRange),
                        datasets: [{
                            label: 'ABI (Autonomic Balance)',
                            data: generateChartData(timeRange, 'abi'),
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#4CAF50',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }, {
                            label: 'CVR (Cardiovascular Risk)',
                            data: generateChartData(timeRange, 'cvr'),
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#2196F3',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }, {
                            label: 'CSI (Cycle Stress Index)',
                            data: generateChartData(timeRange, 'csi'),
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#FF9800',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 11 } } }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'Index Score', color: '#4a2c4a' }
                            }
                        }
                    }
                });
            }

            // Chart 6: Vascular Health Indices (PI, RI, SI, DI, SDR)
            const vascularIndicesCtx = document.getElementById('vascularIndicesChart');
            if (vascularIndicesCtx) {
                window.vascularIndicesChart = new Chart(vascularIndicesCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'PI (Perfusion Index %)',
                            data: [],
                            borderColor: '#FF5722',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3
                        }, {
                            label: 'RI (Reflection Index %)',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3
                        }, {
                            label: 'SI (Stiffness Index m/s)',
                            data: [],
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3
                        }, {
                            label: 'DI (Dicrotic Index %)',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3
                        }, {
                            label: 'SDR (Systolic-Diastolic Ratio)',
                            data: [],
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3
                        }, {
                            label: 'PAV (Pulse Amplitude Variation %)',
                            data: [],
                            borderColor: '#795548',
                            backgroundColor: 'rgba(121, 85, 72, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 10 } } }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'Index Values', color: '#4a2c4a' },
                                beginAtZero: false
                            }
                        }
                    }
                });
            }

            // Chart 7: Clinical Status Dashboard
            const clinicalStatusCtx = document.getElementById('clinicalStatusChart');
            if (clinicalStatusCtx) {
                window.clinicalStatusChart = new Chart(clinicalStatusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Normal', 'Warning', 'Critical'],
                        datasets: [{
                            label: 'Metrics Count',
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(76, 175, 80, 0.8)',   // Green for normal
                                'rgba(255, 152, 0, 0.8)',   // Orange for warning  
                                'rgba(244, 67, 54, 0.8)'    // Red for critical
                            ],
                            borderColor: [
                                '#4CAF50',
                                '#FF9800', 
                                '#F44336'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'Number of Metrics', color: '#4a2c4a' },
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }
        }
        
        // Helper functions for chart data generation
        function getTimeLabels(timeRange) {
            switch(timeRange) {
                case 'today':
                    return ['6 AM', '9 AM', '12 PM', '3 PM', '6 PM', '9 PM'];
                case 'week':
                    return ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                case 'month':
                    return Array.from({length: 30}, (_, i) => `Day ${i+1}`);
                case 'year':
                    return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                default:
                    return ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            }
        }
        
        // Helper function to calculate rolling average
        function generateRollingAverage(data, windowSize = 3) {
            const rollingAvg = [];
            for (let i = 0; i < data.length; i++) {
                const start = Math.max(0, i - Math.floor(windowSize / 2));
                const end = Math.min(data.length, i + Math.ceil(windowSize / 2));
                const window = data.slice(start, end);
                const avg = window.reduce((sum, val) => sum + val, 0) / window.length;
                rollingAvg.push(avg);
            }
            return rollingAvg;
        }

        function generateSignalQuality(timeRange) {
            // Generate signal quality data (100 - artifact percentage)
            // User specification: quality = [100 - a for a in artifact_percentages]
            const artifactData = generateChartData(timeRange, 'artifact');
            return artifactData.map(artifact => Math.max(0, 100 - artifact));
        }

        function generateChartData(timeRange, metricType) {
            // ‚ö†Ô∏è SIMULATION DATA DISABLED - Return empty arrays until real PPG data is collected
            const labelCount = getTimeLabels(timeRange).length;
            
            // Return empty data arrays - charts will be populated with real PPG data only
            return Array.from({length: labelCount}, () => null);
            
            /* COMMENTED OUT - NO SIMULATION DATA
            const baseValues = {
                hr: { base: 75, variation: 15 },
                rhr: { base: 65, variation: 10 },
                rmssd: { base: 42, variation: 20 },
                sdnn: { base: 50, variation: 25 },
                lfhf: { base: 2.5, variation: 1.5 },
                artifact: { base: 8, variation: 12 },
                abi: { base: 45, variation: 20 },
                cvr: { base: 25, variation: 15 },
                csi: { base: 35, variation: 25 }
            };
            
            const config = baseValues[metricType];
            return Array.from({length: labelCount}, () => {
                const variation = (Math.random() - 0.5) * config.variation;
                return Math.max(0, config.base + variation);
            });
            */
        }
        
        // Time Range Management for All 5 Charts
        function updateAllCharts() {
            const timeRange = document.getElementById('hrTimeRange').value;
            const customRange = document.getElementById('globalCustomRange');
            
            // Show/hide custom range picker
            if (timeRange === 'custom') {
                customRange.style.display = 'block';
                return;
            } else {
                customRange.style.display = 'none';
            }
            
            // Update all 5 charts with new time range
            updateChart5Data(timeRange);
        }
        
        function applyGlobalCustomRange() {
            const fromDate = document.getElementById('globalFromDate').value;
            const toDate = document.getElementById('globalToDate').value;
            
            if (!fromDate || !toDate) {
                updateStatus('Please select both start and end dates', 'error');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                updateStatus('Start date must be before end date', 'error');
                return;
            }
            
            // Update all charts with custom date range
            updateChart5DataCustomRange(fromDate, toDate);
        }
        
        function updateChart5Data(timeRange) {
            const labels = getTimeLabels(timeRange);
            
            // Update all 5 charts
            if (window.hrRhrChart) {
                window.hrRhrChart.data.labels = labels;
                const hrData = generateChartData(timeRange, 'hr');
                window.hrRhrChart.data.datasets[0].data = hrData;
                window.hrRhrChart.data.datasets[1].data = generateChartData(timeRange, 'rhr');
                window.hrRhrChart.data.datasets[2].data = generateRollingAverage(hrData, 10);
                window.hrRhrChart.update('active');
            }
            
            if (window.hrvMetricsChart) {
                window.hrvMetricsChart.data.labels = labels;
                window.hrvMetricsChart.data.datasets[0].data = generateChartData(timeRange, 'rmssd');
                window.hrvMetricsChart.data.datasets[1].data = generateChartData(timeRange, 'sdnn');
                window.hrvMetricsChart.update('active');
            }
            
            if (window.lfhfChart) {
                window.lfhfChart.data.labels = labels;
                window.lfhfChart.data.datasets[0].data = generateChartData(timeRange, 'lfhf');
                window.lfhfChart.update('active');
            }
            
            if (window.artifactChart) {
                window.artifactChart.data.labels = labels;
                window.artifactChart.data.datasets[0].data = generateChartData(timeRange, 'artifact');
                window.artifactChart.update('active');
            }
            
            if (window.clinicalIndicesChart) {
                window.clinicalIndicesChart.data.labels = labels;
                window.clinicalIndicesChart.data.datasets[0].data = generateChartData(timeRange, 'abi');
                window.clinicalIndicesChart.data.datasets[1].data = generateChartData(timeRange, 'cvr');
                window.clinicalIndicesChart.data.datasets[2].data = generateChartData(timeRange, 'csi');
                window.clinicalIndicesChart.update('active');
            }
        }
        
        function updateChart5DataCustomRange(fromDate, toDate) {
            const start = new Date(fromDate);
            const end = new Date(toDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            const labels = [];
            for (let i = 0; i < daysDiff; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }
            
            // Update all 5 charts with custom range
            const customTimeRange = daysDiff <= 7 ? 'week' : daysDiff <= 31 ? 'month' : 'year';
            
            if (window.hrRhrChart) {
                window.hrRhrChart.data.labels = labels;
                const hrData = generateChartData(customTimeRange, 'hr', daysDiff);
                window.hrRhrChart.data.datasets[0].data = hrData;
                window.hrRhrChart.data.datasets[1].data = generateChartData(customTimeRange, 'rhr', daysDiff);
                window.hrRhrChart.data.datasets[2].data = generateRollingAverage(hrData, 10);
                window.hrRhrChart.update('active');
            }
            
            if (window.hrvMetricsChart) {
                window.hrvMetricsChart.data.labels = labels;
                window.hrvMetricsChart.data.datasets[0].data = generateChartData(customTimeRange, 'rmssd', daysDiff);
                window.hrvMetricsChart.data.datasets[1].data = generateChartData(customTimeRange, 'sdnn', daysDiff);
                window.hrvMetricsChart.update('active');
            }
            
            if (window.lfhfChart) {
                window.lfhfChart.data.labels = labels;
                window.lfhfChart.data.datasets[0].data = generateChartData(customTimeRange, 'lfhf', daysDiff);
                window.lfhfChart.update('active');
            }
            
            if (window.artifactChart) {
                window.artifactChart.data.labels = labels;
                window.artifactChart.data.datasets[0].data = generateChartData(customTimeRange, 'artifact', daysDiff);
                window.artifactChart.update('active');
            }
            
            if (window.clinicalIndicesChart) {
                window.clinicalIndicesChart.data.labels = labels;
                window.clinicalIndicesChart.data.datasets[0].data = generateChartData(customTimeRange, 'abi', daysDiff);
                window.clinicalIndicesChart.data.datasets[1].data = generateChartData(customTimeRange, 'cvr', daysDiff);
                window.clinicalIndicesChart.data.datasets[2].data = generateChartData(customTimeRange, 'csi', daysDiff);
                window.clinicalIndicesChart.update('active');
            }
        }
        
        // Update KPI values based on selected time ranges - REAL DATA ONLY
        function updateKPIs() {
            // NO SIMULATED UPDATES - Use real PPG measurements only
            const timeRange = document.getElementById('hrTimeRange')?.value || 'week';
            
            let hrMultiplier = 1;
            let rmssMultiplier = 1;
            let sleepMultiplier = 1;
            let activityMultiplier = 1;
            
            switch(timeRange) {
                case 'today':
                    hrMultiplier = 0.98;
                    rmssMultiplier = 1.05;
                    break;
                case 'month':
                    hrMultiplier = 1.02;
                    rmssMultiplier = 0.95;
                    sleepMultiplier = 0.92;
                    break;
                case 'year':
                    activityMultiplier = 1.15;
                    break;
            }
            
            // Update pink cards (simple values without units since they're in the design)
            const sleepElement = document.getElementById('sleepScore');
            const activityElement = document.getElementById('activityScore');
            
            if (sleepElement) {
                sleepElement.textContent = Math.round(78 * sleepMultiplier);
            }
            if (activityElement) {
                activityElement.textContent = Math.round(85 * activityMultiplier);
            }
        }
        
        // Initialize charts when dashboard is shown
        const originalShowScreen = showScreen;
        showScreen = function(screenId) {
            originalShowScreen(screenId);
            if (screenId === 'dashboard') {
                setTimeout(() => {
                    initializeMasterBlueprintCharts();
                    updateKPIs();
                }, 100);
            }
        };
        
        // üåü CLEAN SLATE INITIALIZATION - Personalized User Experience
        function generateUserId() {
            // Generate unique user ID for this session
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function initializeCleanSlate() {
            // Each user starts with a completely clean slate
            const userId = localStorage.getItem('pulseher_user_id') || generateUserId();
            localStorage.setItem('pulseher_user_id', userId);
            
            console.log('‚ú® Clean Slate Initialized for User:', userId);
            
            // Clear any previous session data
            sessionStorage.clear();
            
            // Initialize empty user state
            const userState = {
                userId: userId,
                heartData: [],
                ppgSessions: [],
                profile: {},
                preferences: {},
                firstTime: !localStorage.getItem('pulseher_returning_user')
            };
            
            // Store user state
            sessionStorage.setItem('pulseher_user_state', JSON.stringify(userState));
            
            // Show welcome message for first-time users
            if (userState.firstTime) {
                console.log('üéâ Welcome to PulseHER! Starting your personalized cardiovascular journey...');
                localStorage.setItem('pulseher_returning_user', 'true');
            }
            
            // Update UI to reflect clean slate
            updateUIForCleanSlate(userState);
            
            return userState;
        }
        
        function updateUIForCleanSlate(userState) {
            // Initialize ALL metrics with dashes - will be replaced as REAL measurements come in
            const metricElements = {
                // ===== MAIN DASHBOARD CARDS (NEW) =====
                dashHR: document.getElementById('dashHR'),
                dashSDNN: document.getElementById('dashSDNN'),
                dashRMSSD: document.getElementById('dashRMSSD'),
                dashPNN50: document.getElementById('dashPNN50'),
                dashLFHF: document.getElementById('dashLFHF'),
                dashSD1: document.getElementById('dashSD1'),
                dashPI: document.getElementById('dashPI'),
                dashRI: document.getElementById('dashRI'),
                dashSI: document.getElementById('dashSI'),
                dashDI: document.getElementById('dashDI'),
                dashSDR: document.getElementById('dashSDR'),
                dashPAV: document.getElementById('dashPAV'),
                
                // ===== PPG MEASUREMENT RESULT CARDS =====
                resultHR: document.getElementById('resultHR'),
                resultRMSSD: document.getElementById('resultRMSSD'),
                resultSDNN: document.getElementById('resultSDNN'),
                
                // ===== CLINICAL SCORES =====
                abiScore: document.getElementById('abiScore'),
                cvrScore: document.getElementById('cvrScore'),
                csiScore: document.getElementById('csiScore'),
                
                // ===== QUALITY METRICS =====
                qualityScore: document.getElementById('qualityScore'),
                
                // Live display metrics
                heartRateDisplay: document.getElementById('heartRateDisplay'),
                sdnnDisplay: document.getElementById('sdnnDisplay'),
                rmssdDisplay: document.getElementById('rmssdDisplay'),
                pnn50Display: document.getElementById('pnn50Display'),
                lfhfDisplay: document.getElementById('lfhfDisplay'),
                sd1Display: document.getElementById('sd1Display'),
                piDisplay: document.getElementById('piDisplay'),
                riDisplay: document.getElementById('riDisplay'),
                siDisplay: document.getElementById('siDisplay'),
                diDisplay: document.getElementById('diDisplay'),
                sdrDisplay: document.getElementById('sdrDisplay'),
                pavDisplay: document.getElementById('pavDisplay')
            };
            
            // Set all metrics to dashes initially
            Object.values(metricElements).forEach(element => {
                if (element) {
                    element.textContent = '-';
                    element.style.color = '#999';
                }
            });
            
            console.log('üìä Complete clean slate initialized - ALL metrics start as dashes');
            console.log('üßÆ Metrics will calculate from REAL data: PPG‚ÜíHR‚ÜíHRV‚ÜíClinical Indices');
        }
        
        function updateMetricProgressively(metricId, value, animate = true) {
            // Gradually update metrics from dash to real values
            const element = document.getElementById(metricId);
            if (!element) return;
            
            if (animate && element.textContent === '-') {
                // Animate transition from dash to value
                element.style.transition = 'all 0.3s ease-in-out';
                element.style.transform = 'scale(1.1)';
                element.style.color = '#c2185b';
                
                setTimeout(() => {
                    element.textContent = value;
                    element.style.transform = 'scale(1)';
                }, 150);
                
                // Flash effect to show new data
                setTimeout(() => {
                    element.style.backgroundColor = 'rgba(194, 24, 91, 0.1)';
                    setTimeout(() => {
                        element.style.backgroundColor = 'transparent';
                    }, 500);
                }, 300);
            } else {
                element.textContent = value;
                element.style.color = '#c2185b';
            }
        }
        
        function getUserState() {
            const stored = sessionStorage.getItem('pulseher_user_state');
            return stored ? JSON.parse(stored) : initializeCleanSlate();
        }
        
        function updateUserData(newData) {
            const userState = getUserState();
            Object.assign(userState, newData);
            sessionStorage.setItem('pulseher_user_state', JSON.stringify(userState));
            return userState;
        }
        
        // Advanced Deep Learning Analysis Functions
        let currentPPGData = [];
        let deepLearningAvailable = false;
        
        // Check deep learning availability on page load
        async function checkDeepLearningStatus() {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/ppg/models/status');
                const status = await response.json();
                deepLearningAvailable = status.models_available;
                
                const dlStatusElement = document.getElementById('dlStatus');
                if (dlStatusElement) {
                    if (deepLearningAvailable) {
                        dlStatusElement.innerHTML = `
                            <div style="padding: 10px; background: rgba(76,175,80,0.1); border-radius: 10px; color: #2e7d32;">
                                ‚úÖ Deep Learning Models Ready: ${status.tensorflow_available ? 'TensorFlow' : 'Fallback Mode'}
                            </div>
                        `;
                    } else {
                        dlStatusElement.innerHTML = `
                            <div style="padding: 10px; background: rgba(255,152,0,0.1); border-radius: 10px; color: #f57c00;">
                                ‚ö†Ô∏è Using Traditional Analysis (Deep Learning Models Not Available)
                            </div>
                        `;
                    }
                }
                
                console.log('üß† Deep Learning Status:', status);
                
            } catch (error) {
                console.error('Failed to check deep learning status:', error);
                const dlStatusElement = document.getElementById('dlStatus');
                if (dlStatusElement) {
                    dlStatusElement.innerHTML = `
                        <div style="padding: 10px; background: rgba(244,67,54,0.1); border-radius: 10px; color: #d32f2f;">
                            ‚ùå Backend Connection Failed
                        </div>
                    `;
                }
            }
        }
        
        // Perform Advanced Deep Learning Analysis
        async function performAdvancedAnalysis() {
            if (currentPPGData.length === 0) {
                updateStatus('Please record a PPG signal first before running advanced analysis!', 'error');
                return;
            }
            
            const analyzeBtn = document.getElementById('analyzeAdvanced');
            const resultsDiv = document.getElementById('advancedResults');
            
            // Show loading state
            analyzeBtn.innerHTML = 'üîÑ Analyzing with AI Models...';
            analyzeBtn.disabled = true;
            
            try {
                // Prepare analysis data
                const analysisData = {
                    ppg_signal: currentPPGData,
                    metadata: {
                        age: 28,
                        sex: 'female',
                        cycle_phase: 'luteal'  // This could be dynamically determined
                    }
                };
                
                console.log('üß† Sending PPG data for advanced analysis...', {
                    samples: currentPPGData.length,
                    duration: (currentPPGData.length / 30).toFixed(1) + 's'
                });
                
                // Call advanced analysis endpoint
                const response = await fetch('http://127.0.0.1:5000/api/ppg/analyze-advanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(analysisData)
                });
                
                const results = await response.json();
                
                if (results.success || results.basic_metrics) {
                    displayAdvancedResults(results);
                    resultsDiv.style.display = 'block';
                    
                    // Smooth scroll to results
                    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                } else {
                    throw new Error(results.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('Advanced analysis failed:', error);
                updateStatus('Advanced analysis failed: ' + error.message, 'error');
            }
            
            // Reset button
            analyzeBtn.innerHTML = 'üî¨ Analyze with AI Models';
            analyzeBtn.disabled = false;
        }
        
        // Display Advanced Analysis Results
        function displayAdvancedResults(results) {
            console.log('üéØ Displaying advanced analysis results:', results);
            
            // Update model predictions
            if (results.deep_learning_predictions) {
                const dl = results.deep_learning_predictions;
                
                // CNN prediction (show confidence for low risk class)
                const cnnConf = (dl.cnn_prediction[0] * 100).toFixed(0);
                updateElement('cnnPrediction', cnnConf + '%');
                
                // LSTM prediction 
                const lstmConf = (dl.lstm_prediction[0] * 100).toFixed(0);
                updateElement('lstmPrediction', lstmConf + '%');
                
                // Ensemble prediction
                const ensembleConf = (dl.ensemble_prediction[0] * 100).toFixed(0);
                updateElement('ensemblePrediction', ensembleConf + '%');
                
                // Risk assessment
                updateElement('riskLevel', dl.risk_categories[dl.risk_class] || 'Unknown');
                updateElement('aiConfidence', (dl.confidence * 100).toFixed(0) + '%');
                
                // Update risk progress bar
                const riskProgress = document.getElementById('riskProgress');
                if (riskProgress && dl.risk_class !== undefined) {
                    const riskPercentage = (dl.risk_class / 2) * 100; // 0=0%, 1=50%, 2=100%
                    riskProgress.querySelector('div').style.width = riskPercentage + '%';
                }
                
            } else if (results.risk_assessment) {
                // Fallback mode results
                const risk = results.risk_assessment;
                updateElement('cnnPrediction', 'N/A');
                updateElement('lstmPrediction', 'N/A'); 
                updateElement('ensemblePrediction', 'Basic');
                updateElement('riskLevel', risk.risk_level);
                updateElement('aiConfidence', (risk.confidence * 100).toFixed(0) + '%');
            }
            
            // Update explainable AI section
            if (results.explainable_ai && results.explainable_ai.top_features) {
                const featuresList = document.getElementById('featuresList');
                if (featuresList) {
                    featuresList.innerHTML = results.explainable_ai.top_features
                        .map(feature => `<li>${feature}</li>`)
                        .join('');
                }
            }
            
            // Update AI recommendations
            if (results.recommendations) {
                const recsList = document.getElementById('aiRecommendations');
                if (recsList) {
                    recsList.innerHTML = results.recommendations
                        .map(rec => `<li>${rec}</li>`)
                        .join('');
                }
            }
            
            // Update basic metrics in the main display (if analysis results available)
            if (results.basic_metrics) {
                const metrics = results.basic_metrics;
                updateElement('heartRateDisplay', Math.round(metrics.heart_rate));
                updateElement('rmssdDisplay', metrics.rmssd ? metrics.rmssd.toFixed(1) : '--');
                updateElement('sdnnDisplay', metrics.sdnn ? metrics.sdnn.toFixed(1) : '--');
                
                // Note: Morphological metrics require the comprehensive analysis endpoint
                console.log('üìä Basic metrics updated from analysis results');
            }
            
            // üìà AUTOMATICALLY PLOT COMPREHENSIVE METRICS TO DASHBOARD CHARTS
            if (results.comprehensive_metrics && results.comprehensive_metrics.status === 'success') {
                console.log('üéØ Plotting comprehensive metrics to dashboard charts...');
                plotMetricsToCharts(results.comprehensive_metrics);
            } else {
                console.log('‚ö†Ô∏è No comprehensive metrics available for chart plotting');
            }
            
            // Show analysis type
            const analysisType = results.analysis_type || 'unknown';
            console.log(`‚úÖ Analysis complete using: ${analysisType}`);
        }
        
        // üìà AUTOMATIC CHART PLOTTING FUNCTION
        function plotMetricsToCharts(comprehensiveMetrics) {
            console.log('üéØ Starting automatic chart plotting with comprehensive metrics...', comprehensiveMetrics);
            
            // Create timestamp for current measurement
            const currentTime = new Date();
            const timeLabel = currentTime.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            // ü´Ä CHART 1: HR (bpm) + RHR Baseline
            if (window.hrRhrChart && comprehensiveMetrics.HR) {
                console.log('üìä Adding HR data to HR chart:', comprehensiveMetrics.HR);
                window.hrRhrChart.data.labels.push(timeLabel);
                window.hrRhrChart.data.datasets[0].data.push(Math.round(comprehensiveMetrics.HR));
                
                // Keep only last 20 data points
                if (window.hrRhrChart.data.labels.length > 20) {
                    window.hrRhrChart.data.labels.shift();
                    window.hrRhrChart.data.datasets[0].data.shift();
                }
                window.hrRhrChart.update('none');
            }
            
            // üåä CHART 2: RMSSD + SDNN (HRV Metrics)
            if (window.hrvMetricsChart && (comprehensiveMetrics.RMSSD || comprehensiveMetrics.SDNN)) {
                console.log('üìä Adding HRV data to HRV chart:', {
                    RMSSD: comprehensiveMetrics.RMSSD,
                    SDNN: comprehensiveMetrics.SDNN
                });
                window.hrvMetricsChart.data.labels.push(timeLabel);
                
                // RMSSD dataset
                if (comprehensiveMetrics.RMSSD) {
                    window.hrvMetricsChart.data.datasets[0].data.push(Math.round(comprehensiveMetrics.RMSSD));
                }
                // SDNN dataset  
                if (comprehensiveMetrics.SDNN) {
                    window.hrvMetricsChart.data.datasets[1].data.push(Math.round(comprehensiveMetrics.SDNN));
                }
                
                // Keep only last 20 data points
                if (window.hrvMetricsChart.data.labels.length > 20) {
                    window.hrvMetricsChart.data.labels.shift();
                    window.hrvMetricsChart.data.datasets.forEach(dataset => dataset.data.shift());
                }
                window.hrvMetricsChart.update('none');
            }
            
            // üìä CHART 3: LF/HF Ratio (Frequency Domain)
            if (window.lfhfChart && comprehensiveMetrics['LF/HF']) {
                console.log('üìä Adding LF/HF data to frequency chart:', comprehensiveMetrics['LF/HF']);
                window.lfhfChart.data.labels.push(timeLabel);
                window.lfhfChart.data.datasets[0].data.push(comprehensiveMetrics['LF/HF'].toFixed(2));
                
                // Keep only last 20 data points
                if (window.lfhfChart.data.labels.length > 20) {
                    window.lfhfChart.data.labels.shift();
                    window.lfhfChart.data.datasets[0].data.shift();
                }
                window.lfhfChart.update('none');
            }
            
            // ü´Ä CHART 5: Vascular Health Indices (PI, RI, SI, DI, SDR, PAV)
            if (window.vascularIndicesChart) {
                console.log('üìä Adding vascular indices to vascular chart:', {
                    PI: comprehensiveMetrics.PI,
                    RI: comprehensiveMetrics.RI,
                    SI: comprehensiveMetrics.SI,
                    DI: comprehensiveMetrics.DI,
                    SDR: comprehensiveMetrics.SDR
                });
                window.vascularIndicesChart.data.labels.push(timeLabel);
                
                // Add data for each vascular metric
                if (comprehensiveMetrics.PI !== undefined) window.vascularIndicesChart.data.datasets[0].data.push(comprehensiveMetrics.PI.toFixed(1));
                if (comprehensiveMetrics.RI !== undefined) window.vascularIndicesChart.data.datasets[1].data.push(comprehensiveMetrics.RI.toFixed(1));
                if (comprehensiveMetrics.SI !== undefined) window.vascularIndicesChart.data.datasets[2].data.push(comprehensiveMetrics.SI.toFixed(1));
                if (comprehensiveMetrics.DI !== undefined) window.vascularIndicesChart.data.datasets[3].data.push(comprehensiveMetrics.DI.toFixed(1));
                if (comprehensiveMetrics.SDR !== undefined) window.vascularIndicesChart.data.datasets[4].data.push(comprehensiveMetrics.SDR.toFixed(2));
                
                // Keep only last 20 data points
                if (window.vascularIndicesChart.data.labels.length > 20) {
                    window.vascularIndicesChart.data.labels.shift();
                    window.vascularIndicesChart.data.datasets.forEach(dataset => dataset.data.shift());
                }
                window.vascularIndicesChart.update('none');
            }
            
            // üè• CHART 6: Clinical Status Dashboard (PAV + Clinical Assessment)
            if (window.clinicalStatusChart && comprehensiveMetrics.PAV) {
                console.log('üìä Adding PAV data to clinical status chart:', comprehensiveMetrics.PAV);
                window.clinicalStatusChart.data.labels.push(timeLabel);
                window.clinicalStatusChart.data.datasets[0].data.push(comprehensiveMetrics.PAV.toFixed(1));
                
                // Keep only last 20 data points
                if (window.clinicalStatusChart.data.labels.length > 20) {
                    window.clinicalStatusChart.data.labels.shift();
                    window.clinicalStatusChart.data.datasets[0].data.shift();
                }
                window.clinicalStatusChart.update('none');
            }
            
            console.log('üéâ All comprehensive metrics successfully plotted to dashboard charts!');
            
            // üî• AUTOMATICALLY SAVE TO FIREBASE DATABASE
            console.log('üî• Auto-saving comprehensive metrics to Firebase database...');
            savePPGDataToFirebase(comprehensiveMetrics);
        }
        
        // üî• FIREBASE DATABASE FUNCTIONS FOR PPG DATA STORAGE
        
        // Save PPG measurement data to Firebase
        async function savePPGDataToFirebase(comprehensiveMetrics) {
            try {
                if (!window.firebaseDB) {
                    console.warn('‚ö†Ô∏è Firebase not initialized yet, data will be saved locally for now');
                    return savePPGDataLocally(comprehensiveMetrics);
                }
                
                const ppgData = {
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    metrics: {
                        HR: comprehensiveMetrics.HR || 0,
                        SDNN: comprehensiveMetrics.SDNN || 0,
                        RMSSD: comprehensiveMetrics.RMSSD || 0,
                        pNN50: comprehensiveMetrics.pNN50 || 0,
                        LFHF: comprehensiveMetrics['LF/HF'] || 0,
                        SD1: comprehensiveMetrics.SD1 || 0,
                        PI: comprehensiveMetrics.PI || 0,
                        RI: comprehensiveMetrics.RI || 0,
                        SI: comprehensiveMetrics.SI || 0,
                        DI: comprehensiveMetrics.DI || 0,
                        SDR: comprehensiveMetrics.SDR || 0,
                        PAV: comprehensiveMetrics.PAV || 0
                    },
                    session_duration: selectedTimer || 30,
                    device_info: {
                        user_agent: navigator.userAgent,
                        screen_resolution: `${screen.width}x${screen.height}`,
                        timestamp_unix: Date.now()
                    }
                };
                
                console.log('üî• Saving PPG data to Firebase...', ppgData);
                
                const docRef = await window.firebaseAddDoc(
                    window.firebaseCollection(window.firebaseDB, 'ppg_measurements'), 
                    ppgData
                );
                
                console.log('‚úÖ PPG data saved to Firebase with ID:', docRef.id);
                
                // Refresh timeline display
                setTimeout(() => loadStoredPPGData(), 500);
                
                return docRef.id;
                
            } catch (error) {
                console.error('‚ùå Error saving to Firebase:', error);
                // Fallback to local storage
                return savePPGDataLocally(comprehensiveMetrics);
            }
        }
        
        // Fallback: Save to local storage if Firebase unavailable
        function savePPGDataLocally(comprehensiveMetrics) {
            try {
                const localData = JSON.parse(localStorage.getItem('pulseher_ppg_data') || '[]');
                const newEntry = {
                    id: 'local_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    metrics: comprehensiveMetrics,
                    source: 'local_storage'
                };
                
                localData.unshift(newEntry); // Add to beginning
                
                // Keep only last 50 entries to prevent storage overflow
                if (localData.length > 50) {
                    localData.splice(50);
                }
                
                localStorage.setItem('pulseher_ppg_data', JSON.stringify(localData));
                console.log('üíæ PPG data saved locally (Firebase backup)');
                
                // Refresh timeline display
                setTimeout(() => loadStoredPPGData(), 500);
                
                return newEntry.id;
            } catch (error) {
                console.error('‚ùå Error saving locally:', error);
            }
        }
        
        // üìä ADD TO PPG DATA STORAGE (Enhanced version with comprehensive metadata)
        async function addToPPGDataStorage() {
            if (!currentSessionData) {
                updateStatus('‚ö†Ô∏è No PPG measurement data available to save!', 'error');
                return;
            }
            
            console.log('üìä Adding PPG measurement to data storage with comprehensive metadata...');
            
            // Get actual measurement duration 
            const actualDuration = window.actualMeasurementDuration || selectedTimer || 30;
            const measurementEndTime = measurementStartTime ? new Date(measurementStartTime + (actualDuration * 1000)) : new Date();
            
            // Create comprehensive PPG data entry with all metadata
            const comprehensivePPGData = {
                // ===== TIMESTAMP & MEASUREMENT INFO =====
                id: 'ppg_' + Date.now(),
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                measurement_start: measurementStartTime ? new Date(measurementStartTime).toISOString() : new Date().toISOString(),
                measurement_end: measurementEndTime.toISOString(),
                actual_duration: actualDuration,
                expected_duration: selectedTimer,
                
                // ===== COMPREHENSIVE METRICS =====
                metrics: {
                    // Core HRV Metrics
                    HR: currentSessionData.metrics?.hr || currentSessionData.metrics?.HR || 0,
                    SDNN: currentSessionData.metrics?.sdnn || currentSessionData.metrics?.SDNN || 0,
                    RMSSD: currentSessionData.metrics?.rmssd || currentSessionData.metrics?.RMSSD || 0,
                    pNN50: currentSessionData.metrics?.pnn50 || currentSessionData.metrics?.pNN50 || 0,
                    
                    // Advanced HRV Metrics
                    LFHF: currentSessionData.metrics?.['LF/HF'] || 0,
                    SD1: currentSessionData.metrics?.SD1 || 0,
                    SD2: currentSessionData.metrics?.SD2 || 0,
                    
                    // Morphological Pulse Metrics
                    PI: currentSessionData.metrics?.PI || 0,
                    RI: currentSessionData.metrics?.RI || 0,
                    SI: currentSessionData.metrics?.SI || 0,
                    DI: currentSessionData.metrics?.DI || 0,
                    SDR: currentSessionData.metrics?.SDR || 0,
                    PAV: currentSessionData.metrics?.PAV || 0,
                    
                    // Signal Quality
                    artifact_percent: currentSessionData.metrics?.artifact_percent || 0,
                    signal_quality: currentSessionData.metrics?.signal_quality || 'unknown'
                },
                
                // ===== RAW PPG DATA & PATTERNS =====
                raw_data: {
                    rr_intervals: currentSessionData.rr_intervals || [],
                    ppg_signal_samples: ppgSignalData.length > 0 ? ppgSignalData.slice() : [], // Clone array
                    sampling_info: {
                        total_samples: ppgSignalData.length,
                        calculated_sampling_rate: ppgSignalData.length / actualDuration,
                        assumed_60fps_duration: ppgSignalData.length / 60,
                        actual_duration: actualDuration,
                        timing_correction_applied: true
                    }
                },
                
                // ===== PATTERNS & BASELINES =====
                patterns: {
                    peak_detection_count: currentSessionData.peak_count || 0,
                    morphology_patterns: currentSessionData.morphology_patterns || {},
                    baseline_drift: currentSessionData.baseline_drift || 'stable',
                    signal_artifacts: currentSessionData.signal_artifacts || []
                },
                
                // ===== CONTEXT & METADATA =====
                context: {
                    measurement_conditions: getSelectedContext(),
                    timer_setting: selectedTimer,
                    user_notes: document.getElementById('userNotes')?.value || '',
                    session_id: ppgSession?.session_id || 'unknown'
                },
                
                // ===== DEVICE & TECHNICAL INFO =====
                device_info: {
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    timestamp_unix: Date.now(),
                    camera_info: {
                        video_width: document.getElementById('ppgVideo')?.videoWidth || 0,
                        video_height: document.getElementById('ppgVideo')?.videoHeight || 0
                    }
                }
            };
            
            console.log('üìä Comprehensive PPG data prepared:', comprehensivePPGData);
            
            try {
                // Save to Firebase with enhanced data
                if (window.firebaseDB) {
                    const docRef = await window.firebaseAddDoc(
                        window.firebaseCollection(window.firebaseDB, 'ppg_comprehensive_storage'), 
                        comprehensivePPGData
                    );
                    console.log('‚úÖ PPG data saved to Firebase comprehensive storage with ID:', docRef.id);
                    
                    // Update button to show success
                    const btn = document.getElementById('addToPPGStorageBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Added Successfully!';
                    btn.style.background = 'linear-gradient(45deg, #4CAF50, #81C784)';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = 'linear-gradient(45deg, #2196f3, #64b5f6)';
                    }, 2000);
                    
                } else {
                    // Fallback to local storage with comprehensive data
                    const localData = JSON.parse(localStorage.getItem('pulseher_ppg_comprehensive_storage') || '[]');
                    localData.unshift(comprehensivePPGData);
                    
                    // Keep only last 30 comprehensive entries
                    if (localData.length > 30) {
                        localData.splice(30);
                    }
                    
                    localStorage.setItem('pulseher_ppg_comprehensive_storage', JSON.stringify(localData));
                    console.log('üíæ PPG comprehensive data saved locally');
                    
                    // Update button to show success
                    const btn = document.getElementById('addToPPGStorageBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'üíæ Saved Locally!';
                    btn.style.background = 'linear-gradient(45deg, #4CAF50, #81C784)';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = 'linear-gradient(45deg, #2196f3, #64b5f6)';
                    }, 2000);
                }
                
                // Refresh the PPG data timeline to show the new entry
                setTimeout(() => {
                    loadStoredPPGData();
                }, 500);
                
                updateStatus('üìä PPG measurement successfully added to data storage with comprehensive metadata!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error saving comprehensive PPG data:', error);
                updateStatus('‚ùå Error saving PPG data. Please try again.', 'error');
            }
        }
        
        // Helper function to get selected context from checkboxes
        function getSelectedContext() {
            const contextItems = [];
            const checkboxes = document.querySelectorAll('#results input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                contextItems.push(cb.parentElement.textContent.trim());
            });
            return contextItems;
        }
        
        // Load and display all stored PPG measurements
        async function loadStoredPPGData() {
            try {
                const timeline = document.getElementById('ppgDataTimeline');
                if (!timeline) return;
                
                timeline.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">üîÑ Loading measurements...</div>';
                
                let allData = [];
                
                // Load from Firebase first
                if (window.firebaseDB) {
                    try {
                        console.log('üî• Loading PPG data from Firebase...');
                        const querySnapshot = await window.firebaseGetDocs(
                            window.firebaseQuery(
                                window.firebaseCollection(window.firebaseDB, 'ppg_measurements'),
                                window.firebaseOrderBy('timestamp', 'desc')
                            )
                        );
                        
                        querySnapshot.forEach((doc) => {
                            allData.push({
                                id: doc.id,
                                ...doc.data(),
                                source: 'firebase'
                            });
                        });
                        
                        console.log(`‚úÖ Loaded ${allData.length} measurements from Firebase`);
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase load failed, using local storage:', firebaseError.message);
                    }
                }
                
                // üìä ALSO LOAD FROM COMPREHENSIVE FIREBASE STORAGE
                if (window.firebaseDB) {
                    try {
                        const comprehensiveQuery = window.firebaseQuery(
                            window.firebaseCollection(window.firebaseDB, 'ppg_comprehensive_storage'),
                            window.firebaseOrderBy('timestamp', 'desc'),
                            window.firebaseLimit(30)
                        );
                        
                        const comprehensiveSnapshot = await window.firebaseGetDocs(comprehensiveQuery);
                        comprehensiveSnapshot.forEach((doc) => {
                            allData.push({
                                id: doc.id,
                                ...doc.data(),
                                source: 'firebase_comprehensive',
                                isComprehensive: true
                            });
                        });
                        console.log(`‚úÖ Also loaded comprehensive storage data`);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Comprehensive Firebase load failed:', error.message);
                    }
                }
                
                // Load from local storage as backup (both regular and comprehensive)
                const localData = JSON.parse(localStorage.getItem('pulseher_ppg_data') || '[]');
                const localComprehensive = JSON.parse(localStorage.getItem('pulseher_ppg_comprehensive_storage') || '[]');
                
                // Merge and deduplicate (prefer Firebase data)
                [...localData, ...localComprehensive].forEach(local => {
                    if (!allData.find(fb => Math.abs(new Date(fb.timestamp) - new Date(local.timestamp)) < 5000)) {
                        allData.push({
                            ...local,
                            isComprehensive: local.raw_data ? true : false
                        });
                    }
                });
                
                // Sort by timestamp (newest first)
                allData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                console.log(`üìä Total measurements loaded: ${allData.length}`);
                
                // Display in timeline
                displayPPGTimeline(allData);
                
                // Auto-plot latest measurement to charts
                if (allData.length > 0) {
                    const latest = allData[0];
                    console.log('üìà Auto-plotting latest measurement to charts...');
                    plotMetricsToCharts(latest.metrics);
                    
                    // Update dashboard cards with latest data
                    if (latest.metrics) {
                        updateLiveDashboard(latest.metrics);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error loading stored data:', error);
                const timeline = document.getElementById('ppgDataTimeline');
                if (timeline) {
                    timeline.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">‚ùå Error loading data</div>';
                }
            }
        }
        
        // Display PPG data timeline
        function displayPPGTimeline(dataArray) {
            const timeline = document.getElementById('ppgDataTimeline');
            if (!timeline) return;
            
            if (dataArray.length === 0) {
                timeline.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìä</div>
                        <div style="font-size: 1.1rem; margin-bottom: 5px;">No PPG measurements yet</div>
                        <div style="font-size: 0.9rem;">Complete a PPG measurement to see data here!</div>
                    </div>
                `;
                return;
            }
            
            let timelineHTML = '';
            
            dataArray.forEach((entry, index) => {
                const metrics = entry.metrics || {};
                
                // üìä Enhanced source icons for comprehensive data
                let sourceIcon = 'üíæ';
                let sourceText = 'Local';
                if (entry.source === 'firebase') {
                    sourceIcon = 'üî•';
                    sourceText = 'Firebase';
                } else if (entry.source === 'firebase_comprehensive') {
                    sourceIcon = 'üî•üìä';
                    sourceText = 'Comprehensive';
                } else if (entry.isComprehensive) {
                    sourceIcon = 'üìäüíæ';
                    sourceText = 'Comprehensive Local';
                }
                
                const date = new Date(entry.timestamp);
                const relativeTime = getRelativeTimeString(date);
                
                // Determine health status based on metrics
                let statusColor = '#4CAF50';
                let statusText = 'Normal';
                
                if (metrics.HR > 100 || metrics.HR < 60) {
                    statusColor = '#FF9800';
                    statusText = 'Attention';
                }
                if (metrics.HR > 120 || metrics.HR < 50) {
                    statusColor = '#f44336';
                    statusText = 'Alert';
                }
                
                timelineHTML += `
                    <div class="ppg-timeline-entry" onclick="selectPPGEntry('${entry.id}', ${index})" 
                         style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="font-size: 0.9rem;">${sourceIcon}</span>
                                    <strong>${entry.date || date.toLocaleDateString()} ‚Ä¢ ${entry.time || date.toLocaleTimeString()}</strong>
                                    <span style="color: #666; font-size: 0.8rem;">${relativeTime}</span>
                                </div>
                                
                                <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #555; flex-wrap: wrap;">
                                    <span>üíñ <strong>${Math.round(metrics.HR || 0)}</strong> bpm</span>
                                    <span>üåä <strong>${Math.round(metrics.RMSSD || 0)}</strong>ms</span>
                                    <span>üìä <strong>${Math.round(metrics.SDNN || 0)}</strong>ms</span>
                                    <span>‚öñÔ∏è <strong>${(metrics.LFHF || 0).toFixed(2)}</strong></span>
                                    <span>üíß <strong>${(metrics.PI || 0).toFixed(1)}</strong>%</span>
                                </div>
                                
                                <div style="font-size: 0.75rem; color: #888; margin-top: 4px; display: flex; gap: 10px; flex-wrap: wrap;">
                                    <span>Duration: ${entry.actual_duration ? entry.actual_duration.toFixed(1) : entry.session_duration || 30}s</span>
                                    <span>Source: ${sourceText}</span>
                                    ${entry.raw_data ? `<span style="color: #2196f3;">üìä ${entry.raw_data.ppg_signal_samples?.length || 0} samples</span>` : ''}
                                    ${entry.patterns ? `<span style="color: #9c27b0;">üîç Pattern data</span>` : ''}
                                </div>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                <div style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">
                                    ${statusText}
                                </div>
                                <button onclick="deletePPGEntry('${entry.id}', event)" 
                                        style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.7rem; cursor: pointer;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            timeline.innerHTML = timelineHTML;
        }
        
        // Select PPG entry for detailed view
        function selectPPGEntry(entryId, index) {
            console.log('üìä Selected PPG entry:', entryId);
            
            // Highlight selected entry
            document.querySelectorAll('.ppg-timeline-entry').forEach((el, i) => {
                if (i === index) {
                    el.style.border = '2px solid #E91E63';
                    el.style.background = 'rgba(233, 30, 99, 0.05)';
                } else {
                    el.style.border = '2px solid #e0e0e0';
                    el.style.background = 'white';
                }
            });
            
            // Load this measurement's data into charts and dashboard
            loadSpecificMeasurement(entryId);
        }
        
        // Load specific measurement data
        async function loadSpecificMeasurement(entryId) {
            try {
                let selectedData = null;
                
                // Try Firebase first
                if (window.firebaseDB && !entryId.startsWith('local_')) {
                    const docRef = window.firebaseDoc(window.firebaseDB, 'ppg_measurements', entryId);
                    const docSnap = await window.firebaseGetDoc(docRef);
                    if (docSnap.exists()) {
                        selectedData = docSnap.data();
                    }
                }
                
                // Try local storage
                if (!selectedData) {
                    const localData = JSON.parse(localStorage.getItem('pulseher_ppg_data') || '[]');
                    selectedData = localData.find(item => item.id === entryId);
                }
                
                if (selectedData && selectedData.metrics) {
                    console.log('üìà Loading selected measurement into charts and dashboard...');
                    
                    // Update dashboard cards
                    updateLiveDashboard(selectedData.metrics);
                    
                    // Plot to charts
                    plotMetricsToCharts(selectedData.metrics);
                    
                    // Show selection confirmation
                    const timestamp = new Date(selectedData.timestamp).toLocaleString();
                    updateStatus(`üìä Loaded measurement from ${timestamp}\nüíñ HR: ${Math.round(selectedData.metrics.HR || 0)} bpm`, 'info');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading specific measurement:', error);
            }
        }
        
        // Delete PPG entry
        async function deletePPGEntry(entryId, event) {
            event.stopPropagation(); // Prevent selection
            
            showConfirmation('üóëÔ∏è Delete this PPG measurement?\n\nThis action cannot be undone.', async (confirmed) => {
                if (!confirmed) {
                    return;
                }
                
                try {
                    console.log('üóëÔ∏è Deleting PPG entry:', entryId);
                    
                    // Delete from Firebase
                    if (window.firebaseDB && !entryId.startsWith('local_')) {
                        await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDB, 'ppg_measurements', entryId));
                        console.log('‚úÖ Deleted from Firebase');
                    }
                    
                    // Delete from local storage
                    const localData = JSON.parse(localStorage.getItem('pulseher_ppg_data') || '[]');
                    const filteredData = localData.filter(item => item.id !== entryId);
                    localStorage.setItem('pulseher_ppg_data', JSON.stringify(filteredData));
                    
                    console.log('‚úÖ PPG entry deleted successfully');
                    
                    // Refresh timeline
                    setTimeout(() => loadStoredPPGData(), 300);
                    
                } catch (error) {
                    console.error('‚ùå Error deleting PPG entry:', error);
                    updateStatus('‚ùå Error deleting measurement. Please try again.', 'error');
                }
            });
        }
        
        // Clear all PPG data
        async function clearAllPPGData() {
            if (!confirm('üóëÔ∏è Delete ALL PPG measurements?\n\nThis will permanently delete all your stored data. This action cannot be undone.')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Clearing all PPG data...');
                
                // Clear Firebase (batch delete)
                if (window.firebaseDB) {
                    const querySnapshot = await window.firebaseGetDocs(
                        window.firebaseCollection(window.firebaseDB, 'ppg_measurements')
                    );
                    
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(window.firebaseDeleteDoc(doc.ref));
                    });
                    
                    await Promise.all(deletePromises);
                    console.log(`‚úÖ Deleted ${deletePromises.length} entries from Firebase`);
                }
                
                // Clear local storage
                localStorage.removeItem('pulseher_ppg_data');
                console.log('‚úÖ Cleared local storage');
                
                // Refresh timeline
                loadStoredPPGData();
                
                updateStatus('‚úÖ All PPG measurements have been deleted.', 'success');
                
            } catch (error) {
                console.error('‚ùå Error clearing all data:', error);
                updateStatus('‚ùå Error clearing data. Please try again.', 'error');
            }
        }
        
        // Helper function for relative time display
        function getRelativeTimeString(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        // Helper function to update element text
        function updateElement(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                console.log(`‚úÖ Updated ${elementId} = ${value}`);
            } else {
                console.error(`‚ùå Element '${elementId}' not found!`);
            }
        }
        
        // Store PPG data for advanced analysis (called from PPG measurement functions)
        function storePPGDataForAnalysis(ppgData) {
            currentPPGData = [...ppgData]; // Copy the array
            console.log(`üìä Stored ${currentPPGData.length} PPG samples for advanced analysis`);
            
            // Enable advanced analysis button
            const analyzeBtn = document.getElementById('analyzeAdvanced');
            if (analyzeBtn) {
                analyzeBtn.disabled = false;
                analyzeBtn.style.opacity = '1';
            }
        }

        
        // Console message
        console.log('üíñ PulseHER v5.0 - PPG Optimized! Ready for real heart rate monitoring! ÔøΩ');
    </script>
</body>
</html>
